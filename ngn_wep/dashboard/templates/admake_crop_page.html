<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>STEP 2 - ADMAKE</title>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/favicon.ico') }}">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Fonts: Inter Tight (ì˜ë¬¸/ìˆ«ì) + Pretendard (í•œê¸€) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" rel="stylesheet">

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=1.4">

  <style>
    :root {
      --bg-primary: #0a0a0a;
      --bg-secondary: #111111;
      --bg-card: #161616;
      --bg-card-hover: #1a1a1a;
      --bg-input: #0d0d0d;
      --border-subtle: rgba(255, 255, 255, 0.06);
      --border-hover: rgba(255, 255, 255, 0.12);
      --border-focus: rgba(255, 255, 255, 0.2);
      --text-primary: #ffffff;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      --accent-blue: #3b82f6;
      --accent-emerald: #10b981;
      --accent-gold: #f59e0b;
      --accent-red: #ef4444;
      /* ë¹„ìœ¨ë³„ ì»¬ëŸ¬ */
      --ratio-916: #3b82f6;    /* ë”¥ë¸”ë£¨ */
      --ratio-45: #10b981;     /* ì—ë©”ë„ë“œ */
      --ratio-11: #f59e0b;     /* ì†Œí”„íŠ¸ ê³¨ë“œ */
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg-primary);
      font-family: 'Pretendard', 'Inter Tight', -apple-system, BlinkMacSystemFont, sans-serif;
      height: 100vh;
      overflow: hidden; /* í˜ì´ì§€ ìŠ¤í¬ë¡¤ ë°©ì§€ */
      color: var(--text-primary);
    }

    .font-inter {
      font-family: 'Inter Tight', sans-serif;
    }

    /* ===== ë„¤ë¹„ê²Œì´ì…˜ ì˜¤ë²„ë¼ì´ë“œ ===== */
    .nav-buttons {
      background: var(--bg-primary) !important;
      border-bottom: 1px solid var(--border-subtle) !important;
      height: 56px;
      flex-shrink: 0;
    }

    .nav-buttons .updated-at-text {
      color: var(--text-primary) !important;
      font-family: 'Inter Tight', sans-serif !important;
      font-weight: 700 !important;
      letter-spacing: 0.1em !important;
    }

    .hamburger-icon div {
      background: var(--text-primary) !important;
    }

    .hamburger-dropdown {
      background: var(--bg-secondary) !important;
      border: 1px solid var(--border-subtle) !important;
    }

    .hamburger-dropdown a {
      color: var(--text-secondary) !important;
    }

    .hamburger-dropdown a:hover {
      background: var(--bg-card) !important;
      color: var(--text-primary) !important;
    }

    /* ===== Progress Bar (Refined Minimal Style) ===== */
    .admake-progress-bar {
      position: sticky;
      top: 56px;
      z-index: 100;
      background: linear-gradient(180deg, #0A0A0B 0%, #09090B 100%);
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      padding: 28px 40px;
      flex-shrink: 0;
    }

    .admake-progress-steps {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0;
      max-width: 860px;
      margin: 0 auto;
    }

    .admake-progress-step {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 12px 16px;
      border-radius: 8px;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      background: transparent;
      min-width: 90px;
    }

    .admake-progress-step .step-icon {
      display: none;
      width: 18px;
      height: 18px;
    }

    .admake-progress-step .step-number {
      font-family: 'Inter Tight', sans-serif;
      font-size: 10px;
      font-weight: 700;
      color: #3F3F46;
      letter-spacing: 0.08em;
      transition: all 0.4s ease;
      text-transform: uppercase;
    }

    .admake-progress-step .step-label {
      font-family: 'Pretendard', sans-serif;
      font-size: 12px;
      font-weight: 500;
      color: #3F3F46;
      white-space: nowrap;
      transition: all 0.4s ease;
    }

    /* ===== Completed State ===== */
    .admake-progress-step.completed {
      background: rgba(16, 185, 129, 0.12);
      border: 1px solid rgba(16, 185, 129, 0.25);
    }

    .admake-progress-step.completed .step-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      color: #34D399;
    }

    .admake-progress-step.completed .step-icon i {
      width: 16px;
      height: 16px;
      stroke-width: 2.5;
    }

    .admake-progress-step.completed .step-number {
      display: none;
    }

    .admake-progress-step.completed .step-label {
      color: #6EE7B7;
      font-weight: 500;
    }

    /* ===== Active State ===== */
    .admake-progress-step.active {
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.1),
                  0 4px 16px rgba(0, 0, 0, 0.2);
    }

    .admake-progress-step.active .step-number {
      color: #18181B;
      font-weight: 800;
    }

    .admake-progress-step.active .step-label {
      color: #09090B;
      font-weight: 600;
    }

    /* ===== Pending State ===== */
    .admake-progress-step:not(.completed):not(.active) {
      background: transparent;
      border: 1px dashed #27272A;
    }

    .admake-progress-step:not(.completed):not(.active) .step-number {
      color: #52525B;
    }

    .admake-progress-step:not(.completed):not(.active) .step-label {
      color: #52525B;
    }

    /* ===== Connector Lines ===== */
    .admake-progress-connector {
      display: flex;
      align-items: center;
      padding: 0 6px;
      transition: all 0.4s ease;
    }

    .admake-progress-connector-line {
      width: 28px;
      height: 2px;
      background: #27272A;
      border-radius: 1px;
      transition: all 0.4s ease;
    }

    .admake-progress-connector.completed .admake-progress-connector-line {
      background: linear-gradient(90deg, #10B981 0%, #34D399 100%);
    }

    /* Hide old dot element */
    .admake-progress-connector-dot {
      display: none;
    }

    /* ===== ë©”ì¸ ë ˆì´ì•„ì›ƒ - ë·°í¬íŠ¸ ê³ ì • ===== */
    .admake-crop-wrapper {
      display: flex;
      padding-top: 65px; /* í”„ë¡œê·¸ë ˆìŠ¤ë°”ì™€ ê²¹ì¹¨ ë°©ì§€ */
      height: calc(100vh - 56px - 105px - 72px); /* nav + progress + action bar */
      overflow: hidden;
      box-sizing: border-box;
    }

    /* ===== ì¢Œì¸¡: ë¯¸ë””ì–´ ë¦¬ìŠ¤íŠ¸ ===== */
    .admake-crop-left {
      width: 200px;
      flex-shrink: 0;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-subtle);
      display: flex;
      flex-direction: column;
    }

    .admake-media-list {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: 16px;
    }

    .admake-media-list-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      flex-shrink: 0;
    }

    .admake-media-list-number {
      font-family: 'Inter Tight', sans-serif;
      font-size: 10px;
      font-weight: 800;
      color: var(--accent-blue);
      background: rgba(59, 130, 246, 0.08);
      border: 1px solid rgba(59, 130, 246, 0.15);
      padding: 4px 8px;
      border-radius: 4px;
      letter-spacing: 0.1em;
    }

    .admake-media-list-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .admake-media-list-container {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding-right: 4px;
    }

    /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ */
    .admake-media-list-container::-webkit-scrollbar {
      width: 4px;
    }

    .admake-media-list-container::-webkit-scrollbar-track {
      background: var(--bg-card);
      border-radius: 2px;
    }

    .admake-media-list-container::-webkit-scrollbar-thumb {
      background: var(--text-muted);
      border-radius: 2px;
    }

    .admake-media-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 6px;
      overflow: hidden;
      background: var(--bg-card);
      border: 2px solid var(--border-subtle);
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 10px;
    }

    .admake-media-item:hover {
      border-color: var(--border-hover);
    }

    .admake-media-item.selected {
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 1px var(--accent-blue);
    }

    .admake-media-item-image,
    .admake-media-item-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .admake-media-item-badge {
      position: absolute;
      top: 4px;
      left: 4px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Inter Tight', sans-serif;
      font-size: 9px;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .admake-media-item-checked {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 20px;
      height: 20px;
      background: var(--bg-primary);
      color: #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .admake-media-item.selected .admake-media-item-checked {
      opacity: 1;
      background: var(--accent-blue);
    }

    .admake-media-item-checked.confirmed {
      opacity: 1;
      background: var(--accent-emerald);
    }

    /* ===== ì¤‘ì•™: í¬ë¡­ ìº”ë²„ìŠ¤ ===== */
    .admake-crop-center {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      position: relative;
      background: var(--bg-primary);
    }

    .admake-canvas-wrapper {
      position: relative;
      display: flex;
      align-items: flex-start;
    }

    /* ë¹„ìœ¨ ë²„íŠ¼ - ê·¸ë¦¬ë“œ ì¢Œì¸¡ì— ë°€ì°© */
    .admake-ratio-buttons-vertical {
      position: absolute;
      left: -50px;
      top: 0;
      display: flex;
      flex-direction: column;
      gap: 0;
      z-index: 20;
    }

    .admake-ratio-btn-v {
      width: 44px;
      padding: 8px 4px;
      font-family: 'Inter Tight', sans-serif;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.02em;
      border: none;
      background: var(--bg-card);
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }

    .admake-ratio-btn-v:first-child {
      border-radius: 6px 0 0 0;
    }

    .admake-ratio-btn-v:last-child {
      border-radius: 0 0 0 6px;
    }

    .admake-ratio-btn-v:hover {
      background: var(--bg-card-hover);
      color: var(--text-secondary);
    }

    .admake-ratio-btn-v.active-916 {
      background: rgba(59, 130, 246, 0.15);
      color: var(--ratio-916);
      border-left-color: var(--ratio-916);
    }

    .admake-ratio-btn-v.active-45 {
      background: rgba(16, 185, 129, 0.15);
      color: var(--ratio-45);
      border-left-color: var(--ratio-45);
    }

    .admake-ratio-btn-v.active-11 {
      background: rgba(245, 158, 11, 0.15);
      color: var(--ratio-11);
      border-left-color: var(--ratio-11);
    }

    /* í¬ë¡­ ì»¨í…Œì´ë„ˆ - Sharp Edge */
    .admake-guide-container {
      position: relative;
      width: 320px;
      aspect-ratio: 9 / 16;
      background: #000;
      border: none;
      border-radius: 0; /* Sharp Edge */
      overflow: hidden;
      cursor: move;
      user-select: none;
      box-shadow: none; /* ê·¸ë¦¼ì ì œê±° */
    }

    .admake-guide-preview {
      width: 100%;
      height: 100%;
      position: relative;
      overflow: hidden;
    }

    .admake-crop-canvas {
      width: 100%;
      height: 100%;
      display: block;
      cursor: move;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
    }

    /* ê°€ì´ë“œ ë¼ì¸ - ë¹„ìœ¨ë³„ ì»¬ëŸ¬ */
    .admake-guide-line {
      position: absolute;
      pointer-events: none;
      z-index: 12;
      box-sizing: border-box;
    }

    .admake-guide-line-4-5 {
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      height: 70.31%;
      border: 2px solid var(--ratio-45);
    }

    .admake-guide-line-1-1 {
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      height: 56.25%;
      border: 2px solid var(--ratio-11);
    }

    .admake-guide-line-4-5.hidden,
    .admake-guide-line-1-1.hidden {
      display: none;
    }

    /* 9:16 ì™¸ê³½ì„  (ì„ íƒ ì‹œ) */
    .admake-guide-container.ratio-916 {
      outline: 2px solid var(--ratio-916);
      outline-offset: -2px;
    }

    .admake-guide-container.ratio-45 .admake-guide-line-4-5 {
      border-width: 3px;
      box-shadow: 0 0 8px rgba(16, 185, 129, 0.3);
    }

    .admake-guide-container.ratio-11 .admake-guide-line-1-1 {
      border-width: 3px;
      box-shadow: 0 0 8px rgba(245, 158, 11, 0.3);
    }

    .admake-video-notice {
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      z-index: 20;
      backdrop-filter: blur(8px);
    }

    /* ===== ìš°ì¸¡: ì»¨íŠ¸ë¡¤ íŒ¨ë„ ===== */
    .admake-crop-right {
      width: 280px;
      flex-shrink: 0;
      background: var(--bg-secondary);
      border-left: 1px solid var(--border-subtle);
      display: flex;
      flex-direction: column;
      padding: 24px 20px;
      overflow-y: auto;
    }

    .admake-control-section {
      margin-bottom: 28px;
    }

    .admake-control-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 14px;
    }

    .admake-control-number {
      font-family: 'Inter Tight', sans-serif;
      font-size: 10px;
      font-weight: 800;
      color: var(--accent-blue);
      background: rgba(59, 130, 246, 0.08);
      border: 1px solid rgba(59, 130, 246, 0.15);
      padding: 3px 7px;
      border-radius: 4px;
      letter-spacing: 0.1em;
    }

    .admake-control-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    /* ë¹„ìœ¨ ë²„íŠ¼ ê·¸ë£¹ */
    .admake-ratio-buttons {
      display: flex;
      gap: 8px;
    }

    .admake-ratio-btn {
      flex: 1;
      padding: 12px 8px;
      font-family: 'Inter Tight', sans-serif;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.02em;
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      background: var(--bg-card);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .admake-ratio-btn:hover {
      background: var(--bg-card-hover);
      border-color: var(--border-hover);
    }

    .admake-ratio-btn.active {
      background: var(--text-primary);
      color: var(--bg-primary);
      border-color: var(--text-primary);
    }

    /* ì¤Œ ì»¨íŠ¸ë¡¤ */
    .admake-zoom-control {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .admake-zoom-slider {
      flex: 1;
      height: 4px;
      background: var(--bg-card);
      border-radius: 2px;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .admake-zoom-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: var(--text-primary);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }

    .admake-zoom-value {
      font-family: 'Inter Tight', sans-serif;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      min-width: 48px;
      text-align: right;
    }

    /* í•´ìƒë„ í‘œì‹œ */
    .admake-resolution-display {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      padding: 14px;
      text-align: center;
    }

    .admake-resolution-label {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .admake-resolution-value {
      font-family: 'Inter Tight', sans-serif;
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .admake-resolution-status {
      font-size: 11px;
      margin-top: 6px;
      color: var(--accent-emerald);
    }

    .admake-resolution-status.warning {
      color: var(--accent-red);
    }

    /* í™•ì¸ ë²„íŠ¼ - ë°ì€ ë°°ê²½ + ì„ ëª…í•œ ê·¸ë¦¼ì */
    .admake-confirm-btn {
      width: 100%;
      padding: 14px;
      font-family: 'Inter Tight', sans-serif;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      background: #f5f5f5;
      color: #1a1a1a;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: auto;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    .admake-confirm-btn:hover:not(:disabled) {
      background: #ffffff;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5);
      transform: translateY(-1px);
    }

    .admake-confirm-btn:active {
      background: #e8e8e8;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      transform: translateY(0);
    }

    .admake-confirm-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
      box-shadow: none;
    }

    .admake-confirm-btn.confirmed {
      background: var(--accent-emerald);
      color: #ffffff;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .admake-confirm-btn.confirmed:hover:not(:disabled) {
      background: #059669;
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.5);
    }

    /* ===== í•˜ë‹¨ ì•¡ì…˜ ë°” ===== */
    .admake-action-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 72px;
      background: linear-gradient(180deg, rgba(17, 17, 17, 0.95) 0%, var(--bg-secondary) 100%);
      border-top: 1px solid var(--border-subtle);
      padding: 0 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(12px);
    }

    .admake-action-left {
      font-family: 'Inter Tight', sans-serif;
      font-size: 11px;
      color: var(--text-muted);
      letter-spacing: 0.06em;
      font-weight: 500;
    }

    .admake-action-buttons {
      display: flex;
      gap: 10px;
    }

    .admake-btn {
      font-family: 'Inter Tight', sans-serif;
      padding: 12px 28px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.02em;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.25s;
      text-transform: uppercase;
    }

    .admake-btn-secondary {
      background: var(--bg-card);
      color: var(--text-secondary);
      border: 1px solid var(--border-subtle);
    }

    .admake-btn-secondary:hover {
      background: var(--bg-card-hover);
      border-color: var(--border-hover);
      color: var(--text-primary);
    }

    .admake-btn-primary {
      background: var(--text-primary);
      color: var(--bg-primary);
      box-shadow: 0 2px 8px rgba(255, 255, 255, 0.1);
    }

    .admake-btn-primary:hover:not(:disabled) {
      background: #f0f0f0;
      box-shadow: 0 4px 16px rgba(255, 255, 255, 0.15);
    }

    .admake-btn-primary:disabled {
      opacity: 0.25;
      cursor: not-allowed;
      box-shadow: none;
    }

    /* ===== ì—…ë¡œë“œ í”„ë¡œê·¸ë ˆìŠ¤ ëª¨ë‹¬ (ê°œì„ ëœ ë²„ì „) ===== */
    .admake-loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(9, 9, 11, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(12px);
    }

    .admake-loading-overlay.active {
      display: flex;
    }

    .admake-loading-content {
      background: var(--bg-secondary);
      padding: 40px 48px;
      border-radius: 20px;
      text-align: center;
      border: 1px solid var(--border-default);
      width: 100%;
      max-width: 480px;
      box-shadow: 0 24px 48px rgba(0, 0, 0, 0.4);
    }

    /* ì›í˜• í”„ë¡œê·¸ë ˆìŠ¤ ì¸ë””ì¼€ì´í„° */
    .upload-progress-circle {
      position: relative;
      width: 120px;
      height: 120px;
      margin: 0 auto 24px;
    }

    .upload-progress-circle svg {
      transform: rotate(-90deg);
      width: 120px;
      height: 120px;
    }

    .upload-progress-circle .progress-bg {
      fill: none;
      stroke: var(--border-default);
      stroke-width: 8;
    }

    .upload-progress-circle .progress-fill {
      fill: none;
      stroke: url(#progressGradient);
      stroke-width: 8;
      stroke-linecap: round;
      stroke-dasharray: 339.292;
      stroke-dashoffset: 339.292;
      transition: stroke-dashoffset 0.5s ease;
    }

    .upload-progress-percent {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-family: 'Inter Tight', sans-serif;
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
    }

    /* í˜„ì¬ ìƒíƒœ ë©”ì‹œì§€ */
    .upload-stage-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .upload-stage-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 28px;
    }

    /* íŒŒì¼ë³„ ìƒíƒœ ì²´í¬ë¦¬ìŠ¤íŠ¸ */
    .upload-file-list {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 16px;
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 20px;
      text-align: left;
    }

    .upload-file-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-subtle);
    }

    .upload-file-item:last-child {
      border-bottom: none;
    }

    .upload-file-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .upload-file-icon.status-done {
      color: #10b981;
    }

    .upload-file-icon.status-progress {
      color: #3b82f6;
    }

    .upload-file-icon.status-progress::after {
      content: '';
      width: 16px;
      height: 16px;
      border: 2px solid #3b82f6;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .upload-file-icon.status-waiting {
      color: var(--text-muted);
    }

    .upload-file-icon.status-error {
      color: #ef4444;
    }

    .upload-file-name {
      flex: 1;
      font-size: 13px;
      color: var(--text-secondary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .upload-file-item.current .upload-file-name {
      color: var(--text-primary);
      font-weight: 500;
    }

    .upload-file-status {
      font-size: 11px;
      font-weight: 500;
      padding: 3px 8px;
      border-radius: 4px;
    }

    .upload-file-status.status-done {
      background: rgba(16, 185, 129, 0.15);
      color: #10b981;
    }

    .upload-file-status.status-progress {
      background: rgba(59, 130, 246, 0.15);
      color: #3b82f6;
    }

    .upload-file-status.status-waiting {
      background: rgba(82, 82, 91, 0.15);
      color: var(--text-muted);
    }

    /* ì˜ˆìƒ ì‹œê°„ ë° íŒ */
    .upload-eta {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .upload-tip {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.2);
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 12px;
      color: #fbbf24;
      text-align: left;
      line-height: 1.5;
    }

    .upload-tip-icon {
      flex-shrink: 0;
      font-size: 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .admake-loading-spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--bg-card);
      border-top: 3px solid var(--text-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    .admake-loading-text {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }

    /* ìˆ¨ê¹€ í´ë˜ìŠ¤ */
    .hidden {
      display: none !important;
    }

    /* ê°€ì´ë“œ ë¼ë²¨ - ì œê±°ë¨ (ë¹„ìœ¨ ë²„íŠ¼ìœ¼ë¡œ ëŒ€ì²´) */
    .admake-guide-labels-container,
    .admake-guide-labels-wrapper {
      display: none;
    }

    /* ===== ì»¤ìŠ¤í…€ í† ìŠ¤íŠ¸ ì•Œë¦¼ (ì„¸ë ¨ëœ ë””ìì¸) ===== */
    .admake-toast-container {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }

    .admake-toast {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      background: linear-gradient(135deg, rgba(45, 45, 50, 0.95) 0%, rgba(35, 35, 40, 0.98) 100%);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 12px;
      box-shadow:
        0 4px 6px rgba(0, 0, 0, 0.3),
        0 10px 30px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      pointer-events: auto;
      animation: toastSlideIn 0.35s cubic-bezier(0.21, 1.02, 0.73, 1);
      max-width: 420px;
      min-width: 280px;
    }

    .admake-toast.toast-out {
      animation: toastSlideOut 0.25s ease forwards;
    }

    @keyframes toastSlideIn {
      from { opacity: 0; transform: translateY(-20px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    @keyframes toastSlideOut {
      from { opacity: 1; transform: translateY(0) scale(1); }
      to { opacity: 0; transform: translateY(-10px) scale(0.95); }
    }

    .admake-toast-icon {
      font-size: 18px;
      flex-shrink: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      font-weight: 600;
    }

    .admake-toast-message {
      font-family: 'Pretendard', sans-serif;
      font-size: 13px;
      font-weight: 500;
      color: #ffffff;
      line-height: 1.5;
    }

    .admake-toast-close {
      background: rgba(255, 255, 255, 0.08);
      border: none;
      color: rgba(255, 255, 255, 0.5);
      cursor: pointer;
      padding: 6px;
      margin-left: auto;
      font-size: 14px;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .admake-toast-close:hover {
      background: rgba(255, 255, 255, 0.15);
      color: #ffffff;
    }

    /* Toast íƒ€ì…ë³„ ìŠ¤íƒ€ì¼ */
    .admake-toast.toast-info {
      border-left: 4px solid #3b82f6;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(35, 35, 45, 0.98) 30%);
    }
    .admake-toast.toast-info .admake-toast-icon {
      background: rgba(59, 130, 246, 0.2);
      color: #60a5fa;
    }

    .admake-toast.toast-success {
      border-left: 4px solid #10b981;
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(35, 35, 45, 0.98) 30%);
    }
    .admake-toast.toast-success .admake-toast-icon {
      background: rgba(16, 185, 129, 0.2);
      color: #34d399;
    }

    .admake-toast.toast-warning {
      border-left: 4px solid #f59e0b;
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(35, 35, 45, 0.98) 30%);
    }
    .admake-toast.toast-warning .admake-toast-icon {
      background: rgba(245, 158, 11, 0.2);
      color: #fbbf24;
    }

    .admake-toast.toast-error {
      border-left: 4px solid #ef4444;
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(35, 35, 45, 0.98) 30%);
    }
    .admake-toast.toast-error .admake-toast-icon {
      background: rgba(239, 68, 68, 0.2);
      color: #f87171;
    }
  </style>
</head>
<body>

<script>
  var userCompanyList = {{ session['company_names'] | tojson }};
  var currentUserId = "{{ session['user_id'] }}";
  var accountId = "{{ account_id }}";
</script>
<script src="{{ url_for('static', filename='js/mobile_detection.js') }}"></script>

<!-- ë„¤ë¹„ê²Œì´ì…˜ -->
<div class="nav-buttons">
  <div class="nav-left">
    <div id="updatedAtText" class="updated-at-text">ADMAKE</div>
  </div>
  <div class="nav-right">
    <div class="hamburger-menu-wrapper">
      <div class="hamburger-icon" id="hamburgerIcon">
        <div></div><div></div><div></div>
      </div>
      <div class="hamburger-dropdown" id="hamburgerDropdown">
        <a href="/">ì‚¬ì´íŠ¸ ì„±ê³¼</a>
        <a href="{{ url_for('ads_page') }}">ê´‘ê³  ì„±ê³¼</a>
        <a href="{{ url_for('trend_selection_page') }}">TREND</a>
        <a href="{{ url_for('auth.logout') }}">ë¡œê·¸ì•„ì›ƒ</a>
      </div>
    </div>
  </div>
</div>

<!-- Progress Bar (Refined Minimal Style) -->
<div class="admake-progress-bar">
  <div class="admake-progress-steps">
    <div class="admake-progress-step completed">
      <span class="step-icon"><i data-lucide="check"></i></span>
      <span class="step-number font-inter">STEP 1</span>
      <span class="step-label">ë¯¸ë””ì–´ ì—…ë¡œë“œ</span>
    </div>
    <div class="admake-progress-connector completed">
      <span class="admake-progress-connector-line"></span>
    </div>
    <div class="admake-progress-step active">
      <span class="step-number font-inter">STEP 2</span>
      <span class="step-label">ê°€ì´ë“œë¡œ ìë¥´ê¸°</span>
    </div>
    <div class="admake-progress-connector">
      <span class="admake-progress-connector-line"></span>
    </div>
    <div class="admake-progress-step">
      <span class="step-number font-inter">STEP 3</span>
      <span class="step-label">ê´‘ê³  ìƒì„±</span>
    </div>
    <div class="admake-progress-connector">
      <span class="admake-progress-connector-line"></span>
    </div>
    <div class="admake-progress-step">
      <span class="step-number font-inter">STEP 4</span>
      <span class="step-label">ì‚¬ì „ ì„¸íŒ…</span>
    </div>
    <div class="admake-progress-connector">
      <span class="admake-progress-connector-line"></span>
    </div>
    <div class="admake-progress-step">
      <span class="step-number font-inter">STEP 5</span>
      <span class="step-label">ê²€í†  ë° ìƒì„±</span>
    </div>
  </div>
</div>

<!-- ë©”ì¸ ì»¨í…ì¸  - 3ì—´ ë ˆì´ì•„ì›ƒ -->
<div class="admake-crop-wrapper">

  <!-- ì¢Œì¸¡: ë¯¸ë””ì–´ ë¦¬ìŠ¤íŠ¸ -->
  <div class="admake-crop-left">
    <div class="admake-media-list">
      <div class="admake-media-list-header">
        <span class="admake-media-list-number font-inter">01</span>
        <span class="admake-media-list-title">ë¯¸ë””ì–´ ëª©ë¡</span>
      </div>
      <div class="admake-media-list-container" id="mediaListContainer"></div>
    </div>
  </div>

  <!-- ì¤‘ì•™: í¬ë¡­ ìº”ë²„ìŠ¤ -->
  <div class="admake-crop-center">
    <div class="admake-canvas-wrapper">
      <!-- ë¹„ìœ¨ ë²„íŠ¼ - ê·¸ë¦¬ë“œ ì¢Œì¸¡ì— ë°€ì°© -->
      <div class="admake-ratio-buttons-vertical" id="ratioButtonsVertical">
        <button class="admake-ratio-btn-v active-916" id="ratioBtn916v" data-ratio="9/16">9:16</button>
        <button class="admake-ratio-btn-v" id="ratioBtn45v" data-ratio="4/5">4:5</button>
        <button class="admake-ratio-btn-v" id="ratioBtn11v" data-ratio="1/1">1:1</button>
      </div>

      <div class="admake-guide-container ratio-916" id="guideContainer">
        <div class="admake-guide-preview" id="guidePreview">
          <canvas class="admake-crop-canvas" id="cropCanvas" style="display: none;"></canvas>
          <!-- ê°€ì´ë“œë¼ì¸ (ë¹„ìœ¨ì— ë”°ë¼ í‘œì‹œ/ìˆ¨ê¹€) -->
          <div class="admake-guide-line admake-guide-line-4-5"></div>
          <div class="admake-guide-line admake-guide-line-1-1"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ìš°ì¸¡: ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
  <div class="admake-crop-right" id="cropControls">
    <!-- ì›ë³¸ ì‚¬ì´ì¦ˆ ì„ íƒ -->
    <div class="admake-control-section">
      <div class="admake-control-header">
        <span class="admake-control-number font-inter">01</span>
        <span class="admake-control-title">ì›ë³¸ ì‚¬ì´ì¦ˆ ì„ íƒ</span>
      </div>
      <div class="admake-ratio-buttons">
        <button class="admake-ratio-btn active" id="ratioBtn916" data-ratio="9/16">9:16</button>
        <button class="admake-ratio-btn" id="ratioBtn45" data-ratio="4/5">4:5</button>
        <button class="admake-ratio-btn" id="ratioBtn11" data-ratio="1/1">1:1</button>
      </div>
    </div>

    <!-- í™•ëŒ€ ì¶•ì†Œ -->
    <div class="admake-control-section">
      <div class="admake-control-header">
        <span class="admake-control-number font-inter">02</span>
        <span class="admake-control-title">í™•ëŒ€ ì¶•ì†Œ</span>
      </div>
      <div class="admake-zoom-control">
        <input type="range" id="zoomSlider" class="admake-zoom-slider" min="0.01" max="3" step="0.01" value="1">
        <span class="admake-zoom-value font-inter" id="zoomValue">100%</span>
      </div>
    </div>

    <!-- í•´ìƒë„ í‘œì‹œ -->
    <div class="admake-control-section">
      <div class="admake-resolution-display" id="resolutionDisplay">
        <div class="admake-resolution-label">ì¶œë ¥ í•´ìƒë„</div>
        <div class="admake-resolution-value font-inter" id="resolutionValue">-- x --</div>
        <div class="admake-resolution-status" id="resolutionStatus">âœ“ ë©”íƒ€ ê´‘ê³  ê¶Œì¥ ê·œê²©</div>
      </div>
      <div id="resolutionWarning" class="hidden" style="margin-top: 8px; padding: 12px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 8px; text-align: center;">
        <div style="font-size: 12px; color: var(--accent-red); font-weight: 600;">í•´ìƒë„ê°€ ë„ˆë¬´ ë‚®ìŠµë‹ˆë‹¤</div>
        <div style="font-size: 11px; color: var(--accent-red); margin-top: 4px; opacity: 0.8;">ìµœì†Œ 600px ì´ìƒ í•„ìš”</div>
      </div>
    </div>

    <!-- í”Œë«í¼ í˜¸í™˜ì„± ë°°ì§€ -->
    <div id="platformCompatBadge" class="hidden" style="padding: 12px; border-radius: 8px; text-align: center; margin-bottom: 16px;">
      <div id="platformCompatText" style="font-size: 12px; font-weight: 600;"></div>
      <div id="platformCompatDetail" style="font-size: 11px; margin-top: 4px;"></div>
    </div>

    <!-- í™•ì¸ ë²„íŠ¼ -->
    <button class="admake-confirm-btn" id="confirmBtn">
      CONFIRM
    </button>
  </div>
</div>

<!-- í•˜ë‹¨ ì•¡ì…˜ ë°” -->
<div class="admake-action-bar">
  <div class="admake-action-left font-inter">STEP 2 OF 5</div>
  <div class="admake-action-buttons">
    <button class="admake-btn admake-btn-secondary" id="backBtn">ì´ì „</button>
    <button class="admake-btn admake-btn-primary" id="uploadBtn" disabled>
      <span id="uploadBtnText">ë‹¤ìŒ ë‹¨ê³„ë¡œ</span>
      <span id="uploadBtnCount" style="display: none; margin-left: 8px; font-size: 11px; opacity: 0.8;"></span>
    </button>
  </div>
</div>

<!-- ì—…ë¡œë“œ í”„ë¡œê·¸ë ˆìŠ¤ ëª¨ë‹¬ -->
<div class="admake-loading-overlay" id="loadingOverlay">
  <div class="admake-loading-content">
    <!-- ì›í˜• í”„ë¡œê·¸ë ˆìŠ¤ ì¸ë””ì¼€ì´í„° -->
    <div class="upload-progress-circle">
      <svg viewBox="0 0 120 120">
        <defs>
          <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color:#10b981"/>
            <stop offset="100%" style="stop-color:#34d399"/>
          </linearGradient>
        </defs>
        <circle class="progress-bg" cx="60" cy="60" r="54"/>
        <circle class="progress-fill" id="progressCircle" cx="60" cy="60" r="54"/>
      </svg>
      <div class="upload-progress-percent" id="progressPercent">0%</div>
    </div>

    <!-- í˜„ì¬ ìƒíƒœ -->
    <div class="upload-stage-title" id="uploadStageTitle">ë©”íƒ€ ì„œë²„ì— ì—°ê²° ì¤‘...</div>
    <div class="upload-stage-subtitle" id="uploadStageSubtitle">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>

    <!-- íŒŒì¼ë³„ ìƒíƒœ ë¦¬ìŠ¤íŠ¸ -->
    <div class="upload-file-list" id="uploadFileList">
      <!-- ë™ì  ìƒì„± -->
    </div>

    <!-- ì˜ˆìƒ ì‹œê°„ -->
    <div class="upload-eta" id="uploadEta">
      <span style="font-size: 16px;">â±</span>
      <span>ì˜ˆìƒ ì†Œìš” ì‹œê°„ ê³„ì‚° ì¤‘...</span>
    </div>

    <!-- íŒ/ê²½ê³  -->
    <div class="upload-tip">
      <span class="upload-tip-icon">ğŸ’¡</span>
      <span>ì—…ë¡œë“œê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ì°½ì„ ë‹«ì§€ ë§ˆì„¸ìš”. ì˜ìƒ íŒŒì¼ì€ ìš©ëŸ‰ì— ë”°ë¼ 1~3ë¶„ ì •ë„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
    </div>
  </div>
</div>

<!-- placeholderText ì œê±°ë¨ -->

<!-- í† ìŠ¤íŠ¸ ì•Œë¦¼ ì»¨í…Œì´ë„ˆ -->
<div class="admake-toast-container" id="toastContainer"></div>

<script src="{{ url_for('static', filename='js/common.js') }}"></script>
<script src="{{ url_for('static', filename='js/common_ui.js') }}"></script>

<script>
// ===== ì»¤ìŠ¤í…€ í† ìŠ¤íŠ¸ ì•Œë¦¼ ì‹œìŠ¤í…œ =====
function showToast(message, type = 'info', duration = 3500) {
  const container = document.getElementById('toastContainer');
  if (!container) return;

  const toast = document.createElement('div');
  toast.className = `admake-toast toast-${type}`;

  const icons = {
    info: 'â„¹ï¸',
    success: 'âœ“',
    warning: 'âš ',
    error: 'âœ•'
  };

  toast.innerHTML = `
    <span class="admake-toast-icon">${icons[type] || icons.info}</span>
    <span class="admake-toast-message">${message}</span>
    <button class="admake-toast-close" onclick="this.parentElement.remove()">Ã—</button>
  `;

  container.appendChild(toast);

  // ìë™ ì œê±°
  setTimeout(() => {
    toast.classList.add('toast-out');
    setTimeout(() => toast.remove(), 300);
  }, duration);
}

// âœ… ìƒíƒœ ê´€ë¦¬ - ê°œì„ ëœ êµ¬ì¡°
let mediaItems = []; // [{ id, name, type, mediaType, previewUrl, cropState: { x, y, zoom }, isConfirmed }]
let selectedMediaIndex = -1;
let uploadedResults = []; // ì—…ë¡œë“œ ê²°ê³¼ { id, hash/video_id, type }
let videoAnimationFrame = null; // ë™ì˜ìƒ ì• ë‹ˆë©”ì´ì…˜ í”„ë ˆì„ ID
let isMediaLoading = false; // ë¯¸ë””ì–´ ë¡œë”© ì¤‘ í”Œë˜ê·¸ (ì—…ë¡œë“œ ë²„íŠ¼ ì°¨ë‹¨ìš©)

// âœ… Canvas ê´€ë ¨ ë³€ìˆ˜
let canvas, ctx;
let currentImage = null;
let isDragging = false;
let dragStartX = 0;
let dragStartY = 0;
let currentX = 0;
let currentY = 0;
let currentZoom = 1;
let containerWidth = 0;
let containerHeight = 0;
let currentAspectRatio = 9/16; // í˜„ì¬ ì„ íƒëœ ë¹„ìœ¨ (9:16, 4:5, 1:1) - ë””í´íŠ¸ 9:16
let minZoom = 1; // ìµœì†Œ í™•ëŒ€ ë°°ìœ¨ (ë™ì  ê³„ì‚°)

// âœ… [HD Export] ë©”íƒ€ ê´‘ê³  í•´ìƒë„ ìƒìˆ˜
const META_MIN_WIDTH = 600;        // ë©”íƒ€ ê´‘ê³  ìµœì†Œ ë„ˆë¹„
const META_RECOMMENDED_WIDTH = 1080; // ê¶Œì¥ ë„ˆë¹„
let currentCropPixelWidth = 0;     // í˜„ì¬ í¬ë¡­ ì˜ì—­ì˜ ì›ë³¸ í”½ì…€ ë„ˆë¹„
let currentCropPixelHeight = 0;    // í˜„ì¬ í¬ë¡­ ì˜ì—­ì˜ ì›ë³¸ í”½ì…€ ë†’ì´

// âœ… [Instagram Reels] ë¹„ìœ¨ ìƒìˆ˜ - ì •í™•í•œ ì†Œìˆ˜ì  ì •ë°€ë„
const RATIO_9_16 = 9 / 16;         // 0.5625 (ì¸ìŠ¤íƒ€ê·¸ë¨ ë¦´ìŠ¤ í•„ìˆ˜)
const RATIO_4_5 = 4 / 5;           // 0.8 (í˜ì´ìŠ¤ë¶ í”¼ë“œ ì „ìš©)
const RATIO_1_1 = 1;               // 1.0 (ì •ì‚¬ê°í˜•)
const RATIO_TOLERANCE = 0.0001;    // ë¹„ìœ¨ ë¹„êµ í—ˆìš© ì˜¤ì°¨

// âœ… IndexedDBì—ì„œ File ê°ì²´ ê°€ì ¸ì˜¤ê¸°
async function getFileFromIndexedDB(mediaId) {
  return new Promise((resolve, reject) => {
    if (!('indexedDB' in window)) {
      reject(new Error('IndexedDBë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤'));
      return;
    }

    const dbName = 'admake_files';
    const request = indexedDB.open(dbName, 1);

    request.onsuccess = (event) => {
      const db = event.target.result;
      const transaction = db.transaction(['files'], 'readonly');
      const store = transaction.objectStore('files');
      const getRequest = store.get(mediaId);

      getRequest.onsuccess = () => {
        if (getRequest.result && getRequest.result.file) {
          resolve(getRequest.result.file);
        } else {
          reject(new Error('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'));
        }
      };

      getRequest.onerror = () => reject(getRequest.error);
    };

    request.onerror = () => reject(request.error);
  });
}

// âœ… [ì „ë©´ ì¬ìˆ˜ì •] Blob URL ì¦‰ì‹œ ì¬ìƒì„± (ëª¨ë“  ê²€ì¦ ë¡œì§ íê¸°)
// í•µì‹¬: file ê°ì²´ê°€ ìˆìœ¼ë©´ ë¬´ì¡°ê±´ URL.createObjectURL() í˜¸ì¶œ
async function regenerateBlobUrl(item) {
  // 1. item.fileì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ìƒˆ URL ìƒì„±
  if (item.file) {
    const newUrl = URL.createObjectURL(item.file);
    console.log(`[REGEN] File ê°ì²´ë¡œ ìƒˆ Blob URL ìƒì„±: ${item.id}`);
    return newUrl;
  }

  // 2. fileì´ ì—†ìœ¼ë©´ IndexedDBì—ì„œ ê°€ì ¸ì™€ì„œ ìƒˆ URL ìƒì„±
  const file = await getFileFromIndexedDB(item.id);
  item.file = file; // file ê°ì²´ ì €ì¥
  const newUrl = URL.createObjectURL(file);
  console.log(`[REGEN] IndexedDBì—ì„œ ë³µêµ¬ í›„ ìƒˆ Blob URL ìƒì„±: ${item.id}`);
  return newUrl;
}

// âœ… STEP 2 ì´ˆê¸°í™” í•¨ìˆ˜ (ë°ì´í„° ë³µêµ¬ ê°•í™”)
async function initStep2() {
  // mediaItemsê°€ ë¹„ì–´ìˆìœ¼ë©´ IndexedDBì—ì„œ ë³µêµ¬
  if (mediaItems.length === 0) {
    console.log('[DEBUG] mediaItemsê°€ ë¹„ì–´ìˆìŒ - IndexedDBì—ì„œ ë³µêµ¬ ì‹œë„');
    await loadStep1Data();
  }
}

// âœ… [ì „ë©´ ì¬ìˆ˜ì •] STEP 1ì—ì„œ ì €ì¥ëœ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
// í•µì‹¬: IndexedDBì—ì„œ file ê°ì²´ë¥¼ ê°€ì ¸ì™€ì„œ ë¬´ì¡°ê±´ ìƒˆ Blob URL ìƒì„±
async function loadStep1Data() {
  const step1Data = sessionStorage.getItem('admake_step1_state');
  if (!step1Data) {
    showToast('STEP 1 ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì²˜ìŒë¶€í„° ì‹œì‘í•´ì£¼ì„¸ìš”.', 'warning');
    window.location.href = `/admake/create?account_id=${encodeURIComponent(accountId)}`;
    return;
  }

  try {
    const data = JSON.parse(step1Data);

    // ê° ë¯¸ë””ì–´ì— ëŒ€í•´ IndexedDBì—ì„œ File ê°ì²´ë¥¼ ê°€ì ¸ì™€ì„œ ìƒˆ Blob URL ìƒì„±
    const loadedItems = [];
    for (const item of data.mediaItems) {
      try {
        // IndexedDBì—ì„œ File ê°ì²´ ê°€ì ¸ì˜¤ê¸°
        const file = await getFileFromIndexedDB(item.id);
        // ë¬´ì¡°ê±´ ìƒˆ Blob URL ìƒì„± (ê²€ì¦ ì—†ì´)
        const previewUrl = URL.createObjectURL(file);
        console.log(`[LOAD] ${item.id}: ìƒˆ Blob URL ìƒì„± ì™„ë£Œ`);

        // ===== [Fix] mediaType í´ë°±: ì—†ê±°ë‚˜ ì˜ëª»ëœ ê²½ìš° file.typeìœ¼ë¡œ íŒë‹¨ =====
        const resolvedMediaType = item.mediaType || (file.type.startsWith('video/') ? 'video' : 'image');
        console.log(`[LOAD] ${item.id}: mediaType=${item.mediaType} â†’ resolved=${resolvedMediaType} (file.type=${file.type})`);

        loadedItems.push({
          id: item.id,
          name: item.name,
          size: item.size,
          type: item.type,
          mediaType: resolvedMediaType,
          previewUrl: previewUrl,
          file: file, // File ê°ì²´ ì €ì¥ (í•„ìˆ˜!)
          cropState: item.cropState || null, // nullì´ë©´ ì´ˆê¸° ìë™ ë§ì¶¤ ì ìš©
          isConfirmed: item.isConfirmed || false
        });
      } catch (e) {
        console.error(`[ERROR] ${item.id} ë¡œë“œ ì‹¤íŒ¨:`, e);
        showToast(`ë¯¸ë””ì–´ "${item.name}"ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'error');
        window.location.href = `/admake/create?account_id=${encodeURIComponent(accountId)}`;
        return;
      }
    }

    mediaItems = loadedItems;
    console.log(`[LOAD] ${mediaItems.length}ê°œ ë¯¸ë””ì–´ ë¡œë“œ ì™„ë£Œ`);

    // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    renderMediaList();

    // ì²« ë²ˆì§¸ ë¯¸ë””ì–´ ì¦‰ì‹œ ì„ íƒ (await í›„ ì‹¤í–‰ë˜ë¯€ë¡œ DOM ì¤€ë¹„ë¨)
    if (mediaItems.length > 0) {
      console.log('[LOAD] ì²« ë²ˆì§¸ ë¯¸ë””ì–´ ì¦‰ì‹œ ì„ íƒ');
      selectMedia(0);
    }
  } catch (e) {
    console.error('STEP 1 ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
    showToast('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    window.location.href = `/admake/create?account_id=${encodeURIComponent(accountId)}`;
  }
}

// âœ… ë¯¸ë””ì–´ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
function renderMediaList() {
  const container = document.getElementById('mediaListContainer');
  container.innerHTML = '';

  mediaItems.forEach((item, index) => {
    const mediaItem = document.createElement('div');
    mediaItem.className = `admake-media-item ${selectedMediaIndex === index ? 'selected' : ''}`;
    mediaItem.setAttribute('data-index', index);
    
    let mediaElement = '';
    if (item.mediaType === 'video') {
      mediaElement = `<video src="${item.previewUrl}" class="admake-media-item-video" muted playsinline loop></video>`;
    } else {
      mediaElement = `<img src="${item.previewUrl}" class="admake-media-item-image" alt="${item.name}">`;
    }

    const checkedIcon = item.isConfirmed ? 'âœ“' : '';
    const confirmedClass = item.isConfirmed ? 'confirmed' : '';
    
    mediaItem.innerHTML = `
      ${mediaElement}
      <div class="admake-media-item-badge">${item.mediaType === 'video' ? 'VIDEO' : 'IMAGE'}</div>
      <div class="admake-media-item-checked ${confirmedClass}">${checkedIcon}</div>
    `;

    mediaItem.addEventListener('click', () => {
      // [ì „ë©´ ì¬ìˆ˜ì •] ê²€ì¦ ì—†ì´ ì¦‰ì‹œ ì„ íƒ
      selectMedia(index);
    });

    container.appendChild(mediaItem);
  });
}

// âœ… Canvas ì´ˆê¸°í™”
function initCanvas() {
  canvas = document.getElementById('cropCanvas');
  if (!canvas) return;

  ctx = canvas.getContext('2d');
  updateCanvasSize();

  // ë¦¬ì‚¬ì´ì¦ˆ ì´ë²¤íŠ¸ ì²˜ë¦¬ (ë””ë°”ìš´ìŠ¤ ì ìš©)
  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      const prevContainerWidth = containerWidth;
      const prevContainerHeight = containerHeight;

      updateCanvasSize();

      if (currentImage && containerWidth > 0 && containerHeight > 0) {
        // ===== [í•µì‹¬] ë¦¬ì‚¬ì´ì¦ˆ ì‹œ minZoom ì¬ê³„ì‚° =====
        // ì»¨í…Œì´ë„ˆ í¬ê¸°ê°€ ë³€ê²½ë˜ì—ˆìœ¼ë©´ minZoomì„ ë‹¤ì‹œ ê³„ì‚°
        if (prevContainerWidth !== containerWidth || prevContainerHeight !== containerHeight) {
          const newMinZoom = calculateInitialZoom(currentImage, containerWidth, containerHeight, currentAspectRatio);
          console.log(`[RESIZE] minZoom ì¬ê³„ì‚°: ${minZoom.toFixed(6)} (ì»¨í…Œì´ë„ˆ: ${containerWidth.toFixed(0)}x${containerHeight.toFixed(0)})`);

          // í˜„ì¬ zoomì´ ìƒˆë¡œìš´ minZoomë³´ë‹¤ ì‘ìœ¼ë©´ ì¡°ì •
          if (currentZoom < minZoom) {
            currentZoom = minZoom;
            // ìŠ¬ë¼ì´ë” ì—…ë°ì´íŠ¸
            const zoomSlider = document.getElementById('zoomSlider');
            const zoomValue = document.getElementById('zoomValue');
            if (zoomSlider) {
              const maxZoom = Math.max(minZoom * 3, 1);
              zoomSlider.min = minZoom;
              zoomSlider.max = maxZoom;
              zoomSlider.value = currentZoom;
            }
            if (zoomValue) zoomValue.textContent = Math.round(currentZoom * 100) + '%';
          }
        }
        drawImage();
      }
    }, 100); // 100ms ë””ë°”ìš´ìŠ¤
  });
  
  // ë“œë˜ê·¸ ì´ë²¤íŠ¸
  canvas.addEventListener('mousedown', startDrag);
  canvas.addEventListener('mousemove', onDrag);
  canvas.addEventListener('mouseup', endDrag);
  canvas.addEventListener('mouseleave', endDrag);
  
  // í„°ì¹˜ ì´ë²¤íŠ¸ (ëª¨ë°”ì¼)
  canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    const touch = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    startDrag({
      clientX: touch.clientX,
      clientY: touch.clientY,
      target: canvas
    });
  });
  
  canvas.addEventListener('touchmove', (e) => {
    e.preventDefault();
    const touch = e.touches[0];
    onDrag({
      clientX: touch.clientX,
      clientY: touch.clientY
    });
  });
  
  canvas.addEventListener('touchend', endDrag);
}

// âœ… Canvas í¬ê¸° ì—…ë°ì´íŠ¸ (ë°˜ì‘í˜• ì»¨í…Œì´ë„ˆ ëŒ€ì‘)
function updateCanvasSize() {
  const container = document.getElementById('guideContainer');
  if (!container) return false;

  // getBoundingClientRect()ë¡œ ì‹¤ì œ ë Œë”ë§ëœ í¬ê¸° ê°€ì ¸ì˜¤ê¸° (clientWidthë³´ë‹¤ ì •í™•)
  const rect = container.getBoundingClientRect();
  containerWidth = rect.width;
  containerHeight = rect.height;

  // ì»¨í…Œì´ë„ˆ í¬ê¸°ê°€ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ false ë°˜í™˜
  if (containerWidth <= 0 || containerHeight <= 0) {
    console.warn(`[WARN] ì»¨í…Œì´ë„ˆ í¬ê¸° ë¬´íš¨: ${containerWidth}x${containerHeight}`);
    return false;
  }

  if (canvas) {
    canvas.width = containerWidth;
    canvas.height = containerHeight;
  }

  console.log(`[DEBUG] ì»¨í…Œì´ë„ˆ í¬ê¸° ì—…ë°ì´íŠ¸: ${containerWidth.toFixed(0)}x${containerHeight.toFixed(0)}`);
  return true;
}

// âœ… ë“œë˜ê·¸ ì‹œì‘
function startDrag(e) {
  if (!currentImage) return;
  isDragging = true;
  const rect = canvas.getBoundingClientRect();
  dragStartX = e.clientX - rect.left;
  dragStartY = e.clientY - rect.top;
  canvas.style.cursor = 'grabbing';
}

// âœ… ë“œë˜ê·¸ ì¤‘ (restrictPosition: true íš¨ê³¼ ì ìš©)
function onDrag(e) {
  if (!isDragging || !currentImage) return;
  
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  
  const deltaX = x - dragStartX;
  const deltaY = y - dragStartY;
  
  // ì„ì‹œë¡œ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
  let newX = currentX + deltaX;
  let newY = currentY + deltaY;
  
  // restrictPosition: true íš¨ê³¼ - ê²½ê³„ ì œí•œ ì ìš©
  const cropArea = getCropAreaSize(containerWidth, containerHeight, currentAspectRatio);
  const cropX = (containerWidth - cropArea.width) / 2;
  const cropY = (containerHeight - cropArea.height) / 2;
  
  const imageNaturalWidth = currentImage.naturalWidth || currentImage.width;
  const imageNaturalHeight = currentImage.naturalHeight || currentImage.height;
  const imgWidth = imageNaturalWidth * currentZoom;
  const imgHeight = imageNaturalHeight * currentZoom;
  
  // ìƒëŒ€ ì¢Œí‘œ ê³„ì‚°
  let relativeX = newX - cropX;
  let relativeY = newY - cropY;
  
  // ê²½ê³„ ì œí•œ (ì´ë¯¸ì§€ê°€ í”„ë ˆì„ ì•ˆìœ¼ë¡œ ë“¤ì–´ì˜¤ì§€ ëª»í•˜ê²Œ)
  const minRelativeX = Math.min(0, -(imgWidth - cropArea.width));
  const minRelativeY = Math.min(0, -(imgHeight - cropArea.height));
  
  // ì—„ê²©í•œ ê²½ê³„ ì ìš©
  relativeX = Math.max(minRelativeX, Math.min(0, relativeX));
  relativeY = Math.max(minRelativeY, Math.min(0, relativeY));
  
  // ì ˆëŒ€ ì¢Œí‘œë¡œ ë³€í™˜
  currentX = cropX + relativeX;
  currentY = cropY + relativeY;
  
  dragStartX = x;
  dragStartY = y;
  
  drawImage();
}

// âœ… ë“œë˜ê·¸ ì¢…ë£Œ (ìƒíƒœ ì €ì¥ + IndexedDB ë™ê¸°í™”)
function endDrag() {
  if (isDragging) {
    isDragging = false;
    canvas.style.cursor = 'move';
    saveCropState();

    // IndexedDB ìƒíƒœ ë™ê¸°í™” (ë“œë˜ê·¸ ì™„ë£Œ ì‹œì ì— ì €ì¥)
    syncCropStateToIndexedDB();
  }
}

// âœ… ì´ë¯¸ì§€/ë™ì˜ìƒ ê·¸ë¦¬ê¸° (restrictPosition: true íš¨ê³¼ - ì—¬ë°± ì›ì²œ ì°¨ë‹¨)
function drawImage() {
  if (!currentImage || !ctx) return;

  // ===== [í•µì‹¬] ì´ë¯¸ì§€/ë™ì˜ìƒ ì›ë³¸ í¬ê¸° ìº¡ì²˜ =====
  // ì´ë¯¸ì§€: naturalWidth/naturalHeight ì‚¬ìš©
  // ë™ì˜ìƒ: videoWidth/videoHeight ì‚¬ìš©
  let imageNaturalWidth, imageNaturalHeight;
  
  if (currentImage instanceof HTMLVideoElement) {
    // ë™ì˜ìƒì¸ ê²½ìš°
    imageNaturalWidth = currentImage.videoWidth || currentImage.width || 1920;
    imageNaturalHeight = currentImage.videoHeight || currentImage.height || 1080;
  } else {
    // ì´ë¯¸ì§€ì¸ ê²½ìš°
    imageNaturalWidth = currentImage.naturalWidth || currentImage.width;
    imageNaturalHeight = currentImage.naturalHeight || currentImage.height;
  }

  if (imageNaturalWidth <= 0 || imageNaturalHeight <= 0) {
    console.error('[ERROR] drawImage: ë¯¸ë””ì–´ ì›ë³¸ í¬ê¸° ë¬´íš¨');
    return;
  }

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // ì„ íƒëœ ë¹„ìœ¨ì— ë§ëŠ” í¬ë¡­ ì˜ì—­ ê³„ì‚°
  const cropArea = getCropAreaSize(containerWidth, containerHeight, currentAspectRatio);
  const cropX = (containerWidth - cropArea.width) / 2;
  const cropY = (containerHeight - cropArea.height) / 2;

  // ===== restrictPosition: true íš¨ê³¼ - ì¤Œ ê°•ì œ ë³´ì • =====
  // í˜„ì¬ ì¤Œì´ minZoomë³´ë‹¤ ì‘ìœ¼ë©´ ê°•ì œë¡œ minZoomìœ¼ë¡œ ì¡°ì • (ì—¬ë°± ì›ì²œ ì°¨ë‹¨)
  if (currentZoom < minZoom) {
    console.log(`[RESTRICT] ì¤Œ ê°•ì œ ë³´ì •: ${currentZoom.toFixed(6)} â†’ ${minZoom.toFixed(6)}`);
    currentZoom = minZoom;
    const zoomSlider = document.getElementById('zoomSlider');
    const zoomValue = document.getElementById('zoomValue');
    if (zoomSlider) zoomSlider.value = currentZoom;
    if (zoomValue) zoomValue.textContent = Math.round(currentZoom * 100) + '%';
  }

  const imgWidth = imageNaturalWidth * currentZoom;
  const imgHeight = imageNaturalHeight * currentZoom;

  // ===== restrictPosition: true íš¨ê³¼ - ì—„ê²©í•œ ê²½ê³„ ì œí•œ =====
  // ì´ë¯¸ì§€ ê²½ê³„ê°€ í”„ë ˆì„ ì•ˆìœ¼ë¡œ ë“¤ì–´ì˜¤ëŠ” ê²ƒì„ ì ˆëŒ€ í—ˆìš©í•˜ì§€ ì•ŠìŒ
  // 1. ì´ë¯¸ì§€ ì¢Œìƒë‹¨ì´ í”„ë ˆì„ ì¢Œìƒë‹¨ë³´ë‹¤ ìš°ì¸¡/í•˜ë‹¨ì— ìˆìœ¼ë©´ ì•ˆë¨ (ì¢Œì¸¡/ìƒë‹¨ ì—¬ë°± ë°©ì§€)
  // 2. ì´ë¯¸ì§€ ìš°í•˜ë‹¨ì´ í”„ë ˆì„ ìš°í•˜ë‹¨ë³´ë‹¤ ì¢Œì¸¡/ìƒë‹¨ì— ìˆìœ¼ë©´ ì•ˆë¨ (ìš°ì¸¡/í•˜ë‹¨ ì—¬ë°± ë°©ì§€)

  // currentX, currentYë¥¼ í¬ë¡­ ì˜ì—­ ê¸°ì¤€ìœ¼ë¡œ ì¡°ì •
  let relativeX = currentX - cropX;
  let relativeY = currentY - cropY;

  // ê²½ê³„ ê³„ì‚° (ì´ë¯¸ì§€ê°€ í”„ë ˆì„ë³´ë‹¤ í´ ë•Œë§Œ ì´ë™ ê°€ëŠ¥)
  // ì¢Œì¸¡/ìƒë‹¨ ê²½ê³„: relativeX/Y <= 0
  // ìš°ì¸¡/í•˜ë‹¨ ê²½ê³„: relativeX/Y >= -(imgWidth - cropArea.width)
  const minRelativeX = Math.min(0, -(imgWidth - cropArea.width));
  const minRelativeY = Math.min(0, -(imgHeight - cropArea.height));

  // ì—„ê²©í•œ ê²½ê³„ ì ìš© (clamp)
  const finalX = Math.max(minRelativeX, Math.min(0, relativeX));
  const finalY = Math.max(minRelativeY, Math.min(0, relativeY));

  // ì´ë¯¸ì§€ë¥¼ í¬ë¡­ ì˜ì—­ì— ë§ì¶° ê·¸ë¦¬ê¸° (clip ì‚¬ìš© - í”„ë ˆì„ ë°– ì˜ë¼ë‚´ê¸°)
  ctx.save();
  ctx.beginPath();
  ctx.rect(cropX, cropY, cropArea.width, cropArea.height);
  ctx.clip();

  // ì´ë¯¸ì§€ ë˜ëŠ” ë™ì˜ìƒì„ Canvasì— ê·¸ë¦¬ê¸°
  // drawImageëŠ” ì´ë¯¸ì§€ì™€ ë™ì˜ìƒ ëª¨ë‘ ì§€ì›
  ctx.drawImage(
    currentImage,
    cropX + finalX,
    cropY + finalY,
    imgWidth,
    imgHeight
  );
  
  // ë™ì˜ìƒì¸ ê²½ìš° í˜„ì¬ í”„ë ˆì„ì„ ê³„ì† ê·¸ë¦¬ê¸° (ì• ë‹ˆë©”ì´ì…˜)
  if (currentImage instanceof HTMLVideoElement && currentImage.readyState >= 2) {
    // ë™ì˜ìƒì´ ë¡œë“œë˜ì—ˆìœ¼ë©´ ë‹¤ìŒ í”„ë ˆì„ë„ ê·¸ë¦¬ê¸° ìœ„í•´ requestAnimationFrame ì‚¬ìš©
    if (!videoAnimationFrame) {
      videoAnimationFrame = requestAnimationFrame(() => {
        videoAnimationFrame = null;
        if (currentImage instanceof HTMLVideoElement) {
          drawImage();
        }
      });
    }
  }

  ctx.restore();

  // currentX, currentY ì—…ë°ì´íŠ¸ (ì ˆëŒ€ ì¢Œí‘œë¡œ ì €ì¥)
  currentX = cropX + finalX;
  currentY = cropY + finalY;
}

// âœ… í¬ë¡­ ìƒíƒœ ì €ì¥ (ë©”ëª¨ë¦¬ + sessionStorage)
function saveCropState() {
  if (selectedMediaIndex >= 0 && selectedMediaIndex < mediaItems.length) {
    const item = mediaItems[selectedMediaIndex];
    item.cropState = {
      x: currentX,
      y: currentY,
      zoom: currentZoom,
      aspectRatio: currentAspectRatio, // ë¹„ìœ¨ë„ ì €ì¥
      minZoom: minZoom // minZoomë„ ì €ì¥ (ë³µì› ì‹œ ë¹„êµìš©)
    };
    // ìƒíƒœ ì €ì¥ ì‹œ ìë™ìœ¼ë¡œ í™•ì¸ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ (ì‚¬ìš©ìê°€ ëª…ì‹œì ìœ¼ë¡œ í™•ì¸í•´ì•¼ í•¨)

    console.log(`[SAVE] í¬ë¡­ ìƒíƒœ ì €ì¥: zoom=${currentZoom.toFixed(4)}, minZoom=${minZoom.toFixed(4)}, ratio=${currentAspectRatio}`);

    // sessionStorageì—ë„ ìƒíƒœ ì €ì¥ (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ëŒ€ë¹„)
    const step1Data = sessionStorage.getItem('admake_step1_state');
    if (step1Data) {
      try {
        const data = JSON.parse(step1Data);
        const mediaItemIdx = data.mediaItems.findIndex(m => m.id === item.id);
        if (mediaItemIdx >= 0) {
          data.mediaItems[mediaItemIdx].cropState = item.cropState;
          data.mediaItems[mediaItemIdx].isConfirmed = item.isConfirmed;
          sessionStorage.setItem('admake_step1_state', JSON.stringify(data));
        }
      } catch (e) {
        console.warn('[SYNC] sessionStorage ë™ê¸°í™” ì‹¤íŒ¨:', e);
      }
    }
  }
}

// âœ… IndexedDB ìƒíƒœ ë™ê¸°í™” (ë¹„ë™ê¸° - ëŠê¹€ ë°©ì§€)
async function syncCropStateToIndexedDB() {
  if (!('indexedDB' in window) || mediaItems.length === 0) return;

  try {
    const dbName = 'admake_files';
    const request = indexedDB.open(dbName, 1);

    request.onsuccess = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains('files')) return;

      const transaction = db.transaction(['files'], 'readwrite');
      const store = transaction.objectStore('files');

      mediaItems.forEach(item => {
        if (item.file) {
          store.put({
            id: item.id,
            file: item.file,
            previewUrl: item.previewUrl,
            type: item.type,
            mediaType: item.mediaType,
            cropState: item.cropState,
            isConfirmed: item.isConfirmed
          });
        }
      });

      transaction.oncomplete = () => {
        console.log('[SYNC] IndexedDB ìƒíƒœ ë™ê¸°í™” ì™„ë£Œ');
      };
    };

    request.onerror = (e) => {
      console.warn('[SYNC] IndexedDB ì—´ê¸° ì‹¤íŒ¨:', e);
    };
  } catch (e) {
    console.warn('[SYNC] IndexedDB ë™ê¸°í™” ì˜¤ë¥˜:', e);
  }
}

// âœ… ì„ íƒëœ ë¹„ìœ¨ì— ë§ëŠ” í¬ë¡­ ì˜ì—­ í¬ê¸° ê³„ì‚°
function getCropAreaSize(containerWidth, containerHeight, aspectRatio) {
  let cropWidth, cropHeight;
  
  if (aspectRatio === 9/16) {
    // 9:16 - ì „ì²´ ì»¨í…Œì´ë„ˆ ì‚¬ìš©
    cropWidth = containerWidth;
    cropHeight = containerHeight;
  } else if (aspectRatio === 4/5) {
    // 4:5 - ì»¨í…Œì´ë„ˆ ë„ˆë¹„ì— ë§ì¶¤
    cropWidth = containerWidth;
    cropHeight = containerWidth / (4/5);
    if (cropHeight > containerHeight) {
      cropHeight = containerHeight;
      cropWidth = containerHeight * (4/5);
    }
  } else if (aspectRatio === 1/1) {
    // 1:1 - ì •ì‚¬ê°í˜•
    const size = Math.min(containerWidth, containerHeight);
    cropWidth = size;
    cropHeight = size;
  } else {
    cropWidth = containerWidth;
    cropHeight = containerHeight;
  }
  
  return { width: cropWidth, height: cropHeight };
}

// âœ… ê³ í™”ì§ˆ ì´ë¯¸ì§€/ë™ì˜ìƒ ëŒ€ì‘: Cover Fit ìµœì†Œ ë°°ìœ¨ ê³„ì‚° (ì—¬ë°± ì—†ì´ í”„ë ˆì„ ê½‰ ì±„ì›€)
function calculateInitialZoom(img, containerWidth, containerHeight, aspectRatio) {
  // ===== [í•µì‹¬] ì´ë¯¸ì§€/ë™ì˜ìƒ ì›ë³¸ í¬ê¸° ëª…ì‹œì  ì‚¬ìš© =====
  // Image ê°ì²´: naturalWidth/naturalHeight ì‚¬ìš©
  // Video ê°ì²´: videoWidth/videoHeight ì‚¬ìš©
  let imageNaturalWidth, imageNaturalHeight;
  
  if (img instanceof HTMLVideoElement) {
    // ë™ì˜ìƒì¸ ê²½ìš°
    imageNaturalWidth = img.videoWidth || img.width || 1920;
    imageNaturalHeight = img.videoHeight || img.height || 1080;
  } else {
    // ì´ë¯¸ì§€ì¸ ê²½ìš°
    imageNaturalWidth = img.naturalWidth || img.width;
    imageNaturalHeight = img.naturalHeight || img.height;
  }

  // ì´ë¯¸ì§€ í¬ê¸°ê°€ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ê°’ ë°˜í™˜
  if (imageNaturalWidth <= 0 || imageNaturalHeight <= 0) {
    console.error(`[ERROR] ì´ë¯¸ì§€ ì›ë³¸ í¬ê¸° ë¬´íš¨: ${imageNaturalWidth}x${imageNaturalHeight}`);
    minZoom = 1;
    return 1;
  }

  const cropArea = getCropAreaSize(containerWidth, containerHeight, aspectRatio);

  // í¬ë¡­ ì˜ì—­ í¬ê¸°ê°€ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ê°’ ë°˜í™˜
  if (cropArea.width <= 0 || cropArea.height <= 0) {
    console.error(`[ERROR] í¬ë¡­ ì˜ì—­ í¬ê¸° ë¬´íš¨: ${cropArea.width}x${cropArea.height}`);
    minZoom = 1;
    return 1;
  }

  // ===== Cover Fit ê³„ì‚° (í•µì‹¬ ë¡œì§) =====
  // ì´ë¯¸ì§€ í•´ìƒë„ì— ê´€ê³„ì—†ì´ í”„ë ˆì„ì„ ì—¬ë°± ì—†ì´ ê½‰ ì±„ìš°ëŠ” ìµœì†Œ ë°°ìœ¨
  // ê³µì‹: minZoom = Math.max(frameWidth / imageWidth, frameHeight / imageHeight)
  const coverZoom = Math.max(
    cropArea.width / imageNaturalWidth,
    cropArea.height / imageNaturalHeight
  );

  // ìµœì†Œ í™•ëŒ€ ë¹„ìœ¨ = Cover Fit ë°°ìœ¨ (ì—¬ë°± ì›ì²œ ì°¨ë‹¨)
  // ì´ ê°’ ì´í•˜ë¡œëŠ” ì ˆëŒ€ ì¶•ì†Œ ë¶ˆê°€ëŠ¥ (restrictPosition: true íš¨ê³¼)
  // ê³ í™”ì§ˆ ì´ë¯¸ì§€ì˜ ê²½ìš° minZoomì´ ë§¤ìš° ì‘ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ìµœì†Œ 0.001 ë³´ì¥
  minZoom = Math.max(0.001, coverZoom);

  console.log(`[MASTER FIX] Cover Fit ê³„ì‚°: ì›ë³¸(${imageNaturalWidth}x${imageNaturalHeight}), í”„ë ˆì„(${cropArea.width.toFixed(0)}x${cropArea.height.toFixed(0)}), minZoom=${minZoom.toFixed(6)}`);

  // minZoom ê°’ì„ ë°˜í™˜ (ì´ˆê¸° ë°°ìœ¨ë¡œ ì‚¬ìš©)
  return minZoom;
}

// âœ… í¬ë¡­ ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸° (ì´ˆê¸° í™”ë©´ ìµœì í™”: 9:16 ë””í´íŠ¸, ì—¬ë°± ì—†ì´)
function loadCropState(item, img = null) {
  // ë””í´íŠ¸ ë¹„ìœ¨ì„ 9:16ìœ¼ë¡œ ì„¤ì • (ì´ˆê¸° í™”ë©´ ìµœì í™”)
  if (!item.cropState || !item.cropState.aspectRatio) {
    currentAspectRatio = 9/16;
  } else {
    // ì €ì¥ëœ ë¹„ìœ¨ ë³µì›
    currentAspectRatio = item.cropState.aspectRatio;
  }

  // ===== [í•µì‹¬] ì´ë¯¸ì§€/ë™ì˜ìƒ ì›ë³¸ í¬ê¸° ìº¡ì²˜ =====
  let imageNaturalWidth, imageNaturalHeight;
  
  if (img instanceof HTMLVideoElement) {
    // ë™ì˜ìƒì¸ ê²½ìš°
    imageNaturalWidth = img.videoWidth || img.width || 1920;
    imageNaturalHeight = img.videoHeight || img.height || 1080;
  } else if (img) {
    // ì´ë¯¸ì§€ì¸ ê²½ìš°
    imageNaturalWidth = img.naturalWidth || img.width || 0;
    imageNaturalHeight = img.naturalHeight || img.height || 0;
  } else {
    imageNaturalWidth = 0;
    imageNaturalHeight = 0;
  }

  // ===== [í•µì‹¬] ì´ë¯¸ì§€/ë™ì˜ìƒì´ ìˆìœ¼ë©´ ë¬´ì¡°ê±´ minZoom ë¨¼ì € ê³„ì‚° =====
  // ì´ë ‡ê²Œ í•´ì•¼ ì €ì¥ëœ ìƒíƒœ ë³µì› ì‹œì—ë„ ì˜¬ë°”ë¥¸ minZoomì´ ì ìš©ë¨
  if (img && containerWidth > 0 && containerHeight > 0 && imageNaturalWidth > 0 && imageNaturalHeight > 0) {
    // Cover Fit ìµœì†Œ ë°°ìœ¨ ê³„ì‚° (ì—¬ë°± ì›ì²œ ì°¨ë‹¨)
    calculateInitialZoom(img, containerWidth, containerHeight, currentAspectRatio);
    console.log(`[MASTER FIX] minZoom ê³„ì‚° ì™„ë£Œ: ${minZoom.toFixed(6)} (ì›ë³¸: ${imageNaturalWidth}x${imageNaturalHeight})`);
  }

  if (item && item.cropState && item.cropState.zoom > 0) {
    // ì €ì¥ëœ í¬ë¡­ ìƒíƒœê°€ ìˆìœ¼ë©´ ì‚¬ìš©
    currentX = item.cropState.x;
    currentY = item.cropState.y;
    currentZoom = item.cropState.zoom;

    // ===== [í•µì‹¬] ì €ì¥ëœ zoomì´ minZoomë³´ë‹¤ ì‘ìœ¼ë©´ ê°•ì œë¡œ minZoomìœ¼ë¡œ ì¡°ì • =====
    // ê³ í™”ì§ˆ ì´ë¯¸ì§€ì˜ ê²½ìš° ì´ì „ì— ì €ì¥ëœ zoom ê°’ì´ í˜„ì¬ ê³„ì‚°ëœ minZoomë³´ë‹¤ ì‘ì„ ìˆ˜ ìˆìŒ
    if (img && currentZoom < minZoom) {
      console.log(`[MASTER FIX] ì €ì¥ëœ zoom(${currentZoom.toFixed(6)})ì´ minZoom(${minZoom.toFixed(6)})ë³´ë‹¤ ì‘ìŒ â†’ minZoomìœ¼ë¡œ ê°•ì œ ì¡°ì •`);
      currentZoom = minZoom;

      // ìœ„ì¹˜ë„ ì¤‘ì•™ìœ¼ë¡œ ì¬ì¡°ì •
      const cropArea = getCropAreaSize(containerWidth, containerHeight, currentAspectRatio);
      const cropX = (containerWidth - cropArea.width) / 2;
      const cropY = (containerHeight - cropArea.height) / 2;
      const imgWidth = imageNaturalWidth * currentZoom;
      const imgHeight = imageNaturalHeight * currentZoom;
      currentX = cropX + (cropArea.width - imgWidth) / 2;
      currentY = cropY + (cropArea.height - imgHeight) / 2;
    }

    // ë¹„ìœ¨ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    updateRatioButtons();
  } else {
    // ì´ˆê¸° ìƒíƒœ - ì´ë¯¸ì§€ê°€ ì„ íƒëœ ë¹„ìœ¨ ë°•ìŠ¤ì— ì—¬ë°± ì—†ì´ ê½‰ ì°¨ê²Œ ìë™ ê³„ì‚°
    if (img && containerWidth > 0 && containerHeight > 0 && imageNaturalWidth > 0 && imageNaturalHeight > 0) {
      // í¬ë¡­ ì˜ì—­ ê³„ì‚°
      const cropArea = getCropAreaSize(containerWidth, containerHeight, currentAspectRatio);
      const cropX = (containerWidth - cropArea.width) / 2;
      const cropY = (containerHeight - cropArea.height) / 2;

      // ===== [í•µì‹¬] ì´ˆê¸° ë°°ìœ¨ = Cover Fit ë°°ìœ¨ (minZoom)ìœ¼ë¡œ ê°•ì œ ì„¤ì • =====
      // img.onloadì—ì„œ ì´ë¯¸ ê³„ì‚°í–ˆì§€ë§Œ, loadCropStateì—ì„œë„ ë³´ì¥
      if (minZoom <= 0 || !isFinite(minZoom)) {
        // minZoomì´ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ì¬ê³„ì‚°
        const calculatedMinZoom = Math.max(
          cropArea.width / imageNaturalWidth,
          cropArea.height / imageNaturalHeight
        );
        minZoom = Math.max(0.001, calculatedMinZoom);
      }
      currentZoom = minZoom;

      // ì´ë¯¸ì§€ë¥¼ í¬ë¡­ ì˜ì—­ ì¤‘ì•™ì— ë°°ì¹˜
      const imgWidth = imageNaturalWidth * currentZoom;
      const imgHeight = imageNaturalHeight * currentZoom;
      currentX = cropX + (cropArea.width - imgWidth) / 2;
      currentY = cropY + (cropArea.height - imgHeight) / 2;

      console.log(`[MASTER FIX] ì´ˆê¸° ë°°ìœ¨ ìë™ ì„¤ì •: ${currentZoom.toFixed(6)} (Cover Fit, ì›ë³¸ ${imageNaturalWidth}x${imageNaturalHeight})`);
    } else {
      currentX = 0;
      currentY = 0;
      currentZoom = 1;
      console.warn(`[WARN] ì´ˆê¸°í™” í´ë°±: ì»¨í…Œì´ë„ˆ(${containerWidth}x${containerHeight}), ì´ë¯¸ì§€(${imageNaturalWidth}x${imageNaturalHeight})`);
    }
  }

  // UI ì—…ë°ì´íŠ¸ (ìŠ¬ë¼ì´ë” ë²”ìœ„ ë™ì  ì„¤ì •: min=minZoom, max=minZoom*3)
  const zoomSlider = document.getElementById('zoomSlider');
  const zoomValue = document.getElementById('zoomValue');
  if (zoomSlider) {
    if (img && containerWidth > 0 && containerHeight > 0 && minZoom > 0) {
      // ===== ìŠ¬ë¼ì´ë” ë²”ìœ„ ë™ì  ì„¤ì • =====
      // min: Cover Fit ë°°ìœ¨ (ì´ ì´í•˜ë¡œ ì¶•ì†Œ ë¶ˆê°€ - ì—¬ë°± ì›ì²œ ì°¨ë‹¨)
      // max: minZoom * 3 (ê³ í™”ì§ˆ ì´ë¯¸ì§€ì—ì„œë„ ë¶€ë“œëŸ¬ìš´ í™•ëŒ€/ì¶•ì†Œ)
      const maxZoom = Math.max(minZoom * 3, 1); // ìµœì†Œ 1 ë³´ì¥
      zoomSlider.min = minZoom;
      zoomSlider.max = maxZoom;
      zoomSlider.step = Math.max((maxZoom - minZoom) / 100, 0.0001); // 100ë‹¨ê³„ë¡œ ë¶„í• , ìµœì†Œ 0.0001

      console.log(`[MASTER FIX] ìŠ¬ë¼ì´ë” ë²”ìœ„ ì„¤ì •: min=${minZoom.toFixed(6)}, max=${maxZoom.toFixed(4)}, step=${zoomSlider.step}`);
    }
    zoomSlider.value = currentZoom;
  }
  if (zoomValue) zoomValue.textContent = Math.round(currentZoom * 100) + '%';

  // ë¹„ìœ¨ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
  updateRatioButtons();
}

// âœ… ë¹„ìœ¨ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateRatioButtons() {
  const buttons = document.querySelectorAll('.admake-ratio-btn');
  const isVideo = isCurrentMediaVideo();

  buttons.forEach(btn => {
    const ratioStr = btn.getAttribute('data-ratio');
    const ratioValue = eval(ratioStr); // "9/16" -> 0.5625, "4/5" -> 0.8, "1/1" -> 1

    // í™œì„± ìƒíƒœ ì—…ë°ì´íŠ¸
    if (Math.abs(currentAspectRatio - ratioValue) < RATIO_TOLERANCE) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }

    // âœ… [UX ê°œì„ ] ë™ì˜ìƒë„ ëª¨ë“  ë²„íŠ¼ í™œì„±í™” - ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ ì œê±°
    btn.classList.remove('disabled-for-video');
    btn.style.opacity = '1';
    btn.style.cursor = 'pointer';

    // íˆ´íŒì€ ë™ì˜ìƒì¼ ë•Œ ë…¸ì¶œ ìœ„ì¹˜ ì•ˆë‚´ë¡œ ë³€ê²½
    if (isVideo) {
      if (Math.abs(ratioValue - RATIO_9_16) < RATIO_TOLERANCE) {
        btn.title = '9:16 - ë¦´ìŠ¤/ìŠ¤í† ë¦¬/í”¼ë“œ ëª¨ë‘ ê²Œì¬ ê°€ëŠ¥';
      } else if (Math.abs(ratioValue - RATIO_4_5) < RATIO_TOLERANCE) {
        btn.title = '4:5 - í”¼ë“œ ì „ìš© (ë¦´ìŠ¤/ìŠ¤í† ë¦¬ ë¶ˆê°€)';
      } else {
        btn.title = '1:1 - í”¼ë“œ ì „ìš© (ë¦´ìŠ¤/ìŠ¤í† ë¦¬ ë¶ˆê°€)';
      }
    } else {
      btn.title = ratioStr === '9/16' ? '9:16 ë¹„ìœ¨ë¡œ ìë¥´ê¸°' :
                  ratioStr === '4/5' ? '4:5 ë¹„ìœ¨ë¡œ ìë¥´ê¸°' :
                  '1:1 ë¹„ìœ¨ë¡œ ìë¥´ê¸°';
    }
  });

  // âœ… í”Œë«í¼ í˜¸í™˜ì„± ë°°ì§€ ì—…ë°ì´íŠ¸
  updateInstagramCompatibilityBadge();
}

// âœ… [UX ê°œì„ ] í”Œë«í¼ í˜¸í™˜ì„± ë°°ì§€ ì—…ë°ì´íŠ¸ - ìŠ¤ë§ˆíŠ¸ ì•Œë¦¼ ë°©ì‹
function updateInstagramCompatibilityBadge() {
  const badge = document.getElementById('platformCompatBadge');
  const textEl = document.getElementById('platformCompatText');
  const detailEl = document.getElementById('platformCompatDetail');

  if (!badge || !textEl || !detailEl) return;

  const isVideo = isCurrentMediaVideo();

  // ë¹„ìœ¨ íŒì •
  const is916 = Math.abs(currentAspectRatio - RATIO_9_16) < RATIO_TOLERANCE;
  const is45 = Math.abs(currentAspectRatio - RATIO_4_5) < RATIO_TOLERANCE;
  const is11 = Math.abs(currentAspectRatio - RATIO_1_1) < RATIO_TOLERANCE;

  // hidden í´ë˜ìŠ¤ ì œê±°í•˜ì—¬ í‘œì‹œ
  badge.classList.remove('hidden');

  if (is916) {
    // 9:16 - ëª¨ë“  í”Œë«í¼ í˜¸í™˜
    badge.style.background = 'rgba(16, 185, 129, 0.1)';
    badge.style.border = '1px solid rgba(16, 185, 129, 0.3)';
    textEl.innerHTML = 'âœ… REELS + STORY + FEED';
    textEl.style.color = '#10b981';
    detailEl.innerHTML = '9:16 (1080Ã—1920)';
    detailEl.style.color = '#059669';
  } else if (is45) {
    // 4:5 - í”¼ë“œ ì „ìš©
    badge.style.background = 'rgba(59, 130, 246, 0.1)';
    badge.style.border = '1px solid rgba(59, 130, 246, 0.3)';
    textEl.innerHTML = 'ğŸ“± FEED ONLY';
    textEl.style.color = '#3b82f6';
    detailEl.innerHTML = '4:5 (1080Ã—1350)';
    detailEl.style.color = '#2563eb';
  } else if (is11) {
    // 1:1 - í”¼ë“œ ì „ìš©
    badge.style.background = 'rgba(245, 158, 11, 0.1)';
    badge.style.border = '1px solid rgba(245, 158, 11, 0.3)';
    textEl.innerHTML = 'ğŸ“± FEED ONLY';
    textEl.style.color = '#f59e0b';
    detailEl.innerHTML = '1:1 (1080Ã—1080)';
    detailEl.style.color = '#d97706';
  } else {
    badge.classList.add('hidden');
  }

  // ë™ì˜ìƒì¼ ë•Œ ì¶”ê°€ ì•ˆë‚´
  if (isVideo && !is916) {
    badge.style.background = 'rgba(245, 158, 11, 0.1)';
    badge.style.border = '1px solid rgba(245, 158, 11, 0.3)';
    textEl.innerHTML = 'ğŸ“¹ VIDEO: FEED ONLY';
    textEl.style.color = '#f59e0b';
    detailEl.innerHTML = is45 ? '4:5 - Feed Placement' :
                         is11 ? '1:1 - Feed Placement' :
                         'Feed Placement';
    detailEl.style.color = '#d97706';
  }
}

// âœ… ê°€ì´ë“œë¼ì¸ í‘œì‹œ/ìˆ¨ê¹€ ì—…ë°ì´íŠ¸
function updateGuideLines() {
  const guide45 = document.querySelector('.admake-guide-line-4-5');
  const guide11 = document.querySelector('.admake-guide-line-1-1');
  
  if (guide45 && guide11) {
    // ì„ íƒëœ ë¹„ìœ¨ì— ë”°ë¼ ê°€ì´ë“œë¼ì¸ í‘œì‹œ
    if (currentAspectRatio === 4/5) {
      guide45.classList.remove('hidden');
      guide11.classList.add('hidden');
    } else if (currentAspectRatio === 1/1) {
      guide45.classList.add('hidden');
      guide11.classList.remove('hidden');
    } else {
      // 9:16ì¼ ë•ŒëŠ” ë‘˜ ë‹¤ í‘œì‹œ
      guide45.classList.remove('hidden');
      guide11.classList.remove('hidden');
    }
  }
}

// âœ… ë¹„ìœ¨ ë³€ê²½ ì²˜ë¦¬ (ì‹¤ì œ ìë¥´ê¸° ì—°ë™)
function changeAspectRatio(ratio) {
  // âœ… [UX ê°œì„ ] ë™ì˜ìƒë„ ëª¨ë“  ë¹„ìœ¨ í—ˆìš© - ê°•ì œ ë³€í™˜ ì œê±°
  // ë°°ì§€ë¡œ ë…¸ì¶œ ìœ„ì¹˜ ì•ˆë‚´ë§Œ ì œê³µ
  if (isCurrentMediaVideo() && Math.abs(ratio - RATIO_9_16) > RATIO_TOLERANCE) {
    console.log(`[FEED ONLY] ë™ì˜ìƒ í”¼ë“œ ì „ìš© ë¹„ìœ¨ ì ìš©: ${ratio}`);
  }

  currentAspectRatio = ratio;
  updateRatioButtons();
  updateGuideLines(); // ê°€ì´ë“œë¼ì¸ ì—…ë°ì´íŠ¸

  console.log(`[DEBUG] ë¹„ìœ¨ ë³€ê²½: ${ratio} (${ratio === 9/16 ? '9:16' : ratio === 4/5 ? '4:5' : '1:1'})`);

  if (currentImage && containerWidth > 0 && containerHeight > 0) {
    // ===== [í•µì‹¬] ì´ë¯¸ì§€/ë™ì˜ìƒ ì›ë³¸ í¬ê¸° ëª…ì‹œì  ì‚¬ìš© =====
    let imageNaturalWidth, imageNaturalHeight;
    
    if (currentImage instanceof HTMLVideoElement) {
      imageNaturalWidth = currentImage.videoWidth || currentImage.width || 1920;
      imageNaturalHeight = currentImage.videoHeight || currentImage.height || 1080;
    } else {
      imageNaturalWidth = currentImage.naturalWidth || currentImage.width;
      imageNaturalHeight = currentImage.naturalHeight || currentImage.height;
    }

    if (imageNaturalWidth <= 0 || imageNaturalHeight <= 0) {
      console.error('[ERROR] changeAspectRatio: ë¯¸ë””ì–´ ì›ë³¸ í¬ê¸° ë¬´íš¨');
      return;
    }

    // ìƒˆë¡œìš´ ë¹„ìœ¨ì— ë§ëŠ” í¬ë¡­ ì˜ì—­ ê³„ì‚°
    const cropArea = getCropAreaSize(containerWidth, containerHeight, currentAspectRatio);
    const cropX = (containerWidth - cropArea.width) / 2;
    const cropY = (containerHeight - cropArea.height) / 2;

    // ìƒˆë¡œìš´ ë¹„ìœ¨ì— ë§ê²Œ ìµœì†Œ ë°°ìœ¨ ì¬ê³„ì‚°
    calculateInitialZoom(currentImage, containerWidth, containerHeight, currentAspectRatio);

    // í˜„ì¬ ë°°ìœ¨ì´ ìµœì†Œê°’ë³´ë‹¤ ì‘ìœ¼ë©´ ìµœì†Œê°’ìœ¼ë¡œ ì¡°ì •
    if (currentZoom < minZoom) {
      currentZoom = minZoom;
    }

    // ì´ë¯¸ì§€ ìœ„ì¹˜ë¥¼ ìƒˆë¡œìš´ í¬ë¡­ ì˜ì—­ ì¤‘ì•™ìœ¼ë¡œ ì¡°ì •
    const imgWidth = imageNaturalWidth * currentZoom;
    const imgHeight = imageNaturalHeight * currentZoom;

    // ì´ë¯¸ì§€ë¥¼ í¬ë¡­ ì˜ì—­ ì¤‘ì•™ì— ë°°ì¹˜
    currentX = cropX + (cropArea.width - imgWidth) / 2;
    currentY = cropY + (cropArea.height - imgHeight) / 2;

    // ìŠ¬ë¼ì´ë” ì—…ë°ì´íŠ¸ (ë™ì  ë²”ìœ„: min=minZoom, max=minZoom*3)
    const zoomSlider = document.getElementById('zoomSlider');
    const zoomValue = document.getElementById('zoomValue');
    if (zoomSlider) {
      const maxZoom = Math.max(minZoom * 3, 1);
      zoomSlider.min = minZoom;
      zoomSlider.max = maxZoom;
      zoomSlider.step = Math.max((maxZoom - minZoom) / 100, 0.0001);
      zoomSlider.value = currentZoom;
    }
    if (zoomValue) zoomValue.textContent = Math.round(currentZoom * 100) + '%';

    // ì´ë¯¸ì§€ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    drawImage();

    // í¬ë¡­ ìƒíƒœ ì €ì¥
    saveCropState();

    // IndexedDB ìƒíƒœ ë™ê¸°í™”
    syncCropStateToIndexedDB();

    // âœ… [HD Export] ì‹¤ì‹œê°„ í•´ìƒë„ í‘œì‹œ ì—…ë°ì´íŠ¸
    const cropPixels = calculateCropPixelSize(currentAspectRatio, currentZoom);
    updateResolutionDisplay(cropPixels.width, cropPixels.height);
  }
}

// âœ… ë¯¸ë””ì–´ í™•ì¸ ì²˜ë¦¬ (í† ê¸€ ê¸°ëŠ¥ - í™•ì¸/ìˆ˜ì •í•˜ê¸°)
function confirmMedia() {
  if (selectedMediaIndex >= 0 && selectedMediaIndex < mediaItems.length) {
    const item = mediaItems[selectedMediaIndex];

    // í† ê¸€: í™•ì¸ â†’ ìˆ˜ì • ë˜ëŠ” ìˆ˜ì • â†’ í™•ì¸
    item.isConfirmed = !item.isConfirmed;
    saveCropState(); // í˜„ì¬ í¬ë¡­ ìƒíƒœ ì €ì¥

    // í™•ì¸ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ (í† ê¸€ ê¸°ëŠ¥)
    const confirmBtn = document.getElementById('confirmBtn');
    if (confirmBtn) {
      if (item.isConfirmed) {
        // í™•ì¸ë¨ â†’ "EDIT" ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
        confirmBtn.textContent = 'EDIT';
        confirmBtn.classList.add('confirmed');
        confirmBtn.style.background = '';
        console.log(`[CONFIRM] ë¯¸ë””ì–´ ${item.id} í™•ì¸ ì™„ë£Œ`);
      } else {
        // ìˆ˜ì • ëª¨ë“œ â†’ "CONFIRM" ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
        confirmBtn.textContent = 'CONFIRM';
        confirmBtn.classList.remove('confirmed');
        confirmBtn.style.background = '';
        console.log(`[CONFIRM] ë¯¸ë””ì–´ ${item.id} ìˆ˜ì • ëª¨ë“œ`);
      }
    }

    renderMediaList();
    updateUploadButtonState();

    // IndexedDB ìƒíƒœ ë™ê¸°í™” (ìƒíƒœ ìœ ì§€ ê°•í™”)
    syncCropStateToIndexedDB();
  }
}

// âœ… ë¯¸ë””ì–´ ì„ íƒ (ë¯¸ë””ì–´ ë³€ê²½ ì‹œ ì´ˆê¸°í™” ë¡œì§ í¬í•¨)
async function selectMedia(index) {
  selectedMediaIndex = index;
  isMediaLoading = true; // ë¯¸ë””ì–´ ë¡œë”© ì‹œì‘
  const item = mediaItems[index];
  
  // ===== [í•µì‹¬] ë¯¸ë””ì–´ ë³€ê²½ ì‹œ ë¹„ìœ¨ ì´ˆê¸°í™” =====
  // ===== [í•µì‹¬] ë¯¸ë””ì–´ ë³€ê²½ ì‹œ ë¹„ìœ¨ ì´ˆê¸°í™” =====
  // âœ… [UX ê°œì„ ] ë™ì˜ìƒë„ ì €ì¥ëœ ë¹„ìœ¨ ë³µì› (ê°•ì œ 9:16 ì œê±°)
  if (!item.cropState || !item.cropState.aspectRatio) {
    currentAspectRatio = RATIO_9_16; // ê¸°ë³¸ê°’ì€ 9:16
    console.log(`[RATIO] ê¸°ë³¸ ë¹„ìœ¨ ì ìš©: 9:16`);
  } else {
    currentAspectRatio = item.cropState.aspectRatio;
    console.log(`[RATIO] ì €ì¥ëœ ë¹„ìœ¨ ë³µì›: ${item.cropState.aspectRatio}`);
  }
  
  // ê°€ì´ë“œ í”„ë¦¬ë·° ì—…ë°ì´íŠ¸
  const preview = document.getElementById('guidePreview');
  const placeholder = document.getElementById('placeholderText');
  const cropControls = document.getElementById('cropControls');
  
  // ê¸°ì¡´ ë¯¸ë””ì–´ ì œê±°
  let existingMedia = preview.querySelector('.admake-guide-preview-image, .admake-guide-preview-video');
  if (existingMedia) existingMedia.remove();
  
  // Canvas ì´ˆê¸°í™”
  if (canvas) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
  
  if (item.mediaType === 'video') {
    // ===== [ìˆ˜ì •] ë™ì˜ìƒ í¬ë¡­ ë° ë°°ìœ¨ ì¡°ì ˆ ì „ë©´ í—ˆìš© =====
    // ë™ì˜ìƒë„ ì´ë¯¸ì§€ì™€ ë˜‘ê°™ì´ ë°°ìœ¨ ì¡°ì ˆ ë¡œì§ ì ìš©
    cropControls.style.display = 'block'; // í¬ë¡­ ì»¨íŠ¸ë¡¤ í•­ìƒ í‘œì‹œ
    canvas.style.display = 'block'; // Canvas í•­ìƒ í‘œì‹œ
    
    // í™•ì¸ ë²„íŠ¼ í‘œì‹œ
    const confirmBtn = document.getElementById('confirmBtn');
    if (confirmBtn) {
      confirmBtn.style.display = 'block';
      confirmBtn.style.background = '';
      confirmBtn.disabled = false;
      if (item.isConfirmed) {
        confirmBtn.textContent = 'EDIT';
        confirmBtn.classList.add('confirmed');
      } else {
        confirmBtn.textContent = 'CONFIRM';
        confirmBtn.classList.remove('confirmed');
      }
    }
    
    // ===== [ì „ë©´ ì¬ìˆ˜ì •] ëª¨ë“  ê²€ì¦ ë¡œì§ ì‚­ì œ, ë™ì˜ìƒë„ ì´ë¯¸ì§€ì™€ ë™ì¼ ì²˜ë¦¬ =====
    // ë™ì˜ìƒë„ ì´ë¯¸ì§€ì²˜ëŸ¼ Canvasì— ê·¸ë¦¬ê¸° ìœ„í•´ videoElement ìƒì„±
    const videoElement = document.createElement('video');
    videoElement.crossOrigin = 'anonymous';
    videoElement.src = item.previewUrl;
    videoElement.muted = true;
    videoElement.playsInline = true;
    videoElement.loop = true;
    videoElement.autoplay = true;
    
    // ë™ì˜ìƒ ë¡œë“œ ì‹¤íŒ¨ ì‹œ file ê°ì²´ë¡œ ì¦‰ì‹œ ì¬ìƒì„±
    videoElement.onerror = async () => {
      console.warn(`[VIDEO ERROR] ë™ì˜ìƒ ë¡œë“œ ì‹¤íŒ¨, ì¦‰ì‹œ ì¬ìƒì„±: ${item.id}`);
      if (item.file) {
        item.previewUrl = URL.createObjectURL(item.file);
        videoElement.src = item.previewUrl;
      }
    };
    
    // ===== [Final Fix] ë™ì˜ìƒ ì¬ìƒ ì¤€ë¹„ ì™„ë£Œ ì‹œ Canvasì— ê·¸ë¦¬ê¸° =====
    // onloadedmetadata ëŒ€ì‹  oncanplay ì‚¬ìš© (ì‹¤ì œ í”„ë ˆì„ ê·¸ë¦¬ê¸° ê°€ëŠ¥ ì‹œì )
    videoElement.oncanplay = () => {
      currentImage = videoElement; // videoElementë¥¼ currentImageë¡œ ì‚¬ìš©

      // ë™ì˜ìƒ ì¬ìƒ ì‹œì‘ (Canvasì— í”„ë ˆì„ì„ ê·¸ë¦¬ë ¤ë©´ ì¬ìƒ ì¤‘ì´ì–´ì•¼ í•¨)
      videoElement.play().catch(e => {
        console.warn('[VIDEO] ìë™ ì¬ìƒ ì‹¤íŒ¨ (ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í•„ìš”í•  ìˆ˜ ìˆìŒ):', e);
      });

      // ì»¨í…Œì´ë„ˆ ì¤€ë¹„ ëŒ€ê¸° + ì¦‰ì‹œ ê°•ì œ ì ìš©
      const applyVideoInitialFit = () => {
        // ì»¨í…Œì´ë„ˆ í¬ê¸° ì—…ë°ì´íŠ¸
        const containerReady = updateCanvasSize();

        if (!containerReady) {
          console.warn('[WAIT VIDEO] ì»¨í…Œì´ë„ˆ ì¤€ë¹„ ëŒ€ê¸° ì¤‘...');
          requestAnimationFrame(applyVideoInitialFit);
          return;
        }

        // ë™ì˜ìƒ ì›ë³¸ í¬ê¸°
        const videoWidth = videoElement.videoWidth || 1920;
        const videoHeight = videoElement.videoHeight || 1080;

        console.log(`[VIDEO CANPLAY] ì›ë³¸ í¬ê¸°: ${videoWidth}x${videoHeight}, ì»¨í…Œì´ë„ˆ: ${containerWidth.toFixed(0)}x${containerHeight.toFixed(0)}`);

        if (videoWidth > 0 && videoHeight > 0 && containerWidth > 0 && containerHeight > 0) {
          // 1. 9:16 ë¹„ìœ¨ë¡œ ê°•ì œ ì„¤ì • (ì´ˆê¸° ë¡œë”© ì‹œ)
          if (!item.cropState || !item.cropState.aspectRatio) {
            currentAspectRatio = 9/16;
            updateRatioButtons();
            updateGuideLines();
          }

          // 2. 9:16 ì»¨í…Œì´ë„ˆì— ë¹ˆí‹ˆì—†ì´ ê½‰ ì°¨ëŠ” ìµœì†Œ ë°°ìœ¨ ê³„ì‚°
          const cropArea = getCropAreaSize(containerWidth, containerHeight, currentAspectRatio);
          const calculatedMinZoom = Math.max(
            cropArea.width / videoWidth,
            cropArea.height / videoHeight
          );

          // minZoom ê°’ ì—…ë°ì´íŠ¸
          minZoom = Math.max(0.001, calculatedMinZoom);

          console.log(`[AUTO-FIT VIDEO] ê³„ì‚°ëœ minZoom: ${minZoom.toFixed(6)} (ì›ë³¸: ${videoWidth}x${videoHeight}, í”„ë ˆì„: ${cropArea.width.toFixed(0)}x${cropArea.height.toFixed(0)})`);

          // 3. ì´ˆê¸° ìƒíƒœì´ê±°ë‚˜ ì €ì¥ëœ ìƒíƒœê°€ ì—†ìœ¼ë©´ minZoomìœ¼ë¡œ ê°•ì œ ì ìš© ë° ì¢Œí‘œ ë¦¬ì…‹
          if (!item.cropState || !item.cropState.zoom || item.cropState.zoom < minZoom) {
            currentZoom = minZoom;
            console.log(`[AUTO-FIT VIDEO] ì´ˆê¸° zoomì„ minZoom(${minZoom.toFixed(6)})ìœ¼ë¡œ ì¦‰ì‹œ ê°•ì œ ì„¤ì •`);

            // ì¢Œí‘œë¥¼ ì¤‘ì•™ì— ê½‰ ì°¨ê²Œ ë°°ì¹˜
            const cropX = (containerWidth - cropArea.width) / 2;
            const cropY = (containerHeight - cropArea.height) / 2;
            const vidWidth = videoWidth * currentZoom;
            const vidHeight = videoHeight * currentZoom;

            // ë™ì˜ìƒì„ í¬ë¡­ ì˜ì—­ ì¤‘ì•™ì— ë°°ì¹˜
            currentX = cropX + (cropArea.width - vidWidth) / 2;
            currentY = cropY + (cropArea.height - vidHeight) / 2;

            console.log(`[AUTO-FIT VIDEO] ì¢Œí‘œ ë¦¬ì…‹: x=${currentX.toFixed(0)}, y=${currentY.toFixed(0)} (ì¤‘ì•™ ë°°ì¹˜)`);
          }
        }

        // í¬ë¡­ ìƒíƒœ ë¡œë“œ ë° ìŠ¬ë¼ì´ë” ì—…ë°ì´íŠ¸
        loadCropState(item, videoElement);
        updateRatioButtons();
        updateGuideLines();

        // ìŠ¬ë¼ì´ë” ë²”ìœ„ ì—…ë°ì´íŠ¸
        const zoomSlider = document.getElementById('zoomSlider');
        const zoomValue = document.getElementById('zoomValue');
        if (zoomSlider && minZoom > 0) {
          const maxZoom = Math.max(minZoom * 3, 1);
          zoomSlider.min = minZoom;
          zoomSlider.max = maxZoom;
          zoomSlider.step = Math.max((maxZoom - minZoom) / 100, 0.0001);
          zoomSlider.value = currentZoom;
        }
        if (zoomValue) zoomValue.textContent = Math.round(currentZoom * 100) + '%';

        // ë™ì˜ìƒ ê·¸ë¦¬ê¸° - ì¦‰ì‹œ ì‹¤í–‰
        console.log(`[VIDEO DRAW] ë™ì˜ìƒ Canvas ê·¸ë¦¬ê¸° ì‹œì‘`);
        drawImage();
        isMediaLoading = false; // ë™ì˜ìƒ ë¡œë”© ì™„ë£Œ
        console.log('[VIDEO] ë¯¸ë””ì–´ ë¡œë”© ì™„ë£Œ');

        // âœ… [HD Export] ì‹¤ì‹œê°„ í•´ìƒë„ í‘œì‹œ ì—…ë°ì´íŠ¸
        const cropPixels = calculateCropPixelSize(currentAspectRatio, currentZoom);
        updateResolutionDisplay(cropPixels.width, cropPixels.height);
      };

      // ì¦‰ì‹œ ì‹¤í–‰ ì‹œë„
      applyVideoInitialFit();
    };

    // ë™ì˜ìƒ ë¡œë“œ ì‹œì‘
    videoElement.load();
  } else {
    // ===== [ì•ˆì „ì¥ì¹˜] íƒ€ì… ì¬ê²€ì¦ - file.typeìœ¼ë¡œ video ì—¬ë¶€ í™•ì¸ =====
    const isActuallyVideo = item.file && item.file.type.startsWith('video/');
    if (isActuallyVideo) {
      console.warn(`[TYPE MISMATCH] mediaType=${item.mediaType}ì´ì§€ë§Œ file.type=${item.file.type}. ë™ì˜ìƒ ë¶„ê¸°ë¡œ ê°•ì œ ì´ë™.`);
      item.mediaType = 'video';
      selectMedia(index); // ì¬í˜¸ì¶œí•˜ì—¬ ì˜¬ë°”ë¥¸ ë¶„ê¸°ë¡œ ì§„ì…
      return;
    }

    // ì´ë¯¸ì§€ëŠ” í¬ë¡­ ê°€ëŠ¥
    cropControls.style.display = 'block';
    
    // Canvas í‘œì‹œ
    canvas.style.display = 'block';
    
    // í™•ì¸ ë²„íŠ¼ í‘œì‹œ ë° ìƒíƒœ ì—…ë°ì´íŠ¸
    const confirmBtn = document.getElementById('confirmBtn');
    if (confirmBtn) {
      confirmBtn.style.display = 'block';
      confirmBtn.style.background = '';
      confirmBtn.disabled = false;
      if (item.isConfirmed) {
        confirmBtn.textContent = 'EDIT';
        confirmBtn.classList.add('confirmed');
      } else {
        confirmBtn.textContent = 'CONFIRM';
        confirmBtn.classList.remove('confirmed');
      }
    }
    
    // ì´ë¯¸ì§€ ë¡œë“œ (Blob URL ìœ íš¨ì„± ê²€ì‚¬ í¬í•¨)
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => {
      currentImage = img;

      // ===== [ìˆ˜ì •] ì»¨í…Œì´ë„ˆ ì¤€ë¹„ ëŒ€ê¸° + ì¦‰ì‹œ ê°•ì œ ì ìš© =====
      const applyInitialFit = () => {
        // ì»¨í…Œì´ë„ˆ í¬ê¸° ì—…ë°ì´íŠ¸
        const containerReady = updateCanvasSize();

        if (!containerReady) {
          // ì»¨í…Œì´ë„ˆê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ë‹¤ìŒ í”„ë ˆì„ì—ì„œ ì¬ì‹œë„
          console.warn('[WAIT] ì»¨í…Œì´ë„ˆ ì¤€ë¹„ ëŒ€ê¸° ì¤‘...');
          requestAnimationFrame(applyInitialFit);
          return;
        }

        // naturalWidth/naturalHeight ë¡œê¹…
        console.log(`[IMAGE LOADED] ì›ë³¸ í¬ê¸°: ${img.naturalWidth}x${img.naturalHeight}, ì»¨í…Œì´ë„ˆ: ${containerWidth.toFixed(0)}x${containerHeight.toFixed(0)}`);

        // ===== [í•µì‹¬] ì´ˆê¸° ë¡œë”© ì‹œ ìë™ ë§ì¶¤ ì¦‰ì‹œ ê°•ì œ ì ìš© =====
        const imageNaturalWidth = img.naturalWidth || img.width;
        const imageNaturalHeight = img.naturalHeight || img.height;

        if (imageNaturalWidth > 0 && imageNaturalHeight > 0 && containerWidth > 0 && containerHeight > 0) {
          // 1. 9:16 ë¹„ìœ¨ë¡œ ê°•ì œ ì„¤ì • (ì´ˆê¸° ë¡œë”© ì‹œ)
          if (!item.cropState || !item.cropState.aspectRatio) {
            currentAspectRatio = 9/16;
            updateRatioButtons();
            updateGuideLines();
          }

          // 2. 9:16 ì»¨í…Œì´ë„ˆì— ë¹ˆí‹ˆì—†ì´ ê½‰ ì°¨ëŠ” ìµœì†Œ ë°°ìœ¨ ê³„ì‚°
          const cropArea = getCropAreaSize(containerWidth, containerHeight, currentAspectRatio);
          const calculatedMinZoom = Math.max(
            cropArea.width / imageNaturalWidth,
            cropArea.height / imageNaturalHeight
          );

          // minZoom ê°’ ì—…ë°ì´íŠ¸
          minZoom = Math.max(0.001, calculatedMinZoom);

          console.log(`[AUTO-FIT] ê³„ì‚°ëœ minZoom: ${minZoom.toFixed(6)} (ì›ë³¸: ${imageNaturalWidth}x${imageNaturalHeight}, í”„ë ˆì„: ${cropArea.width.toFixed(0)}x${cropArea.height.toFixed(0)})`);

          // 3. ì´ˆê¸° ìƒíƒœì´ê±°ë‚˜ ì €ì¥ëœ ìƒíƒœê°€ ì—†ìœ¼ë©´ minZoomìœ¼ë¡œ ê°•ì œ ì ìš© ë° ì¢Œí‘œ ë¦¬ì…‹
          // ===== [í•µì‹¬] ë¬´ì¡°ê±´ ê°€ì¥ ì‘ì€ ì‚¬ì´ì¦ˆ(ì—¬ë°± ì—†ëŠ” ìµœì†Œ ë°°ìœ¨) + ì¤‘ì•™ ì •ë ¬ì´ ë””í´íŠ¸ =====
          if (!item.cropState || !item.cropState.zoom || item.cropState.zoom < minZoom) {
            currentZoom = minZoom; // ì¦‰ì‹œ ì ìš©
            console.log(`[AUTO-FIT] ì´ˆê¸° zoomì„ minZoom(${minZoom.toFixed(6)})ìœ¼ë¡œ ì¦‰ì‹œ ê°•ì œ ì„¤ì •`);

            // ì¢Œí‘œë¥¼ ì¤‘ì•™ì— ê½‰ ì°¨ê²Œ ë°°ì¹˜
            const cropX = (containerWidth - cropArea.width) / 2;
            const cropY = (containerHeight - cropArea.height) / 2;
            const imgWidth = imageNaturalWidth * currentZoom;
            const imgHeight = imageNaturalHeight * currentZoom;

            // ì´ë¯¸ì§€ë¥¼ í¬ë¡­ ì˜ì—­ ì¤‘ì•™ì— ë°°ì¹˜
            currentX = cropX + (cropArea.width - imgWidth) / 2;
            currentY = cropY + (cropArea.height - imgHeight) / 2;

            console.log(`[AUTO-FIT] ì¢Œí‘œ ë¦¬ì…‹: x=${currentX.toFixed(0)}, y=${currentY.toFixed(0)} (ì¤‘ì•™ ë°°ì¹˜)`);
          }
        }

        // í¬ë¡­ ìƒíƒœ ë¡œë“œ (minZoom ê³„ì‚° í¬í•¨) - ì¦‰ì‹œ ì‹¤í–‰
        loadCropState(item, img);
        // ë¹„ìœ¨ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        updateRatioButtons();
        // ê°€ì´ë“œë¼ì¸ í‘œì‹œ ì—…ë°ì´íŠ¸
        updateGuideLines();
        // ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° - ì¦‰ì‹œ ì‹¤í–‰
        drawImage();
        isMediaLoading = false; // ì´ë¯¸ì§€ ë¡œë”© ì™„ë£Œ
        console.log('[IMAGE] ë¯¸ë””ì–´ ë¡œë”© ì™„ë£Œ');

        // âœ… [HD Export] ì‹¤ì‹œê°„ í•´ìƒë„ í‘œì‹œ ì—…ë°ì´íŠ¸
        const cropPixels = calculateCropPixelSize(currentAspectRatio, currentZoom);
        updateResolutionDisplay(cropPixels.width, cropPixels.height);
      };

      // ì¦‰ì‹œ ì‹¤í–‰ ì‹œë„
      applyInitialFit();
    };
    // ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ file ê°ì²´ë¡œ ì¦‰ì‹œ ì¬ìƒì„±
    img.onerror = () => {
      // ===== [Fix] ë™ì˜ìƒì¸ë° ì´ë¯¸ì§€ ë¶„ê¸°ë¡œ ì˜ëª» ë“¤ì–´ì˜¨ ê²½ìš° ê°ì§€ - ë¬´í•œ ë£¨í”„ ë°©ì§€ =====
      if (item.file && item.file.type.startsWith('video/')) {
        console.error(`[TYPE ERROR] ${item.id}ëŠ” ë™ì˜ìƒì¸ë° ì´ë¯¸ì§€ë¡œ ì²˜ë¦¬ë¨. mediaType=${item.mediaType}, file.type=${item.file.type}`);
        item.mediaType = 'video';
        // ë¬´í•œ ë£¨í”„ ë°©ì§€ - ì´ë¯¸ì§€ ì¬ë¡œë“œ ì‹œë„í•˜ì§€ ì•Šê³  selectMedia ì¬í˜¸ì¶œ
        selectMedia(selectedMediaIndex);
        return;
      }

      console.warn(`[IMAGE ERROR] ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨, ì¦‰ì‹œ ì¬ìƒì„±: ${item.id}`);
      if (item.file) {
        item.previewUrl = URL.createObjectURL(item.file);
        img.src = item.previewUrl;
      }
    };
    img.src = item.previewUrl;
  }
  
  renderMediaList();
}

// âœ… ì—…ë¡œë“œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateUploadButtonState() {
  const uploadBtn = document.getElementById('uploadBtn');
  const uploadBtnText = document.getElementById('uploadBtnText');
  const uploadBtnCount = document.getElementById('uploadBtnCount');
  
  if (!uploadBtn) return;
  
  const confirmedCount = mediaItems.filter(item => item.isConfirmed).length;
  const totalCount = mediaItems.length;
  const allConfirmed = totalCount > 0 && confirmedCount === totalCount;
  const remainingCount = totalCount - confirmedCount;
  
  uploadBtn.disabled = !allConfirmed;
  
  // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë° ë¯¸ì™„ë£Œ ê°œìˆ˜ í‘œì‹œ
  if (uploadBtnText) {
    if (allConfirmed) {
      uploadBtnText.textContent = 'ë‹¤ìŒ ë‹¨ê³„ë¡œ';
      if (uploadBtnCount) uploadBtnCount.style.display = 'none';
    } else {
      uploadBtnText.textContent = 'ë‹¤ìŒ ë‹¨ê³„ë¡œ';
      if (uploadBtnCount) {
        uploadBtnCount.textContent = `${remainingCount}ê°œ ë” í™•ì¸ í•„ìš”`;
        uploadBtnCount.style.display = 'inline';
      }
    }
  }
}

// âœ… ì´ì „ ë²„íŠ¼ í•¸ë“¤ëŸ¬ í•¨ìˆ˜
function handleBackButton() {
  console.log('[DEBUG] ì´ì „ ë²„íŠ¼ í´ë¦­ë¨');

  // Step 1 ìƒíƒœë¥¼ sessionStorageì— ë‹¤ì‹œ ì €ì¥ (í¬ë¡­ ìƒíƒœ í¬í•¨)
  const step1Data = sessionStorage.getItem('admake_step1_state');
  if (step1Data) {
    const data = JSON.parse(step1Data);
    // í¬ë¡­ ìƒíƒœ ì—…ë°ì´íŠ¸
    data.mediaItems = data.mediaItems.map(item => {
      const mediaItem = mediaItems.find(m => m.id === item.id);
      if (mediaItem) {
        return {
          ...item,
          cropState: mediaItem.cropState,
          isConfirmed: mediaItem.isConfirmed,
          previewUrl: mediaItem.previewUrl // ìµœì‹  Blob URL ì €ì¥
        };
      }
      return item;
    });
    sessionStorage.setItem('admake_step1_state', JSON.stringify(data));
    console.log('[DEBUG] Step 1ë¡œ ëŒì•„ê°€ê¸° - ìƒíƒœ ì €ì¥ ì™„ë£Œ');
  }

  // IndexedDBì— ìµœì‹  ìƒíƒœ ì €ì¥ (Step 1 ë³µêµ¬ìš©)
  if ('indexedDB' in window && mediaItems.length > 0) {
    try {
      const dbName = 'admake_files';
      const request = indexedDB.open(dbName, 1);
      request.onsuccess = (event) => {
        const db = event.target.result;
        if (db.objectStoreNames.contains('files')) {
          const transaction = db.transaction(['files'], 'readwrite');
          const store = transaction.objectStore('files');

          mediaItems.forEach(item => {
            if (item.file) {
              store.put({
                id: item.id,
                file: item.file,
                previewUrl: item.previewUrl,
                type: item.type,
                mediaType: item.mediaType,
                cropState: item.cropState,
                isConfirmed: item.isConfirmed
              });
            }
          });

          transaction.oncomplete = () => {
            console.log('[DEBUG] IndexedDB ì—…ë°ì´íŠ¸ ì™„ë£Œ - Step 1 ë³µêµ¬ ì¤€ë¹„');
            window.location.href = `/admake/create?account_id=${encodeURIComponent(accountId)}`;
          };
        } else {
          window.location.href = `/admake/create?account_id=${encodeURIComponent(accountId)}`;
        }
      };
      request.onerror = () => {
        window.location.href = `/admake/create?account_id=${encodeURIComponent(accountId)}`;
      };
    } catch (e) {
      console.error('[ERROR] IndexedDB ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', e);
      window.location.href = `/admake/create?account_id=${encodeURIComponent(accountId)}`;
    }
  } else {
    window.location.href = `/admake/create?account_id=${encodeURIComponent(accountId)}`;
  }
}

// âœ… ì—…ë¡œë“œ ë²„íŠ¼
document.getElementById('uploadBtn').addEventListener('click', uploadToMeta);

// âœ… ì¤Œ ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸ (restrictPosition íš¨ê³¼ - minZoom ì—„ê²© ì ìš© + ì¤‘ì•™ ì•µì»¤)
const zoomSlider = document.getElementById('zoomSlider');
if (zoomSlider) {
  zoomSlider.addEventListener('input', (e) => {
    let newZoom = parseFloat(e.target.value);

    // restrictPosition: true íš¨ê³¼ - minZoom ì´í•˜ë¡œ ì¶•ì†Œ ë¶ˆê°€
    if (newZoom < minZoom) {
      console.log(`[RESTRICT] ìŠ¬ë¼ì´ë” ì¤Œ ê°•ì œ ë³´ì •: ${newZoom.toFixed(4)} â†’ ${minZoom.toFixed(4)}`);
      newZoom = minZoom;
      e.target.value = minZoom;
    }

    // ===== [ì¤‘ì•™ ì•µì»¤ ê³ ì •] ì¤Œ ë³€ê²½ ì‹œ í¬ë¡­ ì˜ì—­ ì¤‘ì‹¬ ê¸°ì¤€ìœ¼ë¡œ í™•ëŒ€/ì¶•ì†Œ =====
    if (currentImage && currentZoom !== newZoom) {
      const oldZoom = currentZoom;

      // í¬ë¡­ ì˜ì—­ ê³„ì‚°
      const cropArea = getCropAreaSize(containerWidth, containerHeight, currentAspectRatio);
      const cropX = (containerWidth - cropArea.width) / 2;
      const cropY = (containerHeight - cropArea.height) / 2;

      // í¬ë¡­ ì˜ì—­ì˜ ì¤‘ì‹¬ì  (ìŠ¤í¬ë¦° ì¢Œí‘œ)
      const centerScreenX = cropX + cropArea.width / 2;
      const centerScreenY = cropY + cropArea.height / 2;

      // í˜„ì¬ ì¤‘ì‹¬ì— ìˆëŠ” ì´ë¯¸ì§€ì˜ ì›ë³¸ ì¢Œí‘œ (naturalWidth/Height ê¸°ì¤€)
      const imagePointX = (centerScreenX - currentX) / oldZoom;
      const imagePointY = (centerScreenY - currentY) / oldZoom;

      // ìƒˆ ì¤Œì—ì„œ ê°™ì€ ì´ë¯¸ì§€ í¬ì¸íŠ¸ê°€ ì¤‘ì‹¬ì— ì˜¤ë„ë¡ ì¢Œí‘œ ì¬ê³„ì‚°
      currentX = centerScreenX - (imagePointX * newZoom);
      currentY = centerScreenY - (imagePointY * newZoom);

      console.log(`[ZOOM ANCHOR] ì¤‘ì•™ ê¸°ì¤€ ì¤Œ: ${oldZoom.toFixed(4)} â†’ ${newZoom.toFixed(4)}, pos=(${currentX.toFixed(0)}, ${currentY.toFixed(0)})`);
    }

    currentZoom = newZoom;
    const zoomValue = document.getElementById('zoomValue');
    if (zoomValue) zoomValue.textContent = Math.round(currentZoom * 100) + '%';

    if (currentImage) {
      drawImage();
      saveCropState();

      // IndexedDB ìƒíƒœ ë™ê¸°í™” (ìƒíƒœ ìœ ì§€ ê°•í™”)
      syncCropStateToIndexedDB();

      // âœ… [HD Export] ì‹¤ì‹œê°„ í•´ìƒë„ í‘œì‹œ ì—…ë°ì´íŠ¸
      const cropPixels = calculateCropPixelSize(currentAspectRatio, currentZoom);
      updateResolutionDisplay(cropPixels.width, cropPixels.height);
    }
  });
}

// âœ… í™•ì¸ ë²„íŠ¼ ì´ë²¤íŠ¸
const confirmBtn = document.getElementById('confirmBtn');
if (confirmBtn) {
  confirmBtn.addEventListener('click', () => {
    confirmMedia();
  });
}

// âœ… [HD Export] ì‹¤ì‹œê°„ í•´ìƒë„ í‘œì‹œ ì—…ë°ì´íŠ¸
function updateResolutionDisplay(pixelWidth, pixelHeight) {
  const valueEl = document.getElementById('resolutionValue');
  const statusEl = document.getElementById('resolutionStatus');
  const warningEl = document.getElementById('resolutionWarning');
  const confirmBtn = document.getElementById('confirmBtn');

  if (!valueEl || !statusEl || !warningEl) return;

  // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
  currentCropPixelWidth = Math.round(pixelWidth);
  currentCropPixelHeight = Math.round(pixelHeight);

  // í•´ìƒë„ ê°’ í‘œì‹œ
  valueEl.textContent = `${currentCropPixelWidth} x ${currentCropPixelHeight}`;

  // ìƒíƒœ íŒì •
  if (currentCropPixelWidth >= META_RECOMMENDED_WIDTH) {
    // âœ… ê¶Œì¥ ê·œê²© ì´ìƒ
    statusEl.textContent = 'âœ“ ë©”íƒ€ ê´‘ê³  ê¶Œì¥ ê·œê²©';
    statusEl.style.color = '#059669';
    warningEl.style.display = 'none';
    if (confirmBtn) confirmBtn.disabled = false;
  } else if (currentCropPixelWidth >= META_MIN_WIDTH) {
    // âš ï¸ ìµœì†Œ ê·œê²© ì¶©ì¡± (ê¶Œì¥ ë¯¸ë‹¬)
    statusEl.textContent = 'â–³ ìµœì†Œ ê·œê²© ì¶©ì¡± (ê¶Œì¥: 1080px)';
    statusEl.style.color = '#d97706';
    warningEl.style.display = 'none';
    if (confirmBtn) confirmBtn.disabled = false;
  } else {
    // âŒ ìµœì†Œ ê·œê²© ë¯¸ë‹¬
    statusEl.textContent = 'âœ— í•´ìƒë„ ë¶€ì¡±';
    statusEl.style.color = '#dc2626';
    warningEl.style.display = 'block';
    if (confirmBtn) confirmBtn.disabled = true;
  }

  console.log(`[HD RESOLUTION] ${currentCropPixelWidth}x${currentCropPixelHeight} (min: ${META_MIN_WIDTH}, recommended: ${META_RECOMMENDED_WIDTH})`);
}

// âœ… [HD Export] í˜„ì¬ í¬ë¡­ ì˜ì—­ì˜ ì›ë³¸ í”½ì…€ í¬ê¸° ê³„ì‚°
function calculateCropPixelSize(aspectRatio, zoom) {
  if (!currentImage || containerWidth <= 0 || containerHeight <= 0 || zoom <= 0) {
    return { width: 0, height: 0 };
  }

  // UI í¬ë¡­ ì˜ì—­ ê³„ì‚°
  const cropArea = getCropAreaSize(containerWidth, containerHeight, aspectRatio);

  // ì›ë³¸ í”½ì…€ í¬ê¸° = UI í¬ë¡­ ì˜ì—­ / ì¤Œ ë°°ìœ¨
  // ì¤Œì´ ë†’ì„ìˆ˜ë¡ ì›ë³¸ì—ì„œ ì‘ì€ ì˜ì—­ì„ ìë¥´ë¯€ë¡œ í•´ìƒë„ê°€ ë‚®ì•„ì§
  const pixelWidth = cropArea.width / zoom;
  const pixelHeight = cropArea.height / zoom;

  return { width: pixelWidth, height: pixelHeight };
}

// âœ… [HD Export] í¬ë¡­ëœ ì´ë¯¸ì§€ ìƒì„± - ì›ë³¸ í•´ìƒë„ ìœ ì§€
async function createCroppedImage(mediaItem) {
  return new Promise((resolve, reject) => {
    if (mediaItem.mediaType === 'video') {
      // ë™ì˜ìƒì€ ì›ë³¸ íŒŒì¼ ì‚¬ìš© (file ê°ì²´ ìš°ì„ )
      console.log(`[HD EXPORT] ë™ì˜ìƒ ì›ë³¸ ì‚¬ìš©: ${mediaItem.id}`);
      if (mediaItem.file) {
        resolve(mediaItem.file);
        return;
      }
      // file ê°ì²´ê°€ ì—†ìœ¼ë©´ IndexedDBì—ì„œ ê°€ì ¸ì˜¤ê¸°
      getFileFromIndexedDB(mediaItem.id)
        .then(file => resolve(file))
        .catch(reject);
      return;
    }

    // ===== [HD Export] ì´ë¯¸ì§€ ê³ í™”ì§ˆ í¬ë¡­ =====
    const state = mediaItem.cropState || { x: 0, y: 0, zoom: 1, aspectRatio: 9/16 };
    const aspectRatio = state.aspectRatio || 9/16;
    const zoom = state.zoom || 1;

    // ì´ë¯¸ì§€ ë¡œë“œ
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => {
      // ì›ë³¸ ì´ë¯¸ì§€ í¬ê¸°
      const imageNaturalWidth = img.naturalWidth || img.width;
      const imageNaturalHeight = img.naturalHeight || img.height;

      if (imageNaturalWidth <= 0 || imageNaturalHeight <= 0) {
        reject(new Error('ì´ë¯¸ì§€ ì›ë³¸ í¬ê¸°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'));
        return;
      }

      // UI í¬ë¡­ ì˜ì—­ ê³„ì‚° (containerWidth/HeightëŠ” ì „ì—­ ë³€ìˆ˜)
      const cropArea = getCropAreaSize(containerWidth, containerHeight, aspectRatio);
      const cropX = (containerWidth - cropArea.width) / 2;
      const cropY = (containerHeight - cropArea.height) / 2;

      // ===== [í•µì‹¬] ì›ë³¸ ì´ë¯¸ì§€ ì¢Œí‘œë¡œ ë³€í™˜ =====
      // UIì—ì„œ í¬ë¡­ ì˜ì—­ì˜ ì‹œì‘ì  (ì´ë¯¸ì§€ ê¸°ì¤€ ìƒëŒ€ ì¢Œí‘œ)
      // state.x, state.yëŠ” ì´ë¯¸ì§€ê°€ ìº”ë²„ìŠ¤ì— ê·¸ë ¤ì§€ëŠ” ìœ„ì¹˜
      // cropX, cropYëŠ” í¬ë¡­ ì˜ì—­ì´ ìº”ë²„ìŠ¤ì—ì„œ ì‹œì‘ë˜ëŠ” ìœ„ì¹˜
      // í¬ë¡­ ì˜ì—­ ê¸°ì¤€ ì´ë¯¸ì§€ ì˜¤í”„ì…‹ = cropX - state.x (ì–‘ìˆ˜ë©´ ì´ë¯¸ì§€ ì™¼ìª½ ì˜ë¦¼)
      const offsetX = cropX - state.x;
      const offsetY = cropY - state.y;

      // ì›ë³¸ ì´ë¯¸ì§€ì—ì„œì˜ ì†ŒìŠ¤ ì¢Œí‘œ (UI ì¢Œí‘œë¥¼ ì¤Œìœ¼ë¡œ ë‚˜ëˆ”)
      const sx = Math.max(0, offsetX / zoom);
      const sy = Math.max(0, offsetY / zoom);
      const sw = Math.min(imageNaturalWidth - sx, cropArea.width / zoom);
      const sh = Math.min(imageNaturalHeight - sy, cropArea.height / zoom);

      // ì¶œë ¥ ìº”ë²„ìŠ¤ í¬ê¸° = ì›ë³¸ í”½ì…€ í¬ê¸° (1:1 í•´ìƒë„)
      let outputWidth = Math.round(sw);
      let outputHeight = Math.round(sh);

      // âœ… [Instagram Reels] 9:16 ë¹„ìœ¨ ì •ë°€ë„ ë³´ì • (0.5625 ì •í™•ë„)
      // Meta APIëŠ” ë¹„ìœ¨ì´ ë¯¸ì„¸í•˜ê²Œ í‹€ì–´ì§€ë©´ ê±°ë¶€í•¨
      const is916Ratio = Math.abs(aspectRatio - RATIO_9_16) < RATIO_TOLERANCE;
      if (is916Ratio) {
        // 9:16 = 0.5625 â†’ width = height * 0.5625
        // ë†’ì´ ê¸°ì¤€ìœ¼ë¡œ ë„ˆë¹„ ì¬ê³„ì‚° (1920 â†’ 1080)
        const exactWidth = Math.round(outputHeight * RATIO_9_16);
        if (outputWidth !== exactWidth) {
          console.log(`[RATIO FIX] 9:16 ì •ë°€ë„ ë³´ì •: ${outputWidth}x${outputHeight} â†’ ${exactWidth}x${outputHeight}`);
          outputWidth = exactWidth;
        }
        // ì‹¤ì œ ë¹„ìœ¨ ê²€ì¦
        const actualRatio = outputWidth / outputHeight;
        console.log(`[RATIO CHECK] 9:16 ë¹„ìœ¨ í™•ì¸: ${actualRatio.toFixed(6)} (ëª©í‘œ: ${RATIO_9_16.toFixed(6)})`);
      }

      // 4:5 ë¹„ìœ¨ë„ ì •ë°€ë„ ë³´ì •
      const is45Ratio = Math.abs(aspectRatio - RATIO_4_5) < RATIO_TOLERANCE;
      if (is45Ratio) {
        const exactWidth = Math.round(outputHeight * RATIO_4_5);
        if (outputWidth !== exactWidth) {
          console.log(`[RATIO FIX] 4:5 ì •ë°€ë„ ë³´ì •: ${outputWidth}x${outputHeight} â†’ ${exactWidth}x${outputHeight}`);
          outputWidth = exactWidth;
        }
      }

      // 1:1 ë¹„ìœ¨ë„ ì •ë°€ë„ ë³´ì •
      const is11Ratio = Math.abs(aspectRatio - RATIO_1_1) < RATIO_TOLERANCE;
      if (is11Ratio) {
        // 1:1ì€ ë„ˆë¹„ì™€ ë†’ì´ê°€ ê°™ì•„ì•¼ í•¨
        const maxDim = Math.max(outputWidth, outputHeight);
        const minDim = Math.min(outputWidth, outputHeight);
        if (outputWidth !== outputHeight) {
          console.log(`[RATIO FIX] 1:1 ì •ë°€ë„ ë³´ì •: ${outputWidth}x${outputHeight} â†’ ${minDim}x${minDim}`);
          outputWidth = minDim;
          outputHeight = minDim;
        }
      }

      console.log(`[HD EXPORT] ì›ë³¸: ${imageNaturalWidth}x${imageNaturalHeight}`);
      console.log(`[HD EXPORT] ì¤Œ: ${zoom.toFixed(4)}, ì†ŒìŠ¤: (${sx.toFixed(1)}, ${sy.toFixed(1)}) ${sw.toFixed(1)}x${sh.toFixed(1)}`);
      console.log(`[HD EXPORT] ì¶œë ¥: ${outputWidth}x${outputHeight} (ë¹„ìœ¨: ${(outputWidth/outputHeight).toFixed(6)})`);

      // ===== ê³ í™”ì§ˆ ìº”ë²„ìŠ¤ ìƒì„± =====
      const cropCanvas = document.createElement('canvas');
      cropCanvas.width = outputWidth;
      cropCanvas.height = outputHeight;
      const cropCtx = cropCanvas.getContext('2d');

      // ê³ í™”ì§ˆ ë Œë”ë§ ì„¤ì •
      cropCtx.imageSmoothingEnabled = true;
      cropCtx.imageSmoothingQuality = 'high';

      // drawImage(img, sx, sy, sw, sh, dx, dy, dw, dh)
      // ì›ë³¸ ì´ë¯¸ì§€ì˜ (sx, sy)ë¶€í„° (sw, sh) ì˜ì—­ì„
      // ìº”ë²„ìŠ¤ì˜ (0, 0)ë¶€í„° (outputWidth, outputHeight)ë¡œ ê·¸ë¦¼
      cropCtx.drawImage(
        img,
        sx, sy, sw, sh,           // ì†ŒìŠ¤ ì˜ì—­ (ì›ë³¸ í”½ì…€)
        0, 0, outputWidth, outputHeight  // ëŒ€ìƒ ì˜ì—­ (ìº”ë²„ìŠ¤)
      );

      // Canvasë¥¼ Blobìœ¼ë¡œ ë³€í™˜ (JPEG í’ˆì§ˆ 0.95)
      cropCanvas.toBlob((blob) => {
        if (!blob) {
          reject(new Error('ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨'));
          return;
        }

        const file = new File([blob], mediaItem.name, { type: 'image/jpeg' });
        console.log(`[HD EXPORT] âœ… ì™„ë£Œ: ${mediaItem.name} (${outputWidth}x${outputHeight}, ${(blob.size/1024).toFixed(1)}KB)`);
        resolve(file);
      }, 'image/jpeg', 0.95);
    };

    img.onerror = () => {
      reject(new Error('ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'));
    };

    img.src = mediaItem.previewUrl;
  });
}

// âœ… ì—…ë¡œë“œ í”„ë¡œê·¸ë ˆìŠ¤ UI ê´€ë¦¬
let uploadStartTime = null;
let uploadFileStatuses = [];

// ì—…ë¡œë“œ UI ì´ˆê¸°í™”
function initUploadProgress(files) {
  console.log('[UPLOAD DEBUG] initUploadProgress ì‹œì‘, files:', files);
  try {
    uploadStartTime = Date.now();
    uploadFileStatuses = files.map((f, idx) => ({
      id: f.id,
      name: f.name || `íŒŒì¼ ${idx + 1}`,
      type: f.mediaType || 'image',
      status: 'waiting' // waiting, progress, done, error
    }));
    console.log('[UPLOAD DEBUG] uploadFileStatuses ìƒì„±ë¨:', uploadFileStatuses);

    renderUploadFileList();
    console.log('[UPLOAD DEBUG] renderUploadFileList ì™„ë£Œ');

    updateProgressCircle(0);
    console.log('[UPLOAD DEBUG] updateProgressCircle ì™„ë£Œ');

    updateUploadStage('ì¤€ë¹„ ì¤‘...', 'íŒŒì¼ ì •ë³´ë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤');
    console.log('[UPLOAD DEBUG] initUploadProgress ì™„ë£Œ');
  } catch (e) {
    console.error('[UPLOAD DEBUG] initUploadProgress ì—ëŸ¬:', e);
  }
}

// íŒŒì¼ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
function renderUploadFileList() {
  console.log('[UPLOAD DEBUG] renderUploadFileList ì‹œì‘');
  const container = document.getElementById('uploadFileList');
  console.log('[UPLOAD DEBUG] uploadFileList ì»¨í…Œì´ë„ˆ:', container);
  if (!container) {
    console.warn('[UPLOAD DEBUG] uploadFileList ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ!');
    return;
  }

  container.innerHTML = uploadFileStatuses.map((file, idx) => {
    const iconMap = {
      waiting: '<span class="upload-file-icon status-waiting">â—‹</span>',
      progress: '<span class="upload-file-icon status-progress"></span>',
      done: '<span class="upload-file-icon status-done">âœ“</span>',
      error: '<span class="upload-file-icon status-error">âœ•</span>'
    };

    const statusTextMap = {
      waiting: '<span class="upload-file-status status-waiting">ëŒ€ê¸°</span>',
      progress: '<span class="upload-file-status status-progress">ì—…ë¡œë“œ ì¤‘</span>',
      done: '<span class="upload-file-status status-done">ì™„ë£Œ</span>',
      error: '<span class="upload-file-status status-error">ì‹¤íŒ¨</span>'
    };

    const typeIcon = file.type === 'video' ? 'ğŸ¬' : 'ğŸ–¼ï¸';
    const isCurrent = file.status === 'progress';

    return `
      <div class="upload-file-item ${isCurrent ? 'current' : ''}">
        ${iconMap[file.status]}
        <span class="upload-file-name">${typeIcon} ${file.name}</span>
        ${statusTextMap[file.status]}
      </div>
    `;
  }).join('');
}

// ì›í˜• í”„ë¡œê·¸ë ˆìŠ¤ ì—…ë°ì´íŠ¸
function updateProgressCircle(percent) {
  const circle = document.getElementById('progressCircle');
  const percentText = document.getElementById('progressPercent');

  if (circle) {
    // stroke-dasharray: 339.292 (2 * PI * 54)
    const offset = 339.292 * (1 - percent / 100);
    circle.style.strokeDashoffset = offset;
  }

  if (percentText) {
    percentText.textContent = `${Math.round(percent)}%`;
  }
}

// ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
function updateUploadStage(title, subtitle) {
  console.log('[UPLOAD DEBUG] updateUploadStage:', title, subtitle);
  const titleEl = document.getElementById('uploadStageTitle');
  const subtitleEl = document.getElementById('uploadStageSubtitle');
  console.log('[UPLOAD DEBUG] titleEl:', titleEl, 'subtitleEl:', subtitleEl);

  if (titleEl) titleEl.textContent = title;
  if (subtitleEl) subtitleEl.textContent = subtitle;
}

// ì˜ˆìƒ ì‹œê°„ ì—…ë°ì´íŠ¸
function updateUploadEta(current, total) {
  const etaEl = document.getElementById('uploadEta');
  if (!etaEl || !uploadStartTime || current === 0) return;

  const elapsed = Date.now() - uploadStartTime;
  const avgTimePerFile = elapsed / current;
  const remaining = (total - current) * avgTimePerFile;

  let etaText;
  if (remaining < 5000) {
    etaText = 'ê±°ì˜ ì™„ë£Œ';
  } else if (remaining < 60000) {
    etaText = `ì•½ ${Math.ceil(remaining / 1000)}ì´ˆ ë‚¨ìŒ`;
  } else {
    etaText = `ì•½ ${Math.ceil(remaining / 60000)}ë¶„ ë‚¨ìŒ`;
  }

  etaEl.innerHTML = `<span style="font-size: 16px;">â±</span><span>${etaText} (${current}/${total})</span>`;
}

// íŒŒì¼ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateFileStatus(fileId, status) {
  const file = uploadFileStatuses.find(f => f.id === fileId);
  if (file) {
    file.status = status;
    renderUploadFileList();
  }
}

// í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì—…ë°ì´íŠ¸ (ê¸°ì¡´ í•¨ìˆ˜ í™•ì¥)
function updateUploadProgress(current, total, fileName, fileId) {
  const percentage = Math.round((current / total) * 100);

  // ì›í˜• í”„ë¡œê·¸ë ˆìŠ¤
  updateProgressCircle(percentage);

  // íŒŒì¼ ìƒíƒœ ì—…ë°ì´íŠ¸
  if (fileId) {
    // ì´ì „ íŒŒì¼ë“¤ì„ ì™„ë£Œ ì²˜ë¦¬
    uploadFileStatuses.forEach((f, idx) => {
      if (idx < current - 1 && f.status !== 'done') {
        f.status = 'done';
      }
    });
    // í˜„ì¬ íŒŒì¼ì„ ì§„í–‰ ì¤‘ìœ¼ë¡œ
    updateFileStatus(fileId, 'progress');
  }

  // ìƒíƒœ ë©”ì‹œì§€
  if (current === total && fileName === 'ì™„ë£Œ') {
    updateUploadStage('ì—…ë¡œë“œ ì™„ë£Œ!', 'Step 3ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤...');
    // ëª¨ë“  íŒŒì¼ ì™„ë£Œ ì²˜ë¦¬
    uploadFileStatuses.forEach(f => f.status = 'done');
    renderUploadFileList();
  } else {
    const fileType = uploadFileStatuses.find(f => f.id === fileId)?.type;
    const typeText = fileType === 'video' ? 'ì˜ìƒ' : 'ì´ë¯¸ì§€';
    updateUploadStage(`${typeText} ì—…ë¡œë“œ ì¤‘...`, `${fileName || 'íŒŒì¼'} (${current}/${total})`);
  }

  // ì˜ˆìƒ ì‹œê°„
  updateUploadEta(current, total);
}

// âœ… ë©”íƒ€ API ì—…ë¡œë“œ (í¬ë¡­ëœ ì´ë¯¸ì§€ ì‚¬ìš©, ìˆœì°¨ ì²˜ë¦¬ ë° í”„ë¡œê·¸ë ˆìŠ¤ ë°”)
async function uploadToMeta() {
  console.log('[UPLOAD DEBUG] ========== uploadToMeta í•¨ìˆ˜ ì‹œì‘ ==========');

  // ===== [Fix] ë¯¸ë””ì–´ ë¡œë”© ì¤‘ì´ë©´ ì—…ë¡œë“œ ì°¨ë‹¨ =====
  if (isMediaLoading) {
    showToast('ë¯¸ë””ì–´ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'info');
    console.warn('[UPLOAD] ë¯¸ë””ì–´ ë¡œë”© ì¤‘ - ì—…ë¡œë“œ ì°¨ë‹¨ë¨');
    return;
  }

  const uploadBtn = document.getElementById('uploadBtn');
  const loadingOverlay = document.getElementById('loadingOverlay');

  console.log('[UPLOAD DEBUG] uploadBtn ì¡´ì¬:', !!uploadBtn);
  console.log('[UPLOAD DEBUG] loadingOverlay ì¡´ì¬:', !!loadingOverlay);
  console.log('[UPLOAD DEBUG] loadingOverlay í˜„ì¬ í´ë˜ìŠ¤:', loadingOverlay?.className);
  console.log('[UPLOAD DEBUG] loadingOverlay í˜„ì¬ display:', loadingOverlay ? window.getComputedStyle(loadingOverlay).display : 'N/A');

  uploadBtn.disabled = true;

  // ê¸°ì¡´ ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ ì œê±° í›„ active í´ë˜ìŠ¤ ì¶”ê°€
  loadingOverlay.removeAttribute('style');
  loadingOverlay.classList.add('active');

  // ê°•ì œë¡œ ìŠ¤íƒ€ì¼ ì„¤ì • (CSSê°€ ì ìš©ë˜ì§€ ì•ŠëŠ” ë¬¸ì œ í•´ê²°)
  loadingOverlay.style.cssText = 'display: flex !important; opacity: 1 !important; background: rgba(9, 9, 11, 0.95) !important; visibility: visible !important; position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; z-index: 9999 !important;';

  console.log('[UPLOAD DEBUG] ìŠ¤íƒ€ì¼ ê°•ì œ ì ìš© ì§í›„:');
  console.log('[UPLOAD DEBUG] â†’ style.cssText:', loadingOverlay.style.cssText);
  console.log('[UPLOAD DEBUG] â†’ computed opacity:', window.getComputedStyle(loadingOverlay).opacity);
  console.log('[UPLOAD DEBUG] â†’ computed background:', window.getComputedStyle(loadingOverlay).background);

  console.log('[UPLOAD DEBUG] active í´ë˜ìŠ¤ ì¶”ê°€ í›„ className:', loadingOverlay?.className);
  console.log('[UPLOAD DEBUG] active ì¶”ê°€ í›„ display:', loadingOverlay ? window.getComputedStyle(loadingOverlay).display : 'N/A');

  // ì—…ë¡œë“œ UI ì´ˆê¸°í™”
  console.log('[UPLOAD DEBUG] initUploadProgress í˜¸ì¶œ, mediaItems ê°œìˆ˜:', mediaItems?.length);
  initUploadProgress(mediaItems);
  console.log('[UPLOAD DEBUG] initUploadProgress ì™„ë£Œ');

  // initUploadProgress í›„ ìŠ¤íƒ€ì¼ ì¬í™•ì¸
  console.log('[UPLOAD DEBUG] initUploadProgress í›„ ìŠ¤íƒ€ì¼ í™•ì¸:');
  console.log('[UPLOAD DEBUG] â†’ computed opacity:', window.getComputedStyle(loadingOverlay).opacity);
  console.log('[UPLOAD DEBUG] â†’ computed background:', window.getComputedStyle(loadingOverlay).background);

  updateUploadStage('ë©”íƒ€ ì„œë²„ì— ì—°ê²° ì¤‘...', 'ì¸ì¦ ì •ë³´ë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤');
  console.log('[UPLOAD DEBUG] updateUploadStage ì™„ë£Œ');

  // ë¸Œë¼ìš°ì €ê°€ UIë¥¼ ë Œë”ë§í•  ì‹œê°„ í™•ë³´ (ë¡œë”© íŒì—… ì¦‰ì‹œ í‘œì‹œ)
  console.log('[UPLOAD DEBUG] requestAnimationFrame ëŒ€ê¸° ì‹œì‘...');

  // ì˜¤ë²„ë ˆì´ ìœ„ì¹˜/í¬ê¸° ë””ë²„ê·¸
  const overlayRect = loadingOverlay.getBoundingClientRect();
  console.log('[UPLOAD DEBUG] ì˜¤ë²„ë ˆì´ ìœ„ì¹˜:', overlayRect);
  console.log('[UPLOAD DEBUG] ì˜¤ë²„ë ˆì´ offsetParent:', loadingOverlay.offsetParent);
  console.log('[UPLOAD DEBUG] ì˜¤ë²„ë ˆì´ z-index:', window.getComputedStyle(loadingOverlay).zIndex);
  console.log('[UPLOAD DEBUG] ì˜¤ë²„ë ˆì´ visibility:', window.getComputedStyle(loadingOverlay).visibility);
  console.log('[UPLOAD DEBUG] ì˜¤ë²„ë ˆì´ opacity:', window.getComputedStyle(loadingOverlay).opacity);
  console.log('[UPLOAD DEBUG] ì˜¤ë²„ë ˆì´ position:', window.getComputedStyle(loadingOverlay).position);
  console.log('[UPLOAD DEBUG] ì˜¤ë²„ë ˆì´ background:', window.getComputedStyle(loadingOverlay).background);

  // ë‚´ë¶€ ì½˜í…ì¸  í™•ì¸
  const loadingContent = loadingOverlay.querySelector('.admake-loading-content');
  if (loadingContent) {
    console.log('[UPLOAD DEBUG] ì½˜í…ì¸  display:', window.getComputedStyle(loadingContent).display);
    console.log('[UPLOAD DEBUG] ì½˜í…ì¸  ìœ„ì¹˜:', loadingContent.getBoundingClientRect());
  } else {
    console.error('[UPLOAD DEBUG] .admake-loading-contentë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ!');
  }

  await new Promise(resolve => requestAnimationFrame(() => {
    console.log('[UPLOAD DEBUG] ì²«ë²ˆì§¸ RAF ì½œë°±');
    requestAnimationFrame(() => {
      console.log('[UPLOAD DEBUG] ë‘ë²ˆì§¸ RAF ì½œë°± - resolve');
      resolve();
    });
  }));
  console.log('[UPLOAD DEBUG] requestAnimationFrame ëŒ€ê¸° ì™„ë£Œ, íŒì—… ë³´ì—¬ì•¼ í•¨');

  try {
    // ì„œë²„ì—ì„œ ì•¡ì„¸ìŠ¤ í† í° ê°€ì ¸ì˜¤ê¸°
    const tokenResponse = await fetch('/dashboard/get_meta_token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ account_id: accountId })
    });
    
    const tokenData = await tokenResponse.json();
    if (tokenData.status !== 'success' || !tokenData.access_token) {
      throw new Error('Meta ì•¡ì„¸ìŠ¤ í† í°ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
    
    const accessToken = tokenData.access_token;
    const apiVersion = 'v24.0';
    const adAccountId = `act_${accountId}`;

    uploadedResults = [];
    const errors = [];
    const totalCount = mediaItems.length;

    // ìƒíƒœ ì—…ë°ì´íŠ¸: ì—°ê²° ì„±ê³µ
    updateUploadStage('íŒŒì¼ ì¤€ë¹„ ì¤‘...', 'í¬ë¡­ëœ ì´ë¯¸ì§€ë¥¼ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤');

    // ===== [Fix] ì—…ë¡œë“œ ì „ ëª¨ë“  ë¯¸ë””ì–´ì˜ mediaType ê²€ì¦ ë° previewUrl ê°±ì‹  =====
    for (const item of mediaItems) {
      if (item.file) {
        const expectedType = item.file.type.startsWith('video/') ? 'video' : 'image';
        if (item.mediaType !== expectedType) {
          console.warn(`[UPLOAD FIX] ${item.id} íƒ€ì… ìˆ˜ì •: ${item.mediaType} â†’ ${expectedType}`);
          item.mediaType = expectedType;
        }
        // previewUrl ê°±ì‹  (blob: URLì€ í˜ì´ì§€ ì´ë™ ì‹œ ë¬´íš¨í™”ë  ìˆ˜ ìˆìŒ)
        if (item.previewUrl) {
          try { URL.revokeObjectURL(item.previewUrl); } catch (e) {}
        }
        item.previewUrl = URL.createObjectURL(item.file);
        console.log(`[UPLOAD] ${item.id}: previewUrl ê°±ì‹  ì™„ë£Œ, mediaType=${item.mediaType}`);
      }
    }

    // ê° ë¯¸ë””ì–´ íŒŒì¼ì„ ìˆœì°¨ì ìœ¼ë¡œ Meta APIë¡œ ì—…ë¡œë“œ
    for (let i = 0; i < mediaItems.length; i++) {
      const item = mediaItems[i];
      
      try {
        // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì—…ë°ì´íŠ¸ (íŒŒì¼ ID ì „ë‹¬)
        updateUploadProgress(i + 1, totalCount, item.name, item.id);

        // í¬ë¡­ëœ ì´ë¯¸ì§€ ë˜ëŠ” ì›ë³¸ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
        let file;
        if (item.mediaType === 'image') {
          file = await createCroppedImage(item);
          // âœ… [HD Export] ì—…ë¡œë“œ ì§ì „ ë¡œê¹… - ì´ë¯¸ì§€ í•´ìƒë„ í™•ì¸
          console.log(`[HD UPLOAD] ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤€ë¹„: ${item.name}`);
          console.log(`[HD UPLOAD] â†³ íŒŒì¼ í¬ê¸°: ${(file.size / 1024).toFixed(1)}KB`);
          console.log(`[HD UPLOAD] â†³ í¬ë¡­ ì„¤ì •: zoom=${item.cropState?.zoom?.toFixed(4) || 'N/A'}, ratio=${item.cropState?.aspectRatio || 'N/A'}`);
        } else {
          // ë™ì˜ìƒì€ ì›ë³¸ ì‚¬ìš©
          try {
            file = await getFileFromIndexedDB(item.id);
          } catch (e) {
            const response = await fetch(item.previewUrl);
            const blob = await response.blob();
            file = new File([blob], item.name, { type: item.type });
          }

          // âœ… [Instagram Reels] ë™ì˜ìƒ ë¹„ìœ¨ ê²€ì¦ ë° ë¡œê¹…
          const videoRatio = item.cropState?.aspectRatio || RATIO_9_16;
          const is916Video = Math.abs(videoRatio - RATIO_9_16) < RATIO_TOLERANCE;

          console.log(`[HD UPLOAD] ë™ì˜ìƒ ì—…ë¡œë“œ ì¤€ë¹„: ${item.name}`);
          console.log(`[HD UPLOAD] â†³ íŒŒì¼ í¬ê¸°: ${(file.size / (1024 * 1024)).toFixed(2)}MB`);
          console.log(`[HD UPLOAD] â†³ ì„¤ì •ëœ ë¹„ìœ¨: ${videoRatio.toFixed(4)} (9:16=${RATIO_9_16.toFixed(4)})`);

          if (!is916Video) {
            console.warn(`[REELS WARNING] âš ï¸ ë™ì˜ìƒ ${item.name}ì˜ ë¹„ìœ¨ì´ 9:16ì´ ì•„ë‹™ë‹ˆë‹¤!`);
            console.warn(`[REELS WARNING] ì¸ìŠ¤íƒ€ê·¸ë¨ ë¦´ìŠ¤ì—ì„œ ê±°ë¶€ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
          } else {
            console.log(`[HD UPLOAD] âœ… ì¸ìŠ¤íƒ€ê·¸ë¨ ë¦´ìŠ¤ í˜¸í™˜ (9:16)`);
          }
        }

        let result;
        if (item.mediaType === 'image') {
          // ì´ë¯¸ì§€ ì—…ë¡œë“œ: POST /v24.0/{ad_account_id}/adimages
          const formData = new FormData();
          formData.append('file', file, item.name);
          
          const response = await fetch(
            `https://graph.facebook.com/${apiVersion}/${adAccountId}/adimages?access_token=${encodeURIComponent(accessToken)}`,
            {
              method: 'POST',
              body: formData
            }
          );
          
          const data = await response.json();
          
          if (data.error) {
            throw new Error(data.error.message || 'ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨');
          }
          
          // ì‘ë‹µ í˜•ì‹: { "images": { "image_name": { "hash": "..." } } }
          const imageName = Object.keys(data.images || {})[0];
          const hash = data.images?.[imageName]?.hash;
          if (!hash) {
            throw new Error('ì´ë¯¸ì§€ í•´ì‹œë¥¼ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
          }
          
          // âœ… [UX ê°œì„ ] ë°°ì¹˜ í˜¸í™˜ì„± ë°ì´í„° ì¶”ê°€
          const imageRatio = item.cropState?.aspectRatio || RATIO_9_16;
          const imageIs916 = Math.abs(imageRatio - RATIO_9_16) < RATIO_TOLERANCE;

          result = {
            id: item.id,
            type: 'image',
            hash: hash,
            video_id: null,
            // ë°°ì¹˜ í˜¸í™˜ì„± ì •ë³´
            aspectRatio: imageRatio,
            placements: {
              reels: imageIs916,        // 9:16ë§Œ ë¦´ìŠ¤ ê°€ëŠ¥
              stories: imageIs916,      // 9:16ë§Œ ìŠ¤í† ë¦¬ ê°€ëŠ¥
              feed: true,               // ëª¨ë“  ë¹„ìœ¨ í”¼ë“œ ê°€ëŠ¥
              instream: imageIs916      // 9:16ë§Œ ì¸ìŠ¤íŠ¸ë¦¼ ê°€ëŠ¥
            }
          };
          console.log(`[PLACEMENT] ì´ë¯¸ì§€ ${item.name}: reels=${imageIs916}, ratio=${imageRatio.toFixed(4)}`);
        } else {
          // ë™ì˜ìƒ ì—…ë¡œë“œ: POST /v24.0/{ad_account_id}/advideos
          const formData = new FormData();
          formData.append('source', file, item.name);
          
          const response = await fetch(
            `https://graph.facebook.com/${apiVersion}/${adAccountId}/advideos?access_token=${encodeURIComponent(accessToken)}`,
            {
              method: 'POST',
              body: formData
            }
          );
          
          const data = await response.json();
          
          if (data.error) {
            throw new Error(data.error.message || 'ë™ì˜ìƒ ì—…ë¡œë“œ ì‹¤íŒ¨');
          }
          
          // ì‘ë‹µ í˜•ì‹: { "video_id": "..." }
          const videoId = data.video_id || data.id;
          if (!videoId) {
            throw new Error('ë™ì˜ìƒ IDë¥¼ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
          }

          // âœ… ë™ì˜ìƒ ì¸ë„¤ì¼ URL ê°€ì ¸ì˜¤ê¸° (Step 5 í‘œì‹œìš©)
          let videoThumbnailUrl = null;
          try {
            const thumbResponse = await fetch(
              `https://graph.facebook.com/${apiVersion}/${videoId}?fields=thumbnails&access_token=${encodeURIComponent(accessToken)}`
            );
            const thumbData = await thumbResponse.json();
            if (thumbData.thumbnails?.data?.length > 0) {
              // ê°€ì¥ í° ì¸ë„¤ì¼ ì„ íƒ
              const thumbnails = thumbData.thumbnails.data;
              const bestThumb = thumbnails.reduce((a, b) =>
                (a.width * a.height) > (b.width * b.height) ? a : b
              );
              videoThumbnailUrl = bestThumb.uri;
              console.log(`[UPLOAD] ë™ì˜ìƒ ì¸ë„¤ì¼ íšë“: ${videoThumbnailUrl}`);
            }
          } catch (thumbError) {
            console.warn(`[UPLOAD] ë™ì˜ìƒ ì¸ë„¤ì¼ ì¡°íšŒ ì‹¤íŒ¨:`, thumbError);
          }

          // âœ… [UX ê°œì„ ] ë°°ì¹˜ í˜¸í™˜ì„± ë°ì´í„° ì¶”ê°€
          const videoRatio = item.cropState?.aspectRatio || RATIO_9_16;
          const videoIs916 = Math.abs(videoRatio - RATIO_9_16) < RATIO_TOLERANCE;

          result = {
            id: item.id,
            type: 'video',
            hash: null,
            video_id: videoId,
            thumbnail_url: videoThumbnailUrl,  // ë™ì˜ìƒ ì¸ë„¤ì¼ URL ì €ì¥
            // ë°°ì¹˜ í˜¸í™˜ì„± ì •ë³´
            aspectRatio: videoRatio,
            placements: {
              reels: videoIs916,        // 9:16ë§Œ ë¦´ìŠ¤ ê°€ëŠ¥
              stories: videoIs916,      // 9:16ë§Œ ìŠ¤í† ë¦¬ ê°€ëŠ¥
              feed: true,               // ëª¨ë“  ë¹„ìœ¨ í”¼ë“œ ê°€ëŠ¥
              instream: videoIs916      // 9:16ë§Œ ì¸ìŠ¤íŠ¸ë¦¼ ê°€ëŠ¥
            }
          };
          console.log(`[PLACEMENT] ë™ì˜ìƒ ${item.name}: reels=${videoIs916}, ratio=${videoRatio.toFixed(4)}`);
        }

        uploadedResults.push(result);

        // í˜„ì¬ íŒŒì¼ ì™„ë£Œ ì²˜ë¦¬
        updateFileStatus(item.id, 'done');

        // ë§ˆì§€ë§‰ í•­ëª© ì—…ë¡œë“œ ì™„ë£Œ ì‹œ í”„ë¡œê·¸ë ˆìŠ¤ ë°” 100%
        if (i === mediaItems.length - 1) {
          updateUploadProgress(totalCount, totalCount, 'ì™„ë£Œ', null);
        }
      } catch (error) {
        console.error(`ë¯¸ë””ì–´ ${item.id} ì—…ë¡œë“œ ì‹¤íŒ¨:`, error);
        updateFileStatus(item.id, 'error');
        errors.push({
          id: item.id,
          name: item.name,
          error: error.message
        });
      }
    }
    
    if (errors.length > 0) {
      throw new Error(`${errors.length}ê°œ íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:\n${errors.map(e => `- ${e.name}: ${e.error}`).join('\n')}`);
    }
    
    // STEP 3ìœ¼ë¡œ ì´ë™
    const step1Data = JSON.parse(sessionStorage.getItem('admake_step1_state'));

    // Step 3ì—ì„œ ì‚¬ìš©í•  ë°ì´í„° ì €ì¥
    sessionStorage.setItem('admake_step2_results', JSON.stringify({
      accountId: accountId,
      results: uploadedResults,
      landingUrl: step1Data.landingUrl
    }));

    // Step 3 í˜¸í™˜ í¬ë§·ìœ¼ë¡œë„ ì €ì¥
    sessionStorage.setItem('admake_uploaded_results', JSON.stringify(uploadedResults));

    console.log('[UPLOAD] Step 3 ë°ì´í„° ì €ì¥ ì™„ë£Œ:', uploadedResults);

    showToast('ì—…ë¡œë“œ ì™„ë£Œ! STEP 3ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.', 'success');

    setTimeout(() => {
      window.location.href = `/admake/adcreate?account_id=${encodeURIComponent(accountId)}`;
    }, 1000);
    
  } catch (error) {
    console.error('ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
    if (confirm(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}\n\nì¬ì‹œë„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
      uploadBtn.disabled = false;
    } else {
      loadingOverlay.classList.remove('active');
    }
  } finally {
    if (uploadBtn.disabled) {
      loadingOverlay.classList.remove('active');
    }
  }
}

// âœ… [Instagram Reels] ë™ì˜ìƒ ë¹„ìœ¨ ì œí•œ ê²½ê³  í‘œì‹œ
function showVideoRatioWarning() {
  // ê¸°ì¡´ ê²½ê³  ì œê±°
  const existingWarning = document.getElementById('videoRatioWarning');
  if (existingWarning) existingWarning.remove();

  // ê²½ê³  íˆ´íŒ ìƒì„±
  const warning = document.createElement('div');
  warning.id = 'videoRatioWarning';
  warning.innerHTML = `
    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: rgba(220, 38, 38, 0.95); color: white; padding: 20px 28px;
                border-radius: 12px; z-index: 9999; text-align: center;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3); max-width: 320px;">
      <div style="font-size: 24px; margin-bottom: 8px;">âš ï¸</div>
      <div style="font-size: 15px; font-weight: 700; margin-bottom: 8px;">ì¸ìŠ¤íƒ€ê·¸ë¨ ë¦´ìŠ¤ ë¹„ìœ¨ ì œí•œ</div>
      <div style="font-size: 13px; line-height: 1.5; opacity: 0.95;">
        ë™ì˜ìƒì€ <strong>9:16 ë¹„ìœ¨</strong>ë§Œ ì§€ì›ë©ë‹ˆë‹¤.<br>
        4:5, 1:1 ë¹„ìœ¨ì€ ì¸ìŠ¤íƒ€ê·¸ë¨ ë¦´ìŠ¤ì—ì„œ ê±°ë¶€ë©ë‹ˆë‹¤.
      </div>
      <button onclick="this.parentElement.parentElement.remove()"
              style="margin-top: 16px; background: white; color: #dc2626; border: none;
                     padding: 8px 24px; border-radius: 6px; font-weight: 600; cursor: pointer;">
        í™•ì¸
      </button>
    </div>
  `;
  document.body.appendChild(warning);

  // 3ì´ˆ í›„ ìë™ ì œê±°
  setTimeout(() => {
    if (document.getElementById('videoRatioWarning')) {
      document.getElementById('videoRatioWarning').remove();
    }
  }, 3000);
}

// âœ… [Instagram Reels] í˜„ì¬ ë¯¸ë””ì–´ê°€ ë™ì˜ìƒì¸ì§€ í™•ì¸
function isCurrentMediaVideo() {
  if (selectedMediaIndex >= 0 && selectedMediaIndex < mediaItems.length) {
    return mediaItems[selectedMediaIndex].mediaType === 'video';
  }
  return false;
}

// âœ… ë¹„ìœ¨ ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡ (ê°€ë¡œ + ì„¸ë¡œ ë²„íŠ¼ ë™ê¸°í™”)
function setupRatioButtons() {
  // ëª¨ë“  ë¹„ìœ¨ ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ë“±ë¡ (ê°€ë¡œ, ì„¸ë¡œ ëª¨ë‘)
  const allRatioButtons = document.querySelectorAll('.admake-ratio-btn, .admake-ratio-btn-v');

  allRatioButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const ratioStr = btn.getAttribute('data-ratio');
      const ratio = eval(ratioStr); // "9/16" -> 0.5625, "4/5" -> 0.8, "1/1" -> 1

      // âœ… [UX ê°œì„ ] ë™ì˜ìƒë„ ëª¨ë“  ë¹„ìœ¨ í—ˆìš© - ì°¨ë‹¨ ì—†ì´ ì•ˆë‚´ë§Œ
      if (isCurrentMediaVideo() && Math.abs(ratio - RATIO_9_16) > RATIO_TOLERANCE) {
        console.log(`[FEED ONLY] ë™ì˜ìƒ í”¼ë“œ ì „ìš© ë¹„ìœ¨ ì„ íƒ: ${ratioStr}`);
      }

      console.log(`[DEBUG] ë¹„ìœ¨ ë²„íŠ¼ í´ë¦­: ${ratioStr} (${ratio})`);
      changeAspectRatio(ratio);

      // ëª¨ë“  ë²„íŠ¼ ìƒíƒœ ë™ê¸°í™”
      syncRatioButtonStates(ratioStr);
    });
  });
}

// âœ… ë¹„ìœ¨ ë²„íŠ¼ ìƒíƒœ ë™ê¸°í™” (ê°€ë¡œ/ì„¸ë¡œ ë²„íŠ¼ + ìº”ë²„ìŠ¤ í…Œë‘ë¦¬)
function syncRatioButtonStates(ratioStr) {
  const guideContainer = document.getElementById('guideContainer');

  // ê°€ë¡œ ë²„íŠ¼ ì—…ë°ì´íŠ¸
  document.querySelectorAll('.admake-ratio-btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.getAttribute('data-ratio') === ratioStr) {
      btn.classList.add('active');
    }
  });

  // ì„¸ë¡œ ë²„íŠ¼ ì—…ë°ì´íŠ¸
  document.querySelectorAll('.admake-ratio-btn-v').forEach(btn => {
    btn.classList.remove('active-916', 'active-45', 'active-11');
    if (btn.getAttribute('data-ratio') === ratioStr) {
      if (ratioStr === '9/16') btn.classList.add('active-916');
      else if (ratioStr === '4/5') btn.classList.add('active-45');
      else if (ratioStr === '1/1') btn.classList.add('active-11');
    }
  });

  // ìº”ë²„ìŠ¤ í…Œë‘ë¦¬ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
  if (guideContainer) {
    guideContainer.classList.remove('ratio-916', 'ratio-45', 'ratio-11');
    if (ratioStr === '9/16') guideContainer.classList.add('ratio-916');
    else if (ratioStr === '4/5') guideContainer.classList.add('ratio-45');
    else if (ratioStr === '1/1') guideContainer.classList.add('ratio-11');
  }
}

// âœ… ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', async () => {
  // Lucide ì•„ì´ì½˜ ì´ˆê¸°í™”
  lucide.createIcons();

  initCanvas();

  // ë¹„ìœ¨ ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡
  setupRatioButtons();

  // âœ… ì´ì „ ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡ (DOMContentLoaded ë‚´ë¶€ì—ì„œ í™•ì‹¤í•˜ê²Œ ë“±ë¡)
  const backBtn = document.getElementById('backBtn');
  if (backBtn) {
    backBtn.addEventListener('click', handleBackButton);
    console.log('[DEBUG] ì´ì „ ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡ ì™„ë£Œ');
  } else {
    console.error('[ERROR] backBtn ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
  }

  // Step 2 ì´ˆê¸°í™” (ë°ì´í„° ë³µêµ¬ ê°•í™”)
  await initStep2();

  // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¡œë“œ ì‹œë„
  if (mediaItems.length === 0) {
    await loadStep1Data();
  }

  // ì´ˆê¸° ê°€ì´ë“œë¼ì¸ í‘œì‹œ
  updateGuideLines();

  updateUploadButtonState(); // ì´ˆê¸° ë²„íŠ¼ ìƒíƒœ ì„¤ì •
});
</script>

</body>
</html>
