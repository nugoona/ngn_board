# 스냅샷 데이터 소스 및 기간 정리

## 명령어
```bash
python3 tools/ai_report_test/bq_monthly_snapshot.py piscess 2025 12 --save-to-gcs --force --use-current-month-events
```

## 기본 기간 설정
- **report_month**: `2025-12`
- **this_start ~ this_end**: `2025-12-01 ~ 2025-12-31` (12월 전체)
- **prev_start ~ prev_end**: `2025-11-01 ~ 2025-11-30` (11월 전체)
- **yoy_start ~ yoy_end**: `2024-12-01 ~ 2024-12-31` (작년 12월)
- **use_current_month_events = True**: 이벤트는 `report_month` (2025-12) 조회

---

## 섹션별 데이터 소스 및 기간

### 섹션 1: 지난달 매출 분석
| 데이터 필드 | 소스 | 기간 | 설명 |
|-----------|------|------|------|
| `mall_sales_this` | `mall_sales_monthly` 테이블 | **2025-12-01 ~ 2025-12-31** | 12월 매출 집계 |
| `mall_sales_prev` | `mall_sales_monthly` 테이블 | **2025-11-01 ~ 2025-11-30** | 11월 매출 집계 |
| `comparisons` | 계산된 값 | this vs prev, this vs yoy | 전월/전년 대비 비교 |
| `daily_this` | `daily_cafe24_sales` 테이블 | **2025-12-01 ~ 2025-12-31** | 12월 일별 매출 |
| `events` | `sheets_event_data` 테이블 | **2025-12** (동월 이벤트) | `--use-current-month-events` 플래그로 인해 12월 이벤트 조회 |

**⚠️ 주의**: `--use-current-month-events` 플래그가 없으면 이벤트는 **11월**을 조회합니다.

---

### 섹션 2: 주요 유입 채널
| 데이터 필드 | 소스 | 기간 | 설명 |
|-----------|------|------|------|
| `ga4_traffic_this` | `ga4_traffic_monthly` 테이블 | **2025-12-01 ~ 2025-12-31** | 12월 GA4 트래픽 집계 |
| `top_sources` | `ga4_traffic_monthly` 테이블 | **2025-12-01 ~ 2025-12-31** | 12월 상위 유입 소스 |

---

### 섹션 3: 고객 여정 (Funnel)
| 데이터 필드 | 소스 | 기간 | 설명 |
|-----------|------|------|------|
| `ga4_totals` | `ga4_traffic_monthly` 테이블 | **2025-12-01 ~ 2025-12-31** | 12월 GA4 총 사용자/이벤트 |
| `mall_sales_this` | `mall_sales_monthly` 테이블 | **2025-12-01 ~ 2025-12-31** | 12월 매출 데이터 |

---

### 섹션 4: 자사몰 베스트 상품
| 데이터 필드 | 소스 | 기간 | 설명 |
|-----------|------|------|------|
| `top_products` | `daily_cafe24_items` 테이블 | **2025-12-02 ~ 2025-12-31** (최근 30일 롤링) | `rolling_range(this_end, 30)` = 12월 31일 기준 역산 30일 |

**⚠️ 주의**: 섹션 4는 **12월 전체가 아닌 최근 30일 롤링** 데이터입니다.
- `rolling_range(2025-12-31, 30)` = `2025-12-02 ~ 2025-12-31`
- 12월 1일 데이터는 포함되지 않습니다.

---

### 섹션 5: 시장 트렌드 (29CM)
| 데이터 필드 | 소스 | 기간 | 설명 |
|-----------|------|------|------|
| `market_reviews` | `29cm_best` 크롤링 데이터 | **시점 불명확** | 29CM 베스트 상품 리뷰 (크롤링 시점 기준) |

**⚠️ 주의**: 29CM 크롤링 데이터는 스냅샷 생성 시점의 데이터이며, 특정 월에 고정되지 않습니다.

---

### 섹션 6: 매체 성과 및 효율 진단
| 데이터 필드 | 소스 | 기간 | 설명 |
|-----------|------|------|------|
| `meta_ads_goals_this` | `meta_ads_goals_monthly` 테이블 | **2025-12-01 ~ 2025-12-31** | 12월 Meta Ads 목표별 집계 |
| `top_ads` | `meta_ads_account_summary` 테이블 | **2025-12-01 ~ 2025-12-31** | 12월 상위 광고 |

---

### 섹션 7: 자사몰 vs 시장 비교
| 데이터 필드 | 소스 | 기간 | 설명 |
|-----------|------|------|------|
| `section_5_analysis` | AI 생성 (섹션 5 결과) | - | 섹션 5의 AI 분석 결과 |
| `top_products` | `daily_cafe24_items` 테이블 | **2025-12-02 ~ 2025-12-31** (최근 30일 롤링) | 섹션 4와 동일 (최근 30일 롤링) |

**⚠️ 주의**: 섹션 7의 `top_products`도 **최근 30일 롤링** 데이터입니다.

---

### 섹션 8: 익월 목표 설정 및 시장 전망
| 데이터 필드 | 소스 | 기간 | 설명 |
|-----------|------|------|------|
| `mall_sales_this` | `mall_sales_monthly` 테이블 | **2025-12-01 ~ 2025-12-31** | 12월 매출 데이터 |
| `forecast_next_month` | 계산된 예측값 | **2026-01** 예측 | 작년 동월(2025-01) 대비 예측 |

---

### 섹션 9: 종합 제안 (Action Cards)
| 데이터 필드 | 소스 | 기간 | 설명 |
|-----------|------|------|------|
| `mall_sales_this` | `mall_sales_monthly` 테이블 | **2025-12-01 ~ 2025-12-31** | 12월 매출 데이터 |
| `meta_ads_this` | `meta_ads_monthly` 테이블 | **2025-12-01 ~ 2025-12-31** | 12월 Meta Ads 데이터 |
| `ga4_totals` | `ga4_traffic_monthly` 테이블 | **2025-12-01 ~ 2025-12-31** | 12월 GA4 총 데이터 |
| `signals` | AI 생성 (섹션 1~8 결과) | - | 모든 섹션의 AI 분석 결과 |

---

## ⚠️ 12월 데이터가 아닌 항목

### 1. 섹션 4, 7: 최근 30일 롤링 데이터
- **기간**: `2025-12-02 ~ 2025-12-31` (12월 1일 제외)
- **이유**: `rolling_range(2025-12-31, 30)` 계산 결과
- **해결 방법**: 12월 전체를 포함하려면 `rolling_range(2025-12-31, 31)` 또는 월간 집계 사용

### 2. 섹션 5: 29CM 크롤링 데이터
- **기간**: 시점 불명확 (크롤링 시점 기준)
- **이유**: 29CM 크롤링은 특정 월에 고정되지 않음
- **해결 방법**: 크롤링 시점을 명확히 하거나, 월별 크롤링 데이터 저장 필요

### 3. 섹션 1: 이벤트 데이터 (플래그에 따라)
- **기본값 (플래그 없음)**: `2025-11` (전월 이벤트)
- **`--use-current-month-events` 플래그 사용 시**: `2025-12` (동월 이벤트)
- **이유**: 배포 후 자동 실행 시 전월 이벤트를 조회하도록 설계됨

---

## 권장 수정 사항

### 1. 섹션 4, 7: 롤링 기간 조정
```python
# 현재: rolling_range(this_end, 30) → 2025-12-02 ~ 2025-12-31
# 권장: rolling_range(this_end, 31) 또는 월간 집계 사용
```

### 2. 섹션 5: 29CM 크롤링 시점 명확화
- 크롤링 시점을 메타데이터에 저장
- 또는 월별 크롤링 데이터를 별도로 저장

### 3. 섹션 1: 이벤트 데이터 플래그 명확화
- `--use-current-month-events` 플래그 사용 시 동월 이벤트 조회 (현재 정상 작동)
- 플래그 없을 때는 전월 이벤트 조회 (의도된 동작)

