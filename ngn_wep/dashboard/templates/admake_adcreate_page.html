<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>STEP 3 - AdCanvas</title>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/favicon.ico') }}">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Fonts: Inter Tight (영문/숫자) + Pretendard (한글) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" rel="stylesheet">

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=1.4">

  <style>
    :root {
      --bg-primary: #09090B;
      --bg-secondary: #121215;
      --bg-tertiary: #1c1c1f;
      --bg-card: #18181B;
      --bg-card-hover: #1f1f23;
      --bg-input: #0d0d0f;
      --border-default: #27272A;
      --border-subtle: rgba(255, 255, 255, 0.06);
      --border-hover: rgba(255, 255, 255, 0.12);
      --border-focus: rgba(255, 255, 255, 0.2);
      --text-primary: #ffffff;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      --accent-blue: #3b82f6;
      --accent-emerald: #10b981;
      --accent-gold: #f59e0b;
      --accent-red: #ef4444;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg-primary);
      font-family: 'Pretendard', 'Inter Tight', -apple-system, BlinkMacSystemFont, sans-serif;
      letter-spacing: -0.02em;
      height: 100vh;
      overflow: hidden;
      color: var(--text-primary);
    }

    /* ===== 전역 스크롤바 - Minimalist Style ===== */
    ::-webkit-scrollbar {
      width: 5px;
      height: 5px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border-default);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #3f3f46;
    }

    ::-webkit-scrollbar-corner {
      background: transparent;
    }

    /* Firefox */
    * {
      scrollbar-width: thin;
      scrollbar-color: var(--border-default) transparent;
    }

    .font-inter {
      font-family: 'Inter Tight', sans-serif;
      letter-spacing: 0;
    }

    /* ===== 네비게이션 오버라이드 ===== */
    .nav-buttons {
      background: var(--bg-primary) !important;
      border-bottom: 1px solid var(--border-default) !important;
      height: 56px;
      flex-shrink: 0;
    }

    .nav-buttons .updated-at-text {
      color: var(--text-primary) !important;
      font-family: 'Inter Tight', sans-serif !important;
      font-weight: 700 !important;
      letter-spacing: 0.1em !important;
    }

    .hamburger-icon div {
      background: var(--text-primary) !important;
    }

    .hamburger-dropdown {
      background: var(--bg-secondary) !important;
      border: 1px solid var(--border-default) !important;
    }

    .hamburger-dropdown a {
      color: var(--text-secondary) !important;
    }

    .hamburger-dropdown a:hover {
      background: var(--bg-card) !important;
      color: var(--text-primary) !important;
    }

    /* ===== 이탈 경고 모달 ===== */
    .exit-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(4px); z-index: 10001; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
    .exit-modal-overlay.show { opacity: 1; visibility: visible; }
    .exit-modal { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 16px; width: 90%; max-width: 380px; padding: 32px; transform: scale(0.95); transition: transform 0.3s ease; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
    .exit-modal-overlay.show .exit-modal { transform: scale(1); }
    .exit-modal-icon { width: 56px; height: 56px; margin: 0 auto 20px; background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(239, 68, 68, 0.1) 100%); border-radius: 14px; display: flex; align-items: center; justify-content: center; }
    .exit-modal-icon svg { width: 28px; height: 28px; color: var(--accent-red); }
    .exit-modal-title { font-size: 18px; font-weight: 700; color: var(--text-primary); text-align: center; margin-bottom: 12px; }
    .exit-modal-desc { font-size: 14px; color: var(--text-secondary); text-align: center; margin-bottom: 28px; line-height: 1.6; }
    .exit-modal-actions { display: flex; gap: 12px; }
    .exit-modal-btn { flex: 1; padding: 14px 20px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; border: none; }
    .exit-modal-btn.btn-cancel { background: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border-subtle); }
    .exit-modal-btn.btn-cancel:hover { background: var(--bg-card-hover); color: var(--text-primary); }
    .exit-modal-btn.btn-confirm { background: var(--accent-red); color: #ffffff; }
    .exit-modal-btn.btn-confirm:hover { background: #dc2626; }

    /* ===== Progress Bar (Refined Minimal Style) ===== */
    .admake-progress-bar {
      position: sticky;
      top: 56px;
      z-index: 100;
      background: linear-gradient(180deg, #0A0A0B 0%, #09090B 100%);
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      padding: 28px 40px;
      flex-shrink: 0;
    }

    .admake-progress-steps {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0;
      max-width: 860px;
      margin: 0 auto;
    }

    .admake-progress-step {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 12px 16px;
      border-radius: 8px;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      background: transparent;
      min-width: 90px;
    }

    .admake-progress-step .step-icon {
      display: none;
      width: 18px;
      height: 18px;
    }

    .admake-progress-step .step-number {
      font-family: 'Inter Tight', sans-serif;
      font-size: 10px;
      font-weight: 700;
      color: #3F3F46;
      letter-spacing: 0.08em;
      transition: all 0.4s ease;
      text-transform: uppercase;
    }

    .admake-progress-step .step-label {
      font-family: 'Pretendard', sans-serif;
      font-size: 12px;
      font-weight: 500;
      color: #3F3F46;
      white-space: nowrap;
      transition: all 0.4s ease;
    }

    /* ===== Completed State ===== */
    .admake-progress-step.completed {
      background: rgba(16, 185, 129, 0.12);
      border: 1px solid rgba(16, 185, 129, 0.25);
    }

    .admake-progress-step.completed .step-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      color: #34D399;
    }

    .admake-progress-step.completed .step-icon i {
      width: 16px;
      height: 16px;
      stroke-width: 2.5;
    }

    .admake-progress-step.completed .step-number {
      display: none;
    }

    .admake-progress-step.completed .step-label {
      color: #6EE7B7;
      font-weight: 500;
    }

    /* ===== Active State ===== */
    .admake-progress-step.active {
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.1),
                  0 4px 16px rgba(0, 0, 0, 0.2);
    }

    .admake-progress-step.active .step-number {
      color: #18181B;
      font-weight: 800;
    }

    .admake-progress-step.active .step-label {
      color: #09090B;
      font-weight: 600;
    }

    /* ===== Pending State ===== */
    .admake-progress-step:not(.completed):not(.active) {
      background: transparent;
      border: 1px dashed #27272A;
    }

    .admake-progress-step:not(.completed):not(.active) .step-number {
      color: #52525B;
    }

    .admake-progress-step:not(.completed):not(.active) .step-label {
      color: #52525B;
    }

    /* ===== Connector Lines ===== */
    .admake-progress-connector {
      display: flex;
      align-items: center;
      padding: 0 6px;
      transition: all 0.4s ease;
    }

    .admake-progress-connector-line {
      width: 28px;
      height: 2px;
      background: #27272A;
      border-radius: 1px;
      transition: all 0.4s ease;
    }

    .admake-progress-connector.completed .admake-progress-connector-line {
      background: linear-gradient(90deg, #10B981 0%, #34D399 100%);
    }

    /* Hide old dot element */
    .admake-progress-connector-dot {
      display: none;
    }

    /* ===== 메인 레이아웃 ===== */
    .admake-main-wrapper {
      display: flex;
      padding-top: 65px;
      height: calc(100vh - 56px - 105px - 72px);
      overflow: hidden;
    }

    /* ===== 좌측 패널: 편집 영역 ===== */
    .admake-edit-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      padding: 24px;
      gap: 20px;
    }

    /* ===== 광고 유형 선택 ===== */
    .admake-type-selector {
      display: flex;
      gap: 12px;
      padding: 16px 20px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-default);
      border-radius: 12px;
    }

    .admake-type-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 14px 20px;
      background: transparent;
      border: 1px solid var(--border-default);
      border-radius: 8px;
      color: var(--text-secondary);
      font-family: 'Inter Tight', sans-serif;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.02em;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .admake-type-btn:hover {
      background: var(--bg-card);
      border-color: var(--border-hover);
      color: var(--text-primary);
    }

    .admake-type-btn.active {
      background: var(--accent-blue);
      border-color: var(--accent-blue);
      color: #ffffff;
    }

    .admake-type-btn i {
      width: 20px;
      height: 20px;
    }

    /* ===== 소재 선택 그리드 ===== */
    .admake-media-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border-default);
      border-radius: 12px;
      padding: 20px;
    }

    .admake-section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .admake-section-number {
      font-family: 'Inter Tight', sans-serif;
      font-size: 11px;
      font-weight: 700;
      color: var(--accent-blue);
      background: rgba(59, 130, 246, 0.1);
      padding: 4px 8px;
      border-radius: 4px;
    }

    .admake-section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .admake-section-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin-left: auto;
    }

    .admake-media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 12px;
    }

    .admake-media-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s ease;
    }

    .admake-media-item:hover {
      border-color: var(--border-hover);
    }

    .admake-media-item.selected {
      border-color: var(--accent-blue);
    }

    .admake-media-item img,
    .admake-media-item video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .admake-media-badge {
      position: absolute;
      top: 6px;
      left: 6px;
      width: 22px;
      height: 22px;
      background: var(--accent-blue);
      color: #ffffff;
      font-family: 'Inter Tight', sans-serif;
      font-size: 11px;
      font-weight: 700;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transform: scale(0.8);
      transition: all 0.2s ease;
    }

    .admake-media-item.selected .admake-media-badge {
      opacity: 1;
      transform: scale(1);
    }

    .admake-media-type-icon {
      position: absolute;
      bottom: 6px;
      right: 6px;
      width: 20px;
      height: 20px;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
    }

    .admake-media-type-icon i {
      width: 12px;
      height: 12px;
    }

    /* ===== 마스터 편집기 ===== */
    .admake-master-editor {
      background: var(--bg-secondary);
      border: 1px solid var(--border-default);
      border-radius: 12px;
      padding: 20px;
    }

    .admake-editor-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .admake-editor-grid.full-width {
      grid-template-columns: 1fr;
    }

    .admake-field-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .admake-field-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .admake-field-label i {
      width: 14px;
      height: 14px;
      color: var(--text-muted);
    }

    .admake-field-input {
      width: 100%;
      padding: 12px 14px;
      background: var(--bg-input);
      border: 1px solid var(--border-default);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: 'Pretendard', sans-serif;
      font-size: 13px;
      transition: all 0.2s ease;
    }

    .admake-field-input:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .admake-field-input::placeholder {
      color: var(--text-muted);
    }

    /* 광고 이름 접두사 스타일 */
    .admake-name-input-wrapper {
      display: flex;
      align-items: center;
      gap: 0;
      background: var(--surface-secondary);
      border: 1px solid var(--border-default);
      border-radius: 8px;
      overflow: hidden;
    }

    .admake-name-prefix {
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 600;
      color: #10b981;
      background: rgba(16, 185, 129, 0.1);
      white-space: nowrap;
      border-right: 1px solid var(--border-default);
    }

    .admake-name-input-wrapper .admake-field-input {
      border: none;
      border-radius: 0;
      flex: 1;
    }

    .admake-name-input-wrapper .admake-field-input:focus {
      box-shadow: none;
    }

    .admake-field-textarea {
      min-height: 80px;
      resize: vertical;
    }

    .admake-field-select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2352525b' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 40px;
    }

    /* ===== 제품 표시 (Product Tags) 섹션 ===== */
    .admake-product-tags-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border-default);
      border-radius: 12px;
      padding: 20px;
      transition: opacity 0.3s ease;
    }
    .admake-product-tags-section.disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    .product-tags-content {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .product-tags-toggle {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
      flex-shrink: 0;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: var(--bg-tertiary);
      border-radius: 24px;
      transition: 0.3s;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      border-radius: 50%;
      transition: 0.3s;
    }
    .toggle-switch input:checked + .toggle-slider {
      background-color: var(--primary);
    }
    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }
    .toggle-label {
      color: var(--text-secondary);
      font-size: 14px;
    }
    .product-tags-selector {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px;
      background: var(--bg-card);
      border-radius: 8px;
      border: 1px solid var(--border-default);
    }
    .selector-options {
      display: flex;
      gap: 20px;
    }
    .radio-option {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-primary);
    }
    .radio-option input[type="radio"] {
      width: 16px;
      height: 16px;
      accent-color: var(--primary);
    }
    .existing-set-selector {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .existing-set-selector select {
      flex: 1;
    }
    .refresh-sets-btn, .clear-set-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border: 1px solid var(--border-default);
      border-radius: 8px;
      background: var(--bg-secondary);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }
    .refresh-sets-btn:hover, .clear-set-btn:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    .refresh-sets-btn.loading {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .new-set-selector {
      display: flex;
    }
    .new-set-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .new-set-btn:hover {
      background: var(--primary-hover);
    }
    .selected-set-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid var(--primary);
      border-radius: 8px;
    }
    .set-info-badge {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .set-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 14px;
    }
    .set-count {
      font-size: 12px;
      color: var(--text-tertiary);
    }

    /* ===== 제품세트 만들기 모달 ===== */
    .product-set-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .product-set-modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .product-set-modal {
      background: var(--bg-primary);
      border-radius: 16px;
      width: 90%;
      max-width: 680px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      transform: scale(0.9) translateY(20px);
      transition: transform 0.3s ease;
    }
    .product-set-modal-overlay.active .product-set-modal {
      transform: scale(1) translateY(0);
    }
    .product-set-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-default);
    }
    .product-set-modal-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .modal-close-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      color: var(--text-tertiary);
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .modal-close-btn:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    .product-set-modal-tabs {
      display: flex;
      gap: 4px;
      padding: 12px 24px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-default);
    }
    .modal-tab {
      padding: 10px 20px;
      border: none;
      background: transparent;
      color: var(--text-tertiary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .modal-tab:hover {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
    }
    .modal-tab.active {
      background: var(--primary);
      color: white;
    }
    .modal-tab-content {
      display: none;
      flex-direction: column;
      gap: 16px;
      padding: 20px 24px;
      overflow-y: auto;
      flex: 1;
      min-height: 300px;
      max-height: 400px;
    }
    .modal-tab-content.active {
      display: flex;
    }
    .modal-input-row {
      display: flex;
      gap: 8px;
    }
    .modal-input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid var(--border-default);
      border-radius: 8px;
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: 14px;
    }
    .modal-input:focus {
      outline: none;
      border-color: var(--primary);
    }
    .modal-select {
      padding: 10px 14px;
      border: 1px solid var(--border-default);
      border-radius: 8px;
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: 14px;
      min-width: 120px;
    }
    .modal-action-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      border: none;
      background: var(--primary);
      color: white;
      font-size: 14px;
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.2s;
    }
    .modal-action-btn:hover {
      background: var(--primary-hover);
    }
    .modal-action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .modal-loading {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: var(--bg-secondary);
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: 13px;
    }
    .modal-loading .loading-spinner.small {
      width: 18px;
      height: 18px;
      border-width: 2px;
    }
    .modal-product-list, .modal-search-results, .modal-selected-products {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .modal-list-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
      color: var(--text-secondary);
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    .checkbox-label input {
      width: 16px;
      height: 16px;
      accent-color: var(--primary);
    }
    .selected-count {
      font-size: 12px;
      color: var(--text-tertiary);
    }
    .modal-product-table {
      max-height: 180px;
      overflow-y: auto;
      border: 1px solid var(--border-default);
      border-radius: 8px;
      background: var(--bg-card);
    }
    .modal-product-table .empty-state {
      padding: 30px;
      text-align: center;
      color: var(--text-tertiary);
      font-size: 13px;
    }
    .modal-product-row {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border-default);
      font-size: 13px;
    }
    .modal-product-row:last-child {
      border-bottom: none;
    }
    .modal-product-row input[type="checkbox"] {
      width: 16px;
      height: 16px;
      margin-right: 10px;
      accent-color: var(--primary);
    }
    .modal-product-row .product-name {
      flex: 1;
      color: var(--text-primary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .modal-product-row .product-no {
      color: var(--text-tertiary);
      font-size: 12px;
      margin-left: 12px;
    }
    .modal-product-row .add-btn, .modal-product-row .remove-btn {
      padding: 4px 10px;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      margin-left: 10px;
    }
    .modal-product-row .add-btn {
      background: var(--primary);
      color: white;
    }
    .modal-product-row .add-btn:disabled {
      background: var(--bg-tertiary);
      color: var(--text-tertiary);
      cursor: not-allowed;
    }
    .modal-product-row .remove-btn {
      background: var(--accent-red);
      color: white;
    }
    .product-set-modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border-default);
      background: var(--bg-secondary);
      border-radius: 0 0 16px 16px;
    }
    .modal-setname-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .modal-setname-row label {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      white-space: nowrap;
    }
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    .modal-cancel-btn {
      padding: 10px 20px;
      border: 1px solid var(--border-default);
      background: var(--bg-card);
      color: var(--text-secondary);
      font-size: 14px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .modal-cancel-btn:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    .modal-submit-btn {
      padding: 10px 24px;
      border: none;
      background: var(--primary);
      color: white;
      font-size: 14px;
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .modal-submit-btn:hover {
      background: var(--primary-hover);
    }
    .modal-submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ===== 개별 카드 편집기 ===== */
    .admake-cards-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border-default);
      border-radius: 12px;
      padding: 20px;
    }

    .admake-card-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-height: 400px;
      overflow-y: auto;
    }

    .admake-card-item {
      background: var(--bg-card);
      border: 1px solid var(--border-default);
      border-radius: 10px;
      padding: 16px;
    }

    .admake-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 14px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .admake-card-thumb {
      width: 48px;
      height: 48px;
      border-radius: 6px;
      overflow: hidden;
      flex-shrink: 0;
    }

    .admake-card-thumb img,
    .admake-card-thumb video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .admake-card-info {
      flex: 1;
      min-width: 0;
    }

    .admake-card-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .admake-card-meta {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .admake-card-index {
      font-family: 'Inter Tight', sans-serif;
      font-size: 12px;
      font-weight: 700;
      color: var(--accent-blue);
      background: rgba(59, 130, 246, 0.1);
      padding: 4px 10px;
      border-radius: 4px;
    }

    /* 필드 with 자물쇠 */
    .admake-field-with-lock {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .admake-field-with-lock .admake-field-input {
      flex: 1;
    }

    .admake-lock-btn {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-input);
      border: 1px solid var(--border-default);
      border-radius: 6px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .admake-lock-btn:hover {
      background: var(--bg-card-hover);
      color: var(--text-secondary);
    }

    .admake-lock-btn.locked {
      color: var(--accent-blue);
      background: rgba(59, 130, 246, 0.1);
      border-color: rgba(59, 130, 246, 0.3);
    }

    .admake-lock-btn i {
      width: 16px;
      height: 16px;
    }

    /* ===== 우측 패널: 미리보기 ===== */
    .admake-preview-panel {
      width: 420px;
      flex-shrink: 0;
      background: var(--bg-secondary);
      border-left: 1px solid var(--border-default);
      display: flex;
      flex-direction: column;
    }

    .admake-preview-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-default);
    }

    .admake-preview-tabs {
      display: flex;
      gap: 4px;
      background: var(--bg-card);
      padding: 4px;
      border-radius: 8px;
    }

    .admake-preview-tab {
      flex: 1;
      padding: 10px 12px;
      background: transparent;
      border: none;
      border-radius: 6px;
      color: var(--text-secondary);
      font-family: 'Inter Tight', sans-serif;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.02em;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .admake-preview-tab:hover {
      color: var(--text-primary);
    }

    .admake-preview-tab.active {
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .admake-preview-content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      position: relative;
      /* 커스텀 스크롤바 */
      scrollbar-width: thin;
      scrollbar-color: var(--border-default) transparent;
    }

    .admake-preview-content::-webkit-scrollbar {
      width: 6px;
    }

    .admake-preview-content::-webkit-scrollbar-track {
      background: transparent;
    }

    .admake-preview-content::-webkit-scrollbar-thumb {
      background: var(--border-default);
      border-radius: 3px;
    }

    .admake-preview-content::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* 미리보기 래퍼 - 로딩 트랜지션용 */
    .admake-preview-wrapper {
      position: relative;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .admake-preview-frame {
      background: var(--bg-primary); /* 페이지 배경과 동일 */
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
      transition: filter 0.3s ease, opacity 0.3s ease;
      display: inline-block;
    }

    /* 로딩 중 블러 효과 */
    .admake-preview-frame.loading {
      filter: blur(8px);
      opacity: 0.6;
    }

    /* iframe 스타일 */
    .admake-preview-frame iframe {
      border: none;
      display: block;
      background: var(--bg-primary); /* 페이지 배경과 동일 */
    }

    /* 로딩 오버레이 */
    .admake-preview-loader {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .admake-preview-loader.active {
      display: flex;
    }

    .admake-preview-loader-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border-default);
      border-top-color: var(--accent-blue);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .admake-preview-loader-text {
      font-size: 11px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .admake-preview-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      color: var(--text-muted);
      text-align: center;
    }

    .admake-preview-placeholder i {
      width: 48px;
      height: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .admake-preview-placeholder p {
      font-size: 13px;
      margin: 0;
    }

    .admake-preview-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
    }

    .admake-preview-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border-default);
      border-top-color: var(--accent-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .admake-preview-error {
      padding: 20px;
      text-align: center;
      color: var(--accent-red);
      font-size: 12px;
    }

    /* ===== 하단 액션 바 ===== */
    .admake-action-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 72px;
      background: linear-gradient(180deg, rgba(18, 18, 21, 0.95) 0%, var(--bg-secondary) 100%);
      border-top: 1px solid var(--border-default);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 32px;
      z-index: 1000;
      backdrop-filter: blur(12px);
    }

    .admake-action-left {
      font-family: 'Inter Tight', sans-serif;
      font-size: 11px;
      color: var(--text-muted);
      letter-spacing: 0.06em;
      font-weight: 500;
    }

    .admake-action-buttons {
      display: flex;
      gap: 10px;
    }

    .admake-btn {
      font-family: 'Inter Tight', sans-serif;
      padding: 12px 28px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.02em;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.25s;
      text-transform: uppercase;
    }

    .admake-btn-secondary {
      background: var(--bg-card);
      color: var(--text-secondary);
      border: 1px solid var(--border-default);
    }

    .admake-btn-secondary:hover {
      background: var(--bg-card-hover);
      border-color: var(--border-hover);
      color: var(--text-primary);
    }

    .admake-btn-primary {
      background: #f5f5f5;
      color: #1a1a1a;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    .admake-btn-primary:hover:not(:disabled) {
      background: #ffffff;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5);
      transform: translateY(-1px);
    }

    .admake-btn-primary:disabled {
      opacity: 0.25;
      cursor: not-allowed;
      box-shadow: none;
    }

    /* ===== 커스텀 토스트 알림 (세련된 디자인) ===== */
    .admake-toast-container {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }

    .admake-toast {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      background: linear-gradient(135deg, rgba(45, 45, 50, 0.95) 0%, rgba(35, 35, 40, 0.98) 100%);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 12px;
      box-shadow:
        0 4px 6px rgba(0, 0, 0, 0.3),
        0 10px 30px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      pointer-events: auto;
      animation: toastSlideIn 0.35s cubic-bezier(0.21, 1.02, 0.73, 1);
      max-width: 420px;
      min-width: 280px;
    }

    .admake-toast.toast-out {
      animation: toastSlideOut 0.25s ease forwards;
    }

    @keyframes toastSlideIn {
      from { opacity: 0; transform: translateY(-20px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    @keyframes toastSlideOut {
      from { opacity: 1; transform: translateY(0) scale(1); }
      to { opacity: 0; transform: translateY(-10px) scale(0.95); }
    }

    .admake-toast-icon {
      font-size: 18px;
      flex-shrink: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      font-weight: 600;
    }
    .admake-toast-message { font-size: 13px; font-weight: 500; color: #ffffff; line-height: 1.5; }
    .admake-toast-close {
      background: rgba(255, 255, 255, 0.08);
      border: none;
      color: rgba(255, 255, 255, 0.5);
      cursor: pointer;
      padding: 6px;
      margin-left: auto;
      font-size: 14px;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .admake-toast-close:hover {
      background: rgba(255, 255, 255, 0.15);
      color: #ffffff;
    }

    /* Toast 타입별 스타일 */
    .admake-toast.toast-info {
      border-left: 4px solid #3b82f6;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(35, 35, 45, 0.98) 30%);
    }
    .admake-toast.toast-info .admake-toast-icon {
      background: rgba(59, 130, 246, 0.2);
      color: #60a5fa;
    }

    .admake-toast.toast-success {
      border-left: 4px solid #10b981;
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(35, 35, 45, 0.98) 30%);
    }
    .admake-toast.toast-success .admake-toast-icon {
      background: rgba(16, 185, 129, 0.2);
      color: #34d399;
    }

    .admake-toast.toast-warning {
      border-left: 4px solid #f59e0b;
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(35, 35, 45, 0.98) 30%);
    }
    .admake-toast.toast-warning .admake-toast-icon {
      background: rgba(245, 158, 11, 0.2);
      color: #fbbf24;
    }

    .admake-toast.toast-error {
      border-left: 4px solid #ef4444;
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(35, 35, 45, 0.98) 30%);
    }
    .admake-toast.toast-error .admake-toast-icon {
      background: rgba(239, 68, 68, 0.2);
      color: #f87171;
    }

    /* ===== 숨김 클래스 ===== */
    .hidden { display: none !important; }

    /* ===== 저장된 광고 목록 영역 ===== */
    .saved-ads-container {
      position: fixed;
      bottom: 70px;
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-default);
      padding: 12px 20px;
      z-index: 100;
      transition: all 0.3s ease;
    }

    .saved-ads-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .saved-ads-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .saved-ads-count {
      font-size: 11px;
      color: var(--accent-emerald);
      font-weight: 600;
    }

    .saved-ads-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      max-height: 80px;
      overflow-y: auto;
    }

    .saved-ads-list::-webkit-scrollbar {
      height: 4px;
    }

    .saved-ads-list::-webkit-scrollbar-thumb {
      background: var(--border-hover);
      border-radius: 2px;
    }

    .saved-ad-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-default);
      border-radius: 6px;
      font-size: 12px;
      animation: fadeSlideIn 0.25s ease;
    }

    @keyframes fadeSlideIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .saved-ad-type {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .saved-ad-type.type-image { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .saved-ad-type.type-video { background: rgba(168, 85, 247, 0.2); color: #c084fc; }
    .saved-ad-type.type-carousel { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }

    .saved-ad-name {
      color: var(--text-primary);
      font-weight: 500;
      max-width: 150px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .saved-ad-delete {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.15s ease;
    }

    .saved-ad-delete:hover {
      background: rgba(239, 68, 68, 0.15);
      color: var(--accent-red);
    }

    .saved-ads-empty {
      color: var(--text-muted);
      font-size: 12px;
      text-align: center;
      padding: 8px;
    }

    /* 저장된 광고 있을 때 액션바 여백 조정 */
    body.has-saved-ads .admake-action-bar {
      bottom: 0;
    }

    body.has-saved-ads .admake-preview-panel {
      padding-bottom: 150px;
    }

    /* ===== 마스터 설정 리셋 버튼 ===== */
    .master-reset-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
      margin-left: 8px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.15s ease;
    }

    .master-reset-btn:hover {
      background: rgba(239, 68, 68, 0.15);
      color: var(--accent-red);
    }

    .master-reset-btn svg {
      width: 14px;
      height: 14px;
    }

    /* ===== 최종 확인 모달 ===== */
    .confirm-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 9998;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.25s ease;
    }

    .confirm-modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .confirm-modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border-default);
      border-radius: 12px;
      width: 90%;
      max-width: 480px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      transform: scale(0.95) translateY(10px);
      transition: transform 0.25s ease;
    }

    .confirm-modal-overlay.active .confirm-modal {
      transform: scale(1) translateY(0);
    }

    .confirm-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-default);
    }

    .confirm-modal-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .confirm-modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.15s ease;
    }

    .confirm-modal-close:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .confirm-modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .confirm-summary {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
    }

    .confirm-summary-item {
      text-align: center;
      flex: 1;
    }

    .confirm-summary-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--accent-emerald);
    }

    .confirm-summary-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .confirm-ads-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .confirm-ad-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      background: var(--bg-primary);
      border: 1px solid var(--border-default);
      border-radius: 8px;
    }

    .confirm-ad-index {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-tertiary);
      border-radius: 50%;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .confirm-ad-info {
      flex: 1;
      min-width: 0;
    }

    .confirm-ad-name {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .confirm-ad-meta {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .confirm-modal-footer {
      display: flex;
      gap: 10px;
      padding: 16px 20px;
      border-top: 1px solid var(--border-default);
    }

    .confirm-modal-footer .admake-btn {
      flex: 1;
    }
  </style>
</head>
<body>

<script>
  var userCompanyList = {{ session['company_names'] | tojson }};
  var currentUserId = "{{ session['user_id'] }}";
  var accountId = "{{ account_id }}";
  // metaAdsState 초기화 (제품 표시 기능에서 사용)
  window.metaAdsState = window.metaAdsState || {
    accountId: accountId,
    catalogId: null,
    company: null
  };
</script>
<script src="{{ url_for('static', filename='js/mobile_detection.js') }}"></script>

<!-- 이탈 경고 모달 -->
<div class="exit-modal-overlay" id="exitModalOverlay">
  <div class="exit-modal">
    <div class="exit-modal-icon">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
    </div>
    <div class="exit-modal-title">페이지를 나가시겠습니까?</div>
    <div class="exit-modal-desc">현재 진행 중인 광고 제작 내용이<br><strong style="color: var(--accent-red);">모두 삭제</strong>됩니다.</div>
    <div class="exit-modal-actions">
      <button class="exit-modal-btn btn-cancel" id="exitCancelBtn">계속 작업하기</button>
      <button class="exit-modal-btn btn-confirm" id="exitConfirmBtn">나가기</button>
    </div>
  </div>
</div>

<!-- 네비게이션 -->
<div class="nav-buttons">
  <div class="nav-left">
    <div id="updatedAtText" class="updated-at-text">AdCanvas</div>
  </div>
  <div class="nav-right">
    <div class="hamburger-menu-wrapper">
      <div class="hamburger-icon" id="hamburgerIcon">
        <div></div><div></div><div></div>
      </div>
      <div class="hamburger-dropdown" id="hamburgerDropdown">
        <a href="/" data-exit-link="true">사이트 성과</a>
        <a href="{{ url_for('ads_page') }}" data-exit-link="true">광고 성과</a>
        <a href="{{ url_for('trend_selection_page') }}" data-exit-link="true">TREND</a>
        <a href="{{ url_for('auth.logout') }}">로그아웃</a>
      </div>
    </div>
  </div>
</div>

<!-- Progress Bar (Refined Minimal Style) -->
<div class="admake-progress-bar">
  <div class="admake-progress-steps">
    <div class="admake-progress-step completed">
      <span class="step-icon"><i data-lucide="check"></i></span>
      <span class="step-number font-inter">STEP 1</span>
      <span class="step-label">미디어 업로드</span>
    </div>
    <div class="admake-progress-connector completed">
      <span class="admake-progress-connector-line"></span>
    </div>
    <div class="admake-progress-step completed">
      <span class="step-icon"><i data-lucide="check"></i></span>
      <span class="step-number font-inter">STEP 2</span>
      <span class="step-label">가이드로 자르기</span>
    </div>
    <div class="admake-progress-connector completed">
      <span class="admake-progress-connector-line"></span>
    </div>
    <div class="admake-progress-step active">
      <span class="step-number font-inter">STEP 3</span>
      <span class="step-label">광고 생성</span>
    </div>
    <div class="admake-progress-connector">
      <span class="admake-progress-connector-line"></span>
    </div>
    <div class="admake-progress-step">
      <span class="step-number font-inter">STEP 4</span>
      <span class="step-label">사전 세팅</span>
    </div>
    <div class="admake-progress-connector">
      <span class="admake-progress-connector-line"></span>
    </div>
    <div class="admake-progress-step">
      <span class="step-number font-inter">STEP 5</span>
      <span class="step-label">검토 및 생성</span>
    </div>
  </div>
</div>

<!-- 메인 컨텐츠 -->
<div class="admake-main-wrapper">

  <!-- 좌측: 편집 패널 -->
  <div class="admake-edit-panel">

    <!-- 광고 유형 선택 -->
    <div class="admake-type-selector">
      <button class="admake-type-btn active" id="typeSingleImage" data-type="single_image">
        <i data-lucide="image"></i>
        <span>단일 이미지</span>
      </button>
      <button class="admake-type-btn" id="typeSingleVideo" data-type="single_video">
        <i data-lucide="video"></i>
        <span>단일 동영상</span>
      </button>
      <button class="admake-type-btn" id="typeSlide" data-type="slide">
        <i data-lucide="layers"></i>
        <span>슬라이드</span>
      </button>
    </div>

    <!-- 소재 선택 -->
    <div class="admake-media-section">
      <div class="admake-section-header">
        <span class="admake-section-number font-inter">01</span>
        <span class="admake-section-title">소재 선택</span>
        <span class="admake-section-subtitle" id="mediaSelectionHint">1개 선택</span>
      </div>
      <div class="admake-media-grid" id="mediaGrid">
        <!-- 동적으로 생성 -->
      </div>
    </div>

    <!-- 마스터 편집기 -->
    <div class="admake-master-editor">
      <div class="admake-section-header">
        <span class="admake-section-number font-inter">02</span>
        <span class="admake-section-title">마스터 설정</span>
        <button type="button" class="master-reset-btn" id="masterResetBtn" title="마스터 설정 초기화">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
        </button>
        <span class="admake-section-subtitle">모든 카드에 일괄 적용</span>
      </div>

      <div class="admake-editor-grid">
        <div class="admake-field-group">
          <label class="admake-field-label">
            <i data-lucide="tag"></i>
            광고 이름
          </label>
          <div class="admake-name-input-wrapper">
            <span class="admake-name-prefix" id="adNamePrefix">[20260115][단일]</span>
            <input type="text" class="admake-field-input font-inter" id="masterAdName" placeholder="광고명 입력">
          </div>
        </div>

        <div class="admake-field-group">
          <label class="admake-field-label">
            <i data-lucide="link"></i>
            랜딩페이지 URL
          </label>
          <input type="url" class="admake-field-input font-inter" id="masterUrl" placeholder="https://example.com">
        </div>

        <div class="admake-field-group">
          <label class="admake-field-label">
            <i data-lucide="mouse-pointer-click"></i>
            버튼 형식
          </label>
          <select class="admake-field-input admake-field-select" id="masterCta">
            <option value="SHOP_NOW">지금 구매하기</option>
            <option value="LEARN_MORE">더 알아보기</option>
            <option value="SIGN_UP">가입하기</option>
            <option value="BOOK_TRAVEL">지금 예약하기</option>
            <option value="CONTACT_US">문의하기</option>
            <option value="DOWNLOAD">다운로드</option>
            <option value="GET_OFFER">할인받기</option>
            <option value="GET_QUOTE">견적받기</option>
            <option value="SUBSCRIBE">구독하기</option>
            <option value="WATCH_MORE">더 보기</option>
          </select>
        </div>
      </div>

      <div class="admake-editor-grid full-width" style="margin-top: 16px;">
        <div class="admake-field-group">
          <label class="admake-field-label">
            <i data-lucide="align-left"></i>
            주요문구
          </label>
          <textarea class="admake-field-input admake-field-textarea" id="masterPrimaryText" placeholder="광고 본문을 입력하세요..."></textarea>
        </div>

        <div class="admake-field-group">
          <label class="admake-field-label">
            <i data-lucide="heading"></i>
            제목
          </label>
          <input type="text" class="admake-field-input" id="masterHeadline" placeholder="눈에 띄는 제목">
        </div>

        <div class="admake-field-group">
          <label class="admake-field-label">
            <i data-lucide="file-text"></i>
            설명
          </label>
          <input type="text" class="admake-field-input" id="masterDescription" placeholder="부가 설명 (선택)">
        </div>
      </div>
    </div>

    <!-- 제품 표시 (Product Tags) - 단일 이미지/동영상 전용 -->
    <div class="admake-product-tags-section" id="productTagsSection">
      <div class="admake-section-header">
        <span class="admake-section-number font-inter">03</span>
        <span class="admake-section-title">제품 표시</span>
        <span class="admake-section-subtitle">단일 이미지/동영상 전용</span>
      </div>

      <div class="product-tags-content">
        <!-- 토글 스위치 -->
        <div class="product-tags-toggle">
          <label class="toggle-switch">
            <input type="checkbox" id="productTagsEnabled">
            <span class="toggle-slider"></span>
          </label>
          <span class="toggle-label">이 광고에 제품 태그 추가하기</span>
        </div>

        <!-- 제품세트 선택 영역 (토글 ON 시 표시) -->
        <div class="product-tags-selector hidden" id="productTagsSelector">
          <div class="selector-options">
            <label class="radio-option">
              <input type="radio" name="productSetSource" value="existing" checked>
              <span>기존 제품세트 사용</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="productSetSource" value="new">
              <span>새 제품세트 만들기</span>
            </label>
          </div>

          <!-- 기존 제품세트 드롭다운 -->
          <div class="existing-set-selector" id="existingSetSelector">
            <select class="admake-field-input admake-field-select" id="productSetDropdown">
              <option value="">제품세트를 선택하세요</option>
              <!-- 동적으로 채워짐 -->
            </select>
            <button type="button" class="refresh-sets-btn" id="refreshSetsBtn" title="목록 새로고침">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
            </button>
          </div>

          <!-- 새 제품세트 만들기 버튼 -->
          <div class="new-set-selector hidden" id="newSetSelector">
            <button type="button" class="new-set-btn" id="openCatalogForNewSetBtn">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
              카탈로그에서 제품세트 만들기
            </button>
          </div>

          <!-- 선택된 제품세트 정보 -->
          <div class="selected-set-info hidden" id="selectedSetInfo">
            <div class="set-info-badge">
              <span class="set-name" id="selectedSetName">-</span>
              <span class="set-count" id="selectedSetCount">0개 제품</span>
            </div>
            <button type="button" class="clear-set-btn" id="clearSelectedSetBtn" title="선택 해제">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 제품세트 만들기 모달 -->
    <div class="product-set-modal-overlay hidden" id="productSetModalOverlay">
      <div class="product-set-modal">
        <div class="product-set-modal-header">
          <h3>새 제품세트 만들기</h3>
          <button type="button" class="modal-close-btn" id="closeProductSetModalBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
          </button>
        </div>

        <!-- 탭 -->
        <div class="product-set-modal-tabs">
          <button type="button" class="modal-tab active" data-tab="url">자사몰 페이지</button>
          <button type="button" class="modal-tab" data-tab="manual">수동 선택</button>
        </div>

        <!-- 탭 컨텐츠: 자사몰 페이지 -->
        <div class="modal-tab-content active" id="tabUrl">
          <div class="modal-input-row">
            <input type="text" id="modalUrlInput" placeholder="자사몰 카테고리 URL을 입력하세요" class="modal-input">
            <button type="button" class="modal-action-btn" id="modalFetchBtn">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
              불러오기
            </button>
          </div>

          <div class="modal-loading hidden" id="modalUrlLoading">
            <div class="loading-spinner small"></div>
            <span>상품을 수집하고 있습니다...</span>
          </div>

          <div class="modal-product-list">
            <div class="modal-list-header">
              <label class="checkbox-label">
                <input type="checkbox" id="modalSelectAllUrl" checked>
                <span>전체 선택</span>
              </label>
              <span class="selected-count" id="modalUrlCount">0개 선택</span>
            </div>
            <div class="modal-product-table" id="modalUrlProducts">
              <div class="empty-state">URL을 입력하고 불러오기를 클릭하세요</div>
            </div>
          </div>
        </div>

        <!-- 탭 컨텐츠: 수동 선택 -->
        <div class="modal-tab-content" id="tabManual">
          <div class="modal-input-row">
            <select id="modalSearchType" class="modal-select">
              <option value="product_name">상품명</option>
              <option value="product_no">제품번호</option>
            </select>
            <input type="text" id="modalSearchInput" placeholder="검색어를 입력하세요" class="modal-input">
            <button type="button" class="modal-action-btn" id="modalSearchBtn">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
              검색
            </button>
          </div>

          <div class="modal-loading hidden" id="modalSearchLoading">
            <div class="loading-spinner small"></div>
            <span>검색 중...</span>
          </div>

          <div class="modal-search-results">
            <div class="modal-list-header">
              <span>검색 결과</span>
            </div>
            <div class="modal-product-table" id="modalSearchResults">
              <div class="empty-state">검색어를 입력하고 검색을 클릭하세요</div>
            </div>
          </div>

          <div class="modal-selected-products">
            <div class="modal-list-header">
              <span>추가된 상품</span>
              <span class="selected-count" id="modalManualCount">0개</span>
            </div>
            <div class="modal-product-table" id="modalSelectedProducts">
              <div class="empty-state">검색 결과에서 상품을 추가하세요</div>
            </div>
          </div>
        </div>

        <!-- 하단: 세트명 입력 및 생성 버튼 -->
        <div class="product-set-modal-footer">
          <div class="modal-setname-row">
            <label>세트명</label>
            <input type="text" id="modalSetNameInput" placeholder="예) [20250114] 신상품 세트" class="modal-input" maxlength="100">
          </div>
          <div class="modal-buttons">
            <button type="button" class="modal-cancel-btn" id="cancelProductSetModalBtn">취소</button>
            <button type="button" class="modal-submit-btn" id="createProductSetModalBtn">제품세트 만들기</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 개별 카드 편집 (슬라이드 모드 시) -->
    <div class="admake-cards-section hidden" id="cardsSection">
      <div class="admake-section-header">
        <span class="admake-section-number font-inter">04</span>
        <span class="admake-section-title">개별 카드 편집</span>
        <span class="admake-section-subtitle">자물쇠 해제 시 개별 수정</span>
      </div>
      <div class="admake-card-list" id="cardList">
        <!-- 동적으로 생성 -->
      </div>
    </div>

  </div>

  <!-- 우측: 미리보기 패널 -->
  <div class="admake-preview-panel">
    <div class="admake-preview-header">
      <div class="admake-preview-tabs">
        <button class="admake-preview-tab active" data-format="INSTAGRAM_STANDARD">인스타 피드</button>
        <button class="admake-preview-tab" data-format="INSTAGRAM_REELS">릴스</button>
        <button class="admake-preview-tab" data-format="MOBILE_FEED_STANDARD">페이스북 피드</button>
      </div>
    </div>
    <div class="admake-preview-content" id="previewContent">
      <div class="admake-preview-placeholder">
        <i data-lucide="eye"></i>
        <p>소재를 선택하면<br>미리보기가 표시됩니다</p>
      </div>
    </div>
  </div>

</div>

<!-- 저장된 광고 목록 -->
<div class="saved-ads-container" id="savedAdsContainer" style="display: none;">
  <div class="saved-ads-header">
    <span class="saved-ads-title">저장된 광고</span>
    <span class="saved-ads-count" id="savedAdsCountText">0개</span>
  </div>
  <div class="saved-ads-list" id="savedAdsList">
    <div class="saved-ads-empty">저장된 광고가 없습니다</div>
  </div>
</div>

<!-- 최종 확인 모달 -->
<div class="confirm-modal-overlay" id="confirmModalOverlay">
  <div class="confirm-modal">
    <div class="confirm-modal-header">
      <span class="confirm-modal-title">광고 전송 최종 확인</span>
      <button type="button" class="confirm-modal-close" id="confirmModalClose">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>
    <div class="confirm-modal-body">
      <div class="confirm-summary">
        <div class="confirm-summary-item">
          <div class="confirm-summary-value" id="confirmTotalCount">0</div>
          <div class="confirm-summary-label">총 광고 수</div>
        </div>
        <div class="confirm-summary-item">
          <div class="confirm-summary-value" id="confirmImageCount">0</div>
          <div class="confirm-summary-label">이미지</div>
        </div>
        <div class="confirm-summary-item">
          <div class="confirm-summary-value" id="confirmVideoCount">0</div>
          <div class="confirm-summary-label">비디오</div>
        </div>
        <div class="confirm-summary-item">
          <div class="confirm-summary-value" id="confirmCarouselCount">0</div>
          <div class="confirm-summary-label">슬라이드</div>
        </div>
      </div>
      <div class="confirm-ads-list" id="confirmAdsList">
        <!-- 광고 목록이 동적으로 추가됨 -->
      </div>
    </div>
    <div class="confirm-modal-footer">
      <button type="button" class="admake-btn admake-btn-secondary" id="confirmCancelBtn">취소</button>
      <button type="button" class="admake-btn admake-btn-primary" id="confirmProceedBtn">Step 4로 진행</button>
    </div>
  </div>
</div>

<!-- 하단 액션 바 -->
<div class="admake-action-bar">
  <div class="admake-action-left">
    <span class="font-inter">STEP 3 OF 5</span>
    <span class="pending-ads-count" id="pendingAdsCount" style="display: none; margin-left: 12px; padding: 4px 10px; background: var(--accent-emerald); color: #fff; border-radius: 12px; font-size: 12px; font-weight: 600;"></span>
  </div>
  <div class="admake-action-buttons">
    <button class="admake-btn admake-btn-secondary" id="backBtn">이전</button>
    <button class="admake-btn admake-btn-secondary" id="addMoreBtn" disabled style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: #fff; border: none;">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
      저장하고 광고추가
    </button>
    <button class="admake-btn admake-btn-primary" id="nextBtn" disabled>다음 단계로</button>
  </div>
</div>

<!-- 토스트 컨테이너 -->
<div class="admake-toast-container" id="toastContainer"></div>

<script src="{{ url_for('static', filename='js/common.js') }}"></script>
<script src="{{ url_for('static', filename='js/common_ui.js') }}"></script>

<script>
// ===== 커스텀 토스트 알림 시스템 =====
function showToast(message, type = 'info', duration = 3500) {
  const container = document.getElementById('toastContainer');
  if (!container) return;

  const toast = document.createElement('div');
  toast.className = `admake-toast toast-${type}`;
  const icons = { info: 'ℹ️', success: '✓', warning: '⚠', error: '✕' };

  toast.innerHTML = `
    <span class="admake-toast-icon">${icons[type] || icons.info}</span>
    <span class="admake-toast-message">${message}</span>
    <button class="admake-toast-close" onclick="this.parentElement.remove()">×</button>
  `;

  container.appendChild(toast);
  setTimeout(() => {
    toast.classList.add('toast-out');
    setTimeout(() => toast.remove(), 300);
  }, duration);
}

// ===== 상태 관리 =====
let mediaItems = [];           // Step 2에서 가져온 미디어 목록
let selectedMediaIds = [];     // 선택된 미디어 ID 배열 (순서 유지)
let currentAdType = 'single_image';  // single_image, single_video, slide
let currentPreviewFormat = 'INSTAGRAM_STANDARD';
let cardLocks = {};            // { mediaId: { url: true, headline: true, ... } }
let previewDebounceTimer = null;
let previewTimeoutId = null;  // 이전 타임아웃 취소용

// 제품 표시 (Product Tags) 상태
let productTagsEnabled = false;
let selectedProductSet = null;  // { id, name, product_count }
let productSetsList = [];       // 카탈로그의 제품세트 목록

// 마스터 값
let masterValues = {
  adName: '',
  url: '',
  cta: 'SHOP_NOW',
  primaryText: '',
  headline: '',
  description: ''
};

// 개별 카드 값 (마스터 동기화 해제 시 사용)
let cardValues = {}; // { mediaId: { url, headline, description } }

// ===== 광고 이름 접두사 관리 =====
function getAdTypeLabel(type) {
  switch (type) {
    case 'single_image': return '[단일]';
    case 'single_video': return '[영상]';
    case 'slide': return '[슬라이드]';
    default: return '[단일]';
  }
}

function getTodayString() {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  return `[${year}${month}${day}]`;
}

function updateAdNamePrefix() {
  const prefixEl = document.getElementById('adNamePrefix');
  if (prefixEl) {
    const dateStr = getTodayString();
    const typeStr = getAdTypeLabel(currentAdType);
    prefixEl.textContent = dateStr + typeStr;
  }
}

function getFullAdName() {
  const prefix = document.getElementById('adNamePrefix')?.textContent || '';
  const userInput = masterValues.adName || '';
  return prefix + userInput;
}

console.log('[STEP3] 페이지 초기화 시작');

// ===== IndexedDB에서 File 객체 가져오기 =====
async function getFileFromIndexedDB(mediaId) {
  return new Promise((resolve, reject) => {
    if (!('indexedDB' in window)) {
      reject(new Error('IndexedDB를 지원하지 않습니다'));
      return;
    }

    const dbName = 'admake_files';
    const request = indexedDB.open(dbName, 1);

    request.onsuccess = (event) => {
      const db = event.target.result;
      const transaction = db.transaction(['files'], 'readonly');
      const store = transaction.objectStore('files');
      const getRequest = store.get(mediaId);

      getRequest.onsuccess = () => {
        if (getRequest.result && getRequest.result.file) {
          resolve(getRequest.result.file);
        } else {
          reject(new Error('파일을 찾을 수 없습니다'));
        }
      };

      getRequest.onerror = () => reject(getRequest.error);
    };

    request.onerror = () => reject(request.error);
  });
}

// ===== Step 2 데이터 로드 =====
async function loadStep2Data() {
  console.log('[STEP3] Step 2 데이터 로드 시작');

  // sessionStorage에서 업로드된 결과 가져오기 (두 가지 키 모두 확인)
  let uploadedData = sessionStorage.getItem('admake_uploaded_results');
  const step2Results = sessionStorage.getItem('admake_step2_results');
  const step1Data = sessionStorage.getItem('admake_step1_state');

  // admake_uploaded_results가 없으면 admake_step2_results에서 추출
  if (!uploadedData && step2Results) {
    try {
      const parsed = JSON.parse(step2Results);
      uploadedData = JSON.stringify(parsed.results || []);
      console.log('[STEP3] admake_step2_results에서 데이터 추출');
    } catch (e) {
      console.error('[STEP3] step2Results 파싱 오류:', e);
    }
  }

  if (!uploadedData) {
    console.error('[STEP3] 업로드된 미디어 데이터 없음');
    showToast('Step 2 데이터를 찾을 수 없습니다. Step 2로 돌아가주세요.', 'warning');
    setTimeout(() => {
      window.location.href = `/admake/crop?account_id=${encodeURIComponent(accountId)}`;
    }, 2000);
    return;
  }

  try {
    const uploaded = JSON.parse(uploadedData);
    console.log('[STEP3] 업로드된 데이터:', uploaded);

    if (!uploaded || uploaded.length === 0) {
      console.error('[STEP3] 업로드된 미디어가 없습니다');
      showToast('업로드된 미디어가 없습니다. Step 2로 돌아가주세요.', 'warning');
      return;
    }

    // Step 1 데이터에서 미디어 정보 가져오기
    let step1Items = [];
    if (step1Data) {
      const parsed = JSON.parse(step1Data);
      step1Items = parsed.mediaItems || [];
      console.log('[STEP3] Step 1 미디어 아이템:', step1Items.length);
    }

    // 미디어 아이템 구성 (IndexedDB에서 파일 가져와서 새 Blob URL 생성)
    mediaItems = [];
    for (let i = 0; i < uploaded.length; i++) {
      const item = uploaded[i];
      const step1Item = step1Items.find(s => s.id === item.id) || {};

      let previewUrl = null;
      let file = null;

      // IndexedDB에서 File 객체 가져와서 새 Blob URL 생성
      try {
        file = await getFileFromIndexedDB(item.id);
        previewUrl = URL.createObjectURL(file);
        console.log(`[STEP3] ${item.id}: IndexedDB에서 File 로드 및 Blob URL 생성 완료`);
      } catch (e) {
        console.warn(`[STEP3] ${item.id}: IndexedDB 로드 실패, placeholder 사용`, e);
        previewUrl = null;
      }

      mediaItems.push({
        id: item.id,
        name: step1Item.name || `Media_${i + 1}`,
        mediaType: item.type, // 'image' or 'video'
        hash: item.hash,      // 이미지용
        videoId: item.video_id, // 동영상용
        previewUrl: previewUrl,
        file: file, // File 객체 저장
        // 개별 카드 값 초기화
        url: '',
        headline: '',
        description: ''
      });
    }

    console.log('[STEP3] 미디어 아이템 구성 완료:', mediaItems.length);

    // 카드 잠금 상태 초기화 (모두 잠금)
    mediaItems.forEach(item => {
      cardLocks[item.id] = {
        url: true,
        headline: true,
        description: true
      };
      cardValues[item.id] = {
        url: '',
        headline: '',
        description: ''
      };
    });

    renderMediaGrid();

  } catch (e) {
    console.error('[STEP3] 데이터 파싱 오류:', e);
    showToast('데이터 로드 중 오류가 발생했습니다.', 'error');
  }
}

// ===== 미디어 그리드 렌더링 =====
function renderMediaGrid() {
  const grid = document.getElementById('mediaGrid');
  grid.innerHTML = '';

  mediaItems.forEach((item, index) => {
    const isSelected = selectedMediaIds.includes(item.id);
    const selectionOrder = selectedMediaIds.indexOf(item.id) + 1;

    const div = document.createElement('div');
    div.className = `admake-media-item ${isSelected ? 'selected' : ''}`;
    div.dataset.id = item.id;
    div.dataset.type = item.mediaType;

    // 썸네일 (previewUrl이 있으면 사용, 없으면 placeholder)
    let mediaHtml = '';
    if (item.previewUrl) {
      if (item.mediaType === 'video') {
        mediaHtml = `<video src="${item.previewUrl}" muted></video>`;
      } else {
        mediaHtml = `<img src="${item.previewUrl}" alt="${item.name}">`;
      }
    } else {
      mediaHtml = `<div style="width:100%;height:100%;background:var(--bg-card);display:flex;align-items:center;justify-content:center;color:var(--text-muted);font-size:10px;">${item.name.substring(0, 8)}</div>`;
    }

    div.innerHTML = `
      ${mediaHtml}
      <div class="admake-media-badge">${selectionOrder || ''}</div>
      ${item.mediaType === 'video' ? '<div class="admake-media-type-icon"><i data-lucide="play"></i></div>' : ''}
    `;

    div.addEventListener('click', () => handleMediaClick(item.id));
    grid.appendChild(div);
  });

  // Lucide 아이콘 초기화
  lucide.createIcons();

  updateSelectionHint();
  console.log('[STEP3] 미디어 그리드 렌더링 완료');
}

// ===== 미디어 클릭 핸들러 =====
function handleMediaClick(mediaId) {
  const item = mediaItems.find(m => m.id === mediaId);
  if (!item) return;

  console.log(`[STEP3] 미디어 클릭: ${mediaId}, 타입: ${item.mediaType}, 현재 광고 유형: ${currentAdType}`);

  // 광고 유형에 따른 제한
  if (currentAdType === 'single_image' && item.mediaType === 'video') {
    showToast('단일 이미지 모드에서는 이미지만 선택 가능합니다.', 'warning');
    return;
  }
  if (currentAdType === 'single_video' && item.mediaType === 'image') {
    showToast('단일 영상 모드에서는 영상만 선택 가능합니다.', 'warning');
    return;
  }

  const isCurrentlySelected = selectedMediaIds.includes(mediaId);

  if (currentAdType === 'slide') {
    // 슬라이드: 토글 선택 (최대 10개)
    if (isCurrentlySelected) {
      selectedMediaIds = selectedMediaIds.filter(id => id !== mediaId);
    } else {
      if (selectedMediaIds.length >= 10) {
        showToast('슬라이드는 최대 10개까지 선택 가능합니다.', 'warning');
        return;
      }
      selectedMediaIds.push(mediaId);
    }
  } else {
    // 단일: 1개만 선택
    if (isCurrentlySelected) {
      selectedMediaIds = [];
    } else {
      selectedMediaIds = [mediaId];
    }
  }

  console.log(`[STEP3] 선택된 미디어:`, selectedMediaIds);

  renderMediaGrid();
  renderCardList();
  updateNextButton();
  triggerPreviewUpdate();
}

// ===== 광고 유형 변경 =====
function handleAdTypeChange(type) {
  if (currentAdType === type) return;

  console.log(`[STEP3] 광고 유형 변경: ${currentAdType} -> ${type}`);
  currentAdType = type;

  // 버튼 활성화 상태 업데이트
  document.querySelectorAll('.admake-type-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.type === type);
  });

  // 광고 이름 접두사 업데이트
  updateAdNamePrefix();

  // 선택 초기화
  selectedMediaIds = [];
  renderMediaGrid();
  renderCardList();
  updateSelectionHint();
  updateNextButton();

  // 개별 카드 섹션 표시/숨김
  const cardsSection = document.getElementById('cardsSection');
  if (type === 'slide') {
    cardsSection.classList.remove('hidden');
  } else {
    cardsSection.classList.add('hidden');
  }

  // 제품 표시 섹션 표시/숨김 (단일 이미지/동영상만 지원)
  const productTagsSection = document.getElementById('productTagsSection');
  if (type === 'slide') {
    productTagsSection.classList.add('disabled');
    // 캐러셀 선택 시 제품 표시 비활성화
    document.getElementById('productTagsEnabled').checked = false;
    productTagsEnabled = false;
    document.getElementById('productTagsSelector').classList.add('hidden');
  } else {
    productTagsSection.classList.remove('disabled');
  }

  // 미리보기 초기화
  document.getElementById('previewContent').innerHTML = `
    <div class="admake-preview-placeholder">
      <i data-lucide="eye"></i>
      <p>소재를 선택하면<br>미리보기가 표시됩니다</p>
    </div>
  `;
  lucide.createIcons();
}

// ===== 선택 힌트 업데이트 =====
function updateSelectionHint() {
  const hint = document.getElementById('mediaSelectionHint');
  if (currentAdType === 'slide') {
    hint.textContent = `${selectedMediaIds.length}/10 선택 (최소 2개)`;
  } else if (currentAdType === 'single_image') {
    const imageCount = mediaItems.filter(m => m.mediaType === 'image').length;
    hint.textContent = `이미지 ${imageCount}개 중 1개 선택`;
  } else {
    const videoCount = mediaItems.filter(m => m.mediaType === 'video').length;
    hint.textContent = `영상 ${videoCount}개 중 1개 선택`;
  }
}

// ===== 버튼 상태 업데이트 (NEXT + 광고 추가하기) =====
function updateNextButton() {
  const nextBtn = document.getElementById('nextBtn');
  const addMoreBtn = document.getElementById('addMoreBtn');
  let isValid = false;

  if (currentAdType === 'slide') {
    isValid = selectedMediaIds.length >= 2;
  } else {
    isValid = selectedMediaIds.length === 1;
  }

  // 필수 필드 체크
  const hasUrl = masterValues.url.trim() !== '';
  const hasPrimaryText = masterValues.primaryText.trim() !== '';

  const canProceed = isValid && hasUrl && hasPrimaryText;
  nextBtn.disabled = !canProceed;
  addMoreBtn.disabled = !canProceed;

  console.log(`[STEP3] 버튼 상태: ${canProceed}, 선택: ${selectedMediaIds.length}, URL: ${hasUrl}, 텍스트: ${hasPrimaryText}`);
}

// ===== 개별 카드 리스트 렌더링 =====
function renderCardList() {
  const list = document.getElementById('cardList');
  list.innerHTML = '';

  if (currentAdType !== 'slide' || selectedMediaIds.length === 0) {
    return;
  }

  selectedMediaIds.forEach((mediaId, index) => {
    const item = mediaItems.find(m => m.id === mediaId);
    if (!item) return;

    const locks = cardLocks[mediaId] || { url: true, headline: true, description: true };
    const values = cardValues[mediaId] || {};

    const card = document.createElement('div');
    card.className = 'admake-card-item';
    card.innerHTML = `
      <div class="admake-card-header">
        <div class="admake-card-thumb">
          ${item.previewUrl
            ? (item.mediaType === 'video'
              ? `<video src="${item.previewUrl}" muted></video>`
              : `<img src="${item.previewUrl}" alt="">`)
            : `<div style="width:100%;height:100%;background:var(--bg-input);"></div>`
          }
        </div>
        <div class="admake-card-info">
          <div class="admake-card-name">${item.name}</div>
          <div class="admake-card-meta">${item.mediaType === 'video' ? 'Video' : 'Image'}</div>
        </div>
        <div class="admake-card-index">${index + 1}</div>
      </div>

      <div class="admake-field-group">
        <label class="admake-field-label"><i data-lucide="link"></i> URL</label>
        <div class="admake-field-with-lock">
          <input type="url" class="admake-field-input font-inter card-field"
            data-media-id="${mediaId}" data-field="url"
            placeholder="${locks.url ? '마스터 동기화' : 'https://...'}"
            value="${locks.url ? '' : (values.url || '')}"
            ${locks.url ? 'disabled' : ''}>
          <button class="admake-lock-btn ${locks.url ? 'locked' : ''}"
            data-media-id="${mediaId}" data-field="url" title="${locks.url ? '동기화 해제' : '동기화'}">
            <i data-lucide="${locks.url ? 'lock' : 'unlock'}"></i>
          </button>
        </div>
      </div>

      <div class="admake-field-group" style="margin-top: 12px;">
        <label class="admake-field-label"><i data-lucide="heading"></i> 제목</label>
        <div class="admake-field-with-lock">
          <input type="text" class="admake-field-input card-field"
            data-media-id="${mediaId}" data-field="headline"
            placeholder="${locks.headline ? '마스터 동기화' : '제목'}"
            value="${locks.headline ? '' : (values.headline || '')}"
            ${locks.headline ? 'disabled' : ''}>
          <button class="admake-lock-btn ${locks.headline ? 'locked' : ''}"
            data-media-id="${mediaId}" data-field="headline">
            <i data-lucide="${locks.headline ? 'lock' : 'unlock'}"></i>
          </button>
        </div>
      </div>

      <div class="admake-field-group" style="margin-top: 12px;">
        <label class="admake-field-label"><i data-lucide="file-text"></i> 설명</label>
        <div class="admake-field-with-lock">
          <input type="text" class="admake-field-input card-field"
            data-media-id="${mediaId}" data-field="description"
            placeholder="${locks.description ? '마스터 동기화' : '설명'}"
            value="${locks.description ? '' : (values.description || '')}"
            ${locks.description ? 'disabled' : ''}>
          <button class="admake-lock-btn ${locks.description ? 'locked' : ''}"
            data-media-id="${mediaId}" data-field="description">
            <i data-lucide="${locks.description ? 'lock' : 'unlock'}"></i>
          </button>
        </div>
      </div>
    `;

    list.appendChild(card);
  });

  // 자물쇠 버튼 이벤트
  list.querySelectorAll('.admake-lock-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const mediaId = btn.dataset.mediaId;
      const field = btn.dataset.field;
      toggleLock(mediaId, field);
    });
  });

  // 개별 필드 입력 이벤트
  list.querySelectorAll('.card-field').forEach(input => {
    input.addEventListener('input', (e) => {
      const mediaId = e.target.dataset.mediaId;
      const field = e.target.dataset.field;
      if (!cardValues[mediaId]) cardValues[mediaId] = {};
      cardValues[mediaId][field] = e.target.value;
      triggerPreviewUpdate();
    });
  });

  lucide.createIcons();
}

// ===== 자물쇠 토글 =====
function toggleLock(mediaId, field) {
  if (!cardLocks[mediaId]) {
    cardLocks[mediaId] = { url: true, headline: true, description: true };
  }

  cardLocks[mediaId][field] = !cardLocks[mediaId][field];
  console.log(`[STEP3] 자물쇠 토글: ${mediaId}.${field} = ${cardLocks[mediaId][field]}`);

  // 잠금 해제 시 마스터 값으로 초기화
  if (!cardLocks[mediaId][field]) {
    if (!cardValues[mediaId]) cardValues[mediaId] = {};
    cardValues[mediaId][field] = masterValues[field] || '';
  }

  renderCardList();
}

// ===== 마스터 값 변경 핸들러 =====
function handleMasterChange(field, value) {
  masterValues[field] = value;
  console.log(`[STEP3] 마스터 값 변경: ${field} = ${value.substring(0, 30)}...`);

  // 잠금된 카드들에 동기화
  mediaItems.forEach(item => {
    if (cardLocks[item.id] && cardLocks[item.id][field]) {
      // 잠금 상태면 마스터 값 사용 (cardValues는 업데이트하지 않음)
    }
  });

  updateNextButton();
  triggerPreviewUpdate();
}

// ===== 미리보기 업데이트 (디바운싱) =====
function triggerPreviewUpdate() {
  if (previewDebounceTimer) {
    clearTimeout(previewDebounceTimer);
  }

  previewDebounceTimer = setTimeout(() => {
    generatePreview();
  }, 500);
}

// ===== Meta API 미리보기 생성 =====
let currentPreviewHtml = null; // 현재 미리보기 HTML 캐시

async function generatePreview() {
  if (selectedMediaIds.length === 0) {
    console.log('[STEP3] 선택된 미디어 없음, 미리보기 스킵');
    return;
  }

  const previewContent = document.getElementById('previewContent');

  // 기존 미리보기가 있으면 블러 처리, 없으면 로딩 표시
  const existingFrame = previewContent.querySelector('.admake-preview-frame');
  if (existingFrame) {
    existingFrame.classList.add('loading');
    // 로딩 오버레이 추가
    if (!previewContent.querySelector('.admake-preview-loader')) {
      const loader = document.createElement('div');
      loader.className = 'admake-preview-loader active';
      loader.innerHTML = `
        <div class="admake-preview-loader-spinner"></div>
        <span class="admake-preview-loader-text">Loading preview...</span>
      `;
      previewContent.querySelector('.admake-preview-wrapper')?.appendChild(loader);
    } else {
      previewContent.querySelector('.admake-preview-loader')?.classList.add('active');
    }
  } else {
    previewContent.innerHTML = `
      <div class="admake-preview-wrapper">
        <div class="admake-preview-frame" style="min-height:300px;display:flex;align-items:center;justify-content:center;">
          <div class="admake-preview-loader-spinner"></div>
        </div>
      </div>
    `;
  }

  try {
    // 첫 번째 선택된 미디어 정보
    const firstMediaId = selectedMediaIds[0];
    const firstMedia = mediaItems.find(m => m.id === firstMediaId);

    if (!firstMedia) {
      throw new Error('선택된 미디어를 찾을 수 없습니다.');
    }

    console.log('[STEP3] 미리보기 생성 요청:', {
      mediaType: firstMedia.mediaType,
      hash: firstMedia.hash,
      videoId: firstMedia.videoId,
      format: currentPreviewFormat
    });

    // 마스터 값 디버그
    console.log('[MASTER] 현재 마스터 값:', {
      url: masterValues.url,
      primaryText: masterValues.primaryText?.substring(0, 30),
      headline: masterValues.headline,
      description: masterValues.description,
      cta: masterValues.cta
    });

    // API 요청 데이터 구성
    const requestData = {
      account_id: accountId,
      ad_format: currentPreviewFormat,
      media_type: firstMedia.mediaType,
      link: masterValues.url || 'https://example.com',
      message: masterValues.primaryText || '',
      name: masterValues.headline || '',
      description: masterValues.description || '',
      cta_type: masterValues.cta || 'SHOP_NOW'
    };

    console.log('[MASTER] API 전송 데이터:', {
      link: requestData.link,
      message: requestData.message?.substring(0, 30),
      name: requestData.name,
      description: requestData.description,
      cta_type: requestData.cta_type
    });

    // 미디어 타입에 따라 올바른 필드만 전송 (Meta API 규격 준수)
    if (firstMedia.mediaType === 'video') {
      requestData.video_id = firstMedia.videoId;
      console.log('[STEP3] 동영상 모드 - video_id만 전송:', firstMedia.videoId);
    } else {
      requestData.image_hash = firstMedia.hash;
      console.log('[STEP3] 이미지 모드 - image_hash만 전송:', firstMedia.hash);
    }

    // 슬라이드 모드인 경우 카드 데이터 추가
    if (currentAdType === 'slide' && selectedMediaIds.length > 1) {
      requestData.is_carousel = true;
      requestData.cards = selectedMediaIds.map((mediaId, index) => {
        const media = mediaItems.find(m => m.id === mediaId);
        const locks = cardLocks[mediaId] || {};
        const values = cardValues[mediaId] || {};

        // 기본 카드 데이터
        const cardData = {
          link: locks.url ? masterValues.url : (values.url || masterValues.url),
          name: locks.headline ? masterValues.headline : (values.headline || masterValues.headline),
          description: locks.description ? masterValues.description : (values.description || masterValues.description)
        };

        // 미디어 타입에 따라 올바른 필드만 추가
        if (media?.mediaType === 'video') {
          cardData.video_id = media.videoId;
        } else {
          cardData.image_hash = media?.hash;
        }

        return cardData;
      });
    }

    console.log('[STEP3] API 요청 데이터:', JSON.stringify(requestData, null, 2));

    const response = await fetch('/dashboard/generate_ad_preview', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(requestData)
    });

    const result = await response.json();
    console.log('[STEP3] API 응답:', result);

    if (result.status === 'success' && result.preview_html) {
      currentPreviewHtml = result.preview_html;
      const startTime = Date.now();
      console.log('[LOADING] T+0ms: API 응답 수신, HTML 삽입 시작');

      // 새 프레임 생성 - Meta iframe의 자연 크기를 그대로 사용
      previewContent.innerHTML = `
        <div class="admake-preview-wrapper">
          <div class="admake-preview-frame loading">
            ${result.preview_html}
          </div>
          <div class="admake-preview-loader active">
            <div class="admake-preview-loader-spinner"></div>
            <span class="admake-preview-loader-text">Rendering...</span>
          </div>
        </div>
      `;
      console.log('[LOADING] T+' + (Date.now() - startTime) + 'ms: HTML 삽입 완료');

      const frame = previewContent.querySelector('.admake-preview-frame');
      const loader = previewContent.querySelector('.admake-preview-loader');
      const iframe = frame.querySelector('iframe');

      console.log('[LOADING] frame.loading 클래스:', frame.classList.contains('loading'));
      console.log('[LOADING] loader.active 클래스:', loader?.classList.contains('active'));
      console.log('[LOADING] frame 블러 상태:', getComputedStyle(frame).filter);

      // ===== 디버그: Meta iframe 분석 =====
      console.log('[DEBUG] ========== PREVIEW DEBUG START ==========');
      console.log('[DEBUG] 현재 포맷:', currentPreviewFormat);
      console.log('[DEBUG] Meta 반환 HTML:', result.preview_html.substring(0, 500));

      if (iframe) {
        console.log('[DEBUG] iframe 발견');
        console.log('[DEBUG] iframe 원본 속성:', {
          width: iframe.getAttribute('width'),
          height: iframe.getAttribute('height'),
          style: iframe.getAttribute('style'),
          src: iframe.src?.substring(0, 100)
        });
        console.log('[DEBUG] iframe computed style:', {
          width: getComputedStyle(iframe).width,
          height: getComputedStyle(iframe).height,
          overflow: getComputedStyle(iframe).overflow
        });
      }

      console.log('[DEBUG] frame(.admake-preview-frame) computed:', {
        width: getComputedStyle(frame).width,
        height: getComputedStyle(frame).height,
        overflow: getComputedStyle(frame).overflow,
        display: getComputedStyle(frame).display
      });

      console.log('[DEBUG] previewContent computed:', {
        width: getComputedStyle(previewContent).width,
        height: getComputedStyle(previewContent).height,
        overflow: getComputedStyle(previewContent).overflow,
        overflowY: getComputedStyle(previewContent).overflowY
      });
      console.log('[DEBUG] ========== PREVIEW DEBUG END ==========');

      // 포맷별 최적 크기 설정 - 스크롤 없이 전체 콘텐츠 표시
      const getOptimalSize = () => {
        switch (currentPreviewFormat) {
          case 'INSTAGRAM_REELS':
            return { width: 340, height: 620 };  // Reels
          case 'INSTAGRAM_STANDARD':
            return { width: 340, height: 620 };  // IG Feed - 높이 증가
          case 'MOBILE_FEED_STANDARD':
            return { width: 360, height: 650 };  // FB Feed
          default:
            return null;
        }
      };

      // iframe 크기 조정 함수
      const adjustIframeSize = () => {
        if (!iframe) return;

        const size = getOptimalSize();
        if (size) {
          iframe.setAttribute('width', String(size.width));
          iframe.setAttribute('height', String(size.height));
          iframe.style.width = size.width + 'px';
          iframe.style.height = size.height + 'px';
          iframe.setAttribute('scrolling', 'no');  // 내부 스크롤 제거
          console.log(`[DEBUG] ${currentPreviewFormat} iframe 크기 조정:`, size);
        }
        iframe.style.border = 'none';
        iframe.setAttribute('frameborder', '0');
      };

      // 로딩 해제 함수
      const finishLoading = (reason) => {
        console.log('[LOADING] finishLoading 호출됨, 이유:', reason);

        // 클래스 제거
        frame.classList.remove('loading');
        loader?.classList.remove('active');

        // CSS transition 무시하고 즉시 스타일 적용
        frame.style.filter = 'none';
        frame.style.opacity = '1';

        adjustIframeSize();

        console.log('[LOADING] 완료 - iframe 크기:', iframe?.offsetWidth, 'x', iframe?.offsetHeight);
        console.log('[STEP3] 미리보기 렌더링 완료');
      };

      // 이전 타임아웃 취소
      if (previewTimeoutId) {
        clearTimeout(previewTimeoutId);
        previewTimeoutId = null;
      }

      if (iframe) {
        // onload 이벤트 - 이게 발생하면 바로 완료
        iframe.onload = () => {
          console.log('[LOADING] iframe onload!');
          if (previewTimeoutId) {
            clearTimeout(previewTimeoutId);
            previewTimeoutId = null;
          }
          finishLoading('onload');
        };

        // 타임아웃 폴백 (15초) - 안전장치
        previewTimeoutId = setTimeout(() => {
          console.log('[LOADING] 15초 타임아웃');
          finishLoading('타임아웃');
        }, 15000);
      } else {
        setTimeout(() => finishLoading('iframe 없음'), 300);
      }

    } else {
      throw new Error(result.message || '미리보기 생성 실패');
    }

  } catch (error) {
    console.error('[STEP3] 미리보기 오류:', error);

    // 네트워크 오류 감지
    const isNetworkError = error.message.includes('네트워크') ||
                           error.message.includes('Connection') ||
                           error.message.includes('timeout');

    const errorTitle = isNetworkError
      ? '일시적인 네트워크 오류입니다'
      : '미리보기 생성 실패';
    const errorDesc = isNetworkError
      ? '잠시 후 다시 시도됩니다...'
      : error.message;

    previewContent.innerHTML = `
      <div class="admake-preview-wrapper">
        <div class="admake-preview-error" style="padding:40px;text-align:center;">
          <i data-lucide="${isNetworkError ? 'wifi-off' : 'alert-circle'}" style="width:32px;height:32px;margin-bottom:12px;opacity:0.5;color:${isNetworkError ? 'var(--accent-gold)' : 'var(--accent-red)'}"></i>
          <p style="color:${isNetworkError ? 'var(--accent-gold)' : 'var(--accent-red)'};font-size:13px;margin:0 0 8px 0;font-weight:500;">${errorTitle}</p>
          <p style="font-size:11px;color:var(--text-muted);margin:0 0 16px 0;">${errorDesc}</p>
          <button onclick="generatePreview()" style="padding:8px 16px;background:var(--bg-card);border:1px solid var(--border-default);border-radius:6px;color:var(--text-primary);cursor:pointer;font-size:12px;">
            다시 시도
          </button>
        </div>
      </div>
    `;
    lucide.createIcons();

    // 네트워크 오류 시 3초 후 자동 재시도
    if (isNetworkError) {
      setTimeout(() => {
        console.log('[STEP3] 네트워크 오류 자동 재시도...');
        generatePreview();
      }, 3000);
    }
  }
}

// ===== 미리보기 탭 변경 =====
function handlePreviewTabChange(format) {
  currentPreviewFormat = format;
  console.log(`[STEP3] 미리보기 포맷 변경: ${format}`);

  document.querySelectorAll('.admake-preview-tab').forEach(tab => {
    tab.classList.toggle('active', tab.dataset.format === format);
  });

  // 디바운싱 적용 (500ms)
  if (previewDebounceTimer) {
    clearTimeout(previewDebounceTimer);
  }
  previewDebounceTimer = setTimeout(() => {
    generatePreview();
  }, 300);
}

// ===== 이전/다음/광고추가 버튼 =====
function handleBackButton() {
  console.log('[STEP3] 이전 버튼 클릭 - Step 2로 이동');
  window.location.href = `/admake/crop?account_id=${encodeURIComponent(accountId)}`;
}

// 현재 광고 데이터를 서버 세션(pending_ads)에 추가
async function addToPendingAds() {
  // 선택된 미디어 정보 수집
  const selectedMedia = mediaItems.filter(m => selectedMediaIds.includes(m.id));
  const firstMedia = selectedMedia[0];

  // is_carousel 판단
  const isCarousel = currentAdType === 'slide';

  // 카드 데이터 구성 (캐러셀인 경우)
  let cards = [];
  if (isCarousel) {
    cards = selectedMedia.map(media => {
      const locks = cardLocks[media.id] || { url: true, headline: true, description: true };
      const values = cardValues[media.id] || {};

      return {
        media_id: media.id || null,  // IndexedDB 키
        media_type: media.mediaType,
        video_id: media.videoId || null,
        image_hash: media.hash || null,
        thumbnail_url: media.previewUrl || null,
        // 개별 카드 설정 (잠금 시 마스터 값, 해제 시 개별 값)
        link: locks.url ? masterValues.url : (values.url || masterValues.url),
        name: locks.headline ? masterValues.headline : (values.headline || masterValues.headline),
        description: locks.description ? masterValues.description : (values.description || masterValues.description)
      };
    });
  }

  // 광고 데이터 구성
  const adData = {
    media_id: firstMedia?.id || null,  // IndexedDB 키 (Step 5에서 썸네일 로드용)
    media_type: firstMedia?.mediaType || 'image',
    video_id: firstMedia?.videoId || null,
    image_hash: firstMedia?.hash || null,
    thumbnail_url: firstMedia?.previewUrl || null,
    message: masterValues.primaryText || '',
    headline: masterValues.headline || '',
    description: masterValues.description || '',
    link: masterValues.url || '',
    cta_type: masterValues.cta || 'SHOP_NOW',
    ad_name: getFullAdName() || `AD_${Date.now()}`,
    is_carousel: isCarousel,
    cards: cards,
    // 제품 표시 (Product Tags) - 단일 이미지/동영상만 지원
    product_tags: !isCarousel && productTagsEnabled && selectedProductSet ? {
      enabled: true,
      product_set_id: selectedProductSet.id,
      product_set_name: selectedProductSet.name
    } : null
  };

  console.log('[STEP3] pending_ads에 추가할 데이터:', adData);

  try {
    const response = await fetch('/dashboard/add_pending_ad', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(adData)
    });

    const result = await response.json();
    console.log('[STEP3] pending_ad 추가 결과:', result);

    if (result.status === 'success') {
      return result;
    } else {
      throw new Error(result.message || '광고 추가 실패');
    }
  } catch (error) {
    console.error('[STEP3] pending_ads 추가 오류:', error);
    throw error;
  }
}

// ===== 저장된 광고 목록 관리 =====
let savedAdsList = []; // 저장된 광고 목록

// 중복 체크 함수 (광고형식 + 광고소재 + 광고이름)
function checkDuplicateAd(newAd) {
  return savedAdsList.some(existing => {
    // 광고 형식 비교
    const sameType = existing.is_carousel === newAd.is_carousel &&
                     existing.media_type === newAd.media_type;

    // 광고 이름 비교
    const sameName = existing.ad_name === newAd.ad_name;

    // 광고 소재 비교 (캐러셀은 카드들, 단일은 해시/ID)
    let sameMedia = false;
    if (newAd.is_carousel && existing.is_carousel) {
      // 캐러셀: 카드 수와 각 카드의 해시/ID 비교
      if (existing.cards?.length === newAd.cards?.length) {
        sameMedia = newAd.cards.every((card, idx) => {
          const existCard = existing.cards[idx];
          return card.image_hash === existCard.image_hash &&
                 card.video_id === existCard.video_id;
        });
      }
    } else {
      // 단일 이미지/비디오
      sameMedia = existing.image_hash === newAd.image_hash &&
                  existing.video_id === newAd.video_id;
    }

    return sameType && sameName && sameMedia;
  });
}

// 저장된 광고 목록 렌더링
function renderSavedAdsList() {
  const container = document.getElementById('savedAdsContainer');
  const listEl = document.getElementById('savedAdsList');
  const countEl = document.getElementById('savedAdsCountText');
  const nextBtn = document.getElementById('nextBtn');

  if (savedAdsList.length === 0) {
    container.style.display = 'none';
    document.body.classList.remove('has-saved-ads');
    nextBtn.disabled = true;
    return;
  }

  container.style.display = 'block';
  document.body.classList.add('has-saved-ads');
  countEl.textContent = `${savedAdsList.length}개`;
  nextBtn.disabled = false;

  listEl.innerHTML = savedAdsList.map((ad, index) => {
    // 광고 형식 결정
    let typeClass = 'type-image';
    let typeLabel = '단일 이미지';
    if (ad.is_carousel) {
      typeClass = 'type-carousel';
      typeLabel = '슬라이드';
    } else if (ad.media_type === 'video') {
      typeClass = 'type-video';
      typeLabel = '단일 비디오';
    }

    return `
      <div class="saved-ad-item" data-index="${index}">
        <span class="saved-ad-type ${typeClass}">${typeLabel}</span>
        <span class="saved-ad-name" title="${ad.ad_name}">${ad.ad_name}</span>
        <button type="button" class="saved-ad-delete" onclick="deleteSavedAd(${index})">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>
    `;
  }).join('');
}

// 저장된 광고 삭제
async function deleteSavedAd(index) {
  const ad = savedAdsList[index];
  if (!ad || !ad.id) return;

  try {
    // 서버에서도 삭제 (id 기반 DELETE)
    const response = await fetch(`/dashboard/remove_pending_ad/${ad.id}`, {
      method: 'DELETE',
      credentials: 'include'
    });

    const result = await response.json();
    if (result.status === 'success') {
      savedAdsList.splice(index, 1);
      renderSavedAdsList();
      updatePendingAdsCount();
      showToast('광고가 삭제되었습니다.', 'info', 2000);
    }
  } catch (error) {
    console.error('[STEP3] 광고 삭제 오류:', error);
    showToast('삭제 중 오류가 발생했습니다.', 'error');
  }
}

// 저장된 광고 목록 로드 (서버에서)
async function loadSavedAds() {
  try {
    const response = await fetch('/dashboard/get_pending_ads', {
      method: 'GET',
      credentials: 'include'
    });
    const result = await response.json();

    if (result.status === 'success') {
      savedAdsList = result.pending_ads || [];
      renderSavedAdsList();
    }
  } catch (error) {
    console.error('[STEP3] 저장된 광고 로드 오류:', error);
  }
}

// 마스터 설정 초기화
function resetMasterSettings() {
  masterValues = {
    adName: '',
    url: '',
    cta: 'SHOP_NOW',
    primaryText: '',
    headline: '',
    description: ''
  };

  // UI 초기화
  document.getElementById('masterAdName').value = '';
  document.getElementById('masterUrl').value = '';
  document.getElementById('masterCta').value = 'SHOP_NOW';
  document.getElementById('masterPrimaryText').value = '';
  document.getElementById('masterHeadline').value = '';
  document.getElementById('masterDescription').value = '';

  showToast('마스터 설정이 초기화되었습니다.', 'info', 2000);
}

// 광고 추가하기 버튼 클릭 핸들러 (Step 3에 머무름)
async function handleAddMoreButton() {
  console.log('[STEP3] 저장하고 광고추가 클릭 - pending_ads에 추가 후 Step 3 유지');

  try {
    // 현재 광고 데이터 구성 (중복 체크용)
    const selectedMedia = mediaItems.filter(m => selectedMediaIds.includes(m.id));
    const firstMedia = selectedMedia[0];
    const isCarousel = currentAdType === 'slide';

    let cards = [];
    if (isCarousel) {
      cards = selectedMedia.map(media => ({
        media_type: media.mediaType,
        video_id: media.videoId || null,
        image_hash: media.hash || null
      }));
    }

    const newAdData = {
      media_type: firstMedia?.mediaType || 'image',
      video_id: firstMedia?.videoId || null,
      image_hash: firstMedia?.hash || null,
      ad_name: getFullAdName() || `AD_${Date.now()}`,
      is_carousel: isCarousel,
      cards: cards
    };

    // 중복 체크
    if (checkDuplicateAd(newAdData)) {
      showToast('동일한 광고가 이미 저장되어 있습니다. (형식+소재+이름 중복)', 'warning', 3000);
      return;
    }

    showToast('광고를 저장하고 있습니다...', 'info', 1500);

    // 현재 광고 데이터를 서버 세션에 추가
    const result = await addToPendingAds();

    // 로컬 목록에도 추가 (서버에서 반환된 id 포함)
    savedAdsList.push({
      ...newAdData,
      id: result.ad_id,  // 서버에서 반환된 고유 ID
      message: masterValues.primaryText || '',
      headline: masterValues.headline || '',
      description: masterValues.description || '',
      link: masterValues.url || '',
      cta_type: masterValues.cta || 'SHOP_NOW',
      // 제품 표시 정보
      product_tags: !isCarousel && productTagsEnabled && selectedProductSet ? {
        enabled: true,
        product_set_id: selectedProductSet.id,
        product_set_name: selectedProductSet.name
      } : null
    });

    renderSavedAdsList();
    updatePendingAdsCount();

    showToast(`광고가 저장되었습니다. (총 ${result.total_count}개)`, 'success', 2000);

    // 마스터 설정은 유지, 광고 이름만 자동 증가
    const currentName = masterValues.adName || 'AD';
    const match = currentName.match(/^(.+?)(\d+)?$/);
    if (match) {
      const prefix = match[1];
      const num = match[2] ? parseInt(match[2]) + 1 : 2;
      masterValues.adName = `${prefix}${num}`;
      document.getElementById('masterAdName').value = masterValues.adName;
    }

  } catch (error) {
    showToast(`오류: ${error.message}`, 'error');
  }
}

// 최종 확인 모달 표시
function showConfirmModal() {
  const overlay = document.getElementById('confirmModalOverlay');
  const listEl = document.getElementById('confirmAdsList');

  // 통계 계산
  let imageCount = 0, videoCount = 0, carouselCount = 0;
  savedAdsList.forEach(ad => {
    if (ad.is_carousel) carouselCount++;
    else if (ad.media_type === 'video') videoCount++;
    else imageCount++;
  });

  document.getElementById('confirmTotalCount').textContent = savedAdsList.length;
  document.getElementById('confirmImageCount').textContent = imageCount;
  document.getElementById('confirmVideoCount').textContent = videoCount;
  document.getElementById('confirmCarouselCount').textContent = carouselCount;

  // 광고 목록 렌더링
  listEl.innerHTML = savedAdsList.map((ad, index) => {
    let typeLabel = ad.is_carousel ? '슬라이드' : (ad.media_type === 'video' ? '단일 비디오' : '단일 이미지');
    let mediaCount = ad.is_carousel ? `${ad.cards?.length || 0}장` : '1장';

    return `
      <div class="confirm-ad-item">
        <span class="confirm-ad-index">${index + 1}</span>
        <div class="confirm-ad-info">
          <div class="confirm-ad-name">${ad.ad_name}</div>
          <div class="confirm-ad-meta">${typeLabel} · ${mediaCount}</div>
        </div>
      </div>
    `;
  }).join('');

  overlay.classList.add('active');
}

// 최종 확인 모달 닫기
function hideConfirmModal() {
  document.getElementById('confirmModalOverlay').classList.remove('active');
}

// Step 4로 실제 이동
function proceedToStep4() {
  // sessionStorage에 상태 저장
  const step3Data = {
    adType: currentAdType,
    selectedMediaIds: selectedMediaIds,
    masterValues: masterValues,
    cardLocks: cardLocks,
    cardValues: cardValues,
    // 제품 표시 정보
    productTags: {
      enabled: productTagsEnabled,
      productSet: selectedProductSet
    }
  };
  sessionStorage.setItem('admake_step3_state', JSON.stringify(step3Data));

  hideConfirmModal();
  showToast('Step 4로 이동합니다...', 'success', 1500);

  setTimeout(() => {
    window.location.href = `/admake/manage?account_id=${encodeURIComponent(accountId)}`;
  }, 800);
}

// 다음 단계로 버튼 클릭 핸들러 (확인 모달 표시)
async function handleNextButton() {
  console.log('[STEP3] 다음 단계로 클릭 - 최종 확인 모달 표시');

  if (savedAdsList.length === 0) {
    showToast('저장된 광고가 없습니다. 먼저 광고를 저장해주세요.', 'warning', 3000);
    return;
  }

  showConfirmModal();
}

// pending_ads 카운트 표시
async function updatePendingAdsCount() {
  try {
    const response = await fetch('/dashboard/get_pending_ads', {
      method: 'GET',
      credentials: 'include'
    });
    const result = await response.json();

    if (result.status === 'success' && result.total_count > 0) {
      const countEl = document.getElementById('pendingAdsCount');
      countEl.textContent = `대기 중 ${result.total_count}개`;
      countEl.style.display = 'inline-block';
    }
  } catch (error) {
    console.log('[STEP3] pending_ads 카운트 조회 실패:', error);
  }
}

// ===== 이탈 경고 모달 =====
let pendingExitUrl = null;
function showExitModal(url) { pendingExitUrl = url; document.getElementById('exitModalOverlay').classList.add('show'); }
function hideExitModal() { document.getElementById('exitModalOverlay').classList.remove('show'); pendingExitUrl = null; }
function clearAllAdmakeData() {
  return new Promise((resolve) => {
    sessionStorage.removeItem('admake_step1_state');
    sessionStorage.removeItem('admake_step2_results');
    sessionStorage.removeItem('admake_step3_state');
    sessionStorage.removeItem('admake_step4_state');
    sessionStorage.removeItem('admake_uploaded_results');
    try {
      const request = indexedDB.open('admake_files', 1);
      request.onsuccess = (event) => {
        const db = event.target.result;
        if (db.objectStoreNames.contains('files')) {
          const tx = db.transaction(['files'], 'readwrite');
          tx.objectStore('files').clear();
          tx.oncomplete = () => { db.close(); resolve(); };
          tx.onerror = () => { db.close(); resolve(); };
        } else { db.close(); resolve(); }
      };
      request.onerror = () => resolve();
    } catch (e) { resolve(); }
  });
}
// ===== 제품 표시 (Product Tags) 관련 함수 =====

// catalogId 로드 (accountId로 조회)
async function loadCatalogId() {
  if (!accountId) return;

  try {
    const res = await fetch('/dashboard/get_data', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ data_type: 'catalog_sidebar', account_id: accountId })
    });
    const json = await res.json();

    if (json.status === 'success' && json.catalog_sidebar?.catalog_id) {
      window.metaAdsState.catalogId = json.catalog_sidebar.catalog_id;
      window.metaAdsState.company = json.catalog_sidebar.company_name;
      console.log('[ProductTags] catalogId 로드:', window.metaAdsState.catalogId);
    }
  } catch (e) {
    console.error('[ProductTags] catalogId 로드 실패:', e);
  }
}

// 제품세트 목록 조회
async function fetchProductSets() {
  const catalogId = window.metaAdsState?.catalogId;
  if (!catalogId) {
    console.warn('[ProductTags] catalogId 없음');
    return [];
  }

  const refreshBtn = document.getElementById('refreshSetsBtn');
  if (refreshBtn) refreshBtn.classList.add('loading');

  try {
    const res = await fetch('/dashboard/catalog_sets', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ catalog_id: catalogId })
    });
    const json = await res.json();

    if (json.status === 'success') {
      productSetsList = json.product_sets || [];
      console.log('[ProductTags] 제품세트 목록 로드:', productSetsList.length, '개');
      return productSetsList;
    } else {
      console.error('[ProductTags] 조회 실패:', json.message);
      return [];
    }
  } catch (e) {
    console.error('[ProductTags] 조회 오류:', e);
    return [];
  } finally {
    if (refreshBtn) refreshBtn.classList.remove('loading');
  }
}

// 제품세트 드롭다운 렌더링
function renderProductSetsDropdown(sets) {
  const dropdown = document.getElementById('productSetDropdown');
  if (!dropdown) return;

  dropdown.innerHTML = '<option value="">제품세트를 선택하세요</option>';

  sets.forEach(set => {
    const option = document.createElement('option');
    option.value = set.id;
    option.textContent = `${set.name} (${set.product_count || 0}개)`;
    option.dataset.name = set.name;
    option.dataset.count = set.product_count || 0;
    dropdown.appendChild(option);
  });
}

// 제품세트 선택 처리
function handleProductSetSelect(e) {
  const dropdown = e.target;
  const selectedOption = dropdown.selectedOptions[0];

  if (!selectedOption || !selectedOption.value) {
    selectedProductSet = null;
    updateSelectedSetInfo();
    return;
  }

  selectedProductSet = {
    id: selectedOption.value,
    name: selectedOption.dataset.name,
    product_count: parseInt(selectedOption.dataset.count) || 0
  };

  console.log('[ProductTags] 제품세트 선택:', selectedProductSet);
  updateSelectedSetInfo();
}

// 선택된 제품세트 정보 표시
function updateSelectedSetInfo() {
  const infoEl = document.getElementById('selectedSetInfo');
  const nameEl = document.getElementById('selectedSetName');
  const countEl = document.getElementById('selectedSetCount');

  if (!infoEl) return;

  if (selectedProductSet) {
    nameEl.textContent = selectedProductSet.name;
    countEl.textContent = `${selectedProductSet.product_count}개 제품`;
    infoEl.classList.remove('hidden');
  } else {
    infoEl.classList.add('hidden');
  }
}

// 제품세트 선택 해제
function clearSelectedProductSet() {
  selectedProductSet = null;
  const dropdown = document.getElementById('productSetDropdown');
  if (dropdown) dropdown.value = '';
  updateSelectedSetInfo();
}

// 제품 표시 토글 처리
function handleProductTagsToggle(e) {
  productTagsEnabled = e.target.checked;
  const selector = document.getElementById('productTagsSelector');

  if (productTagsEnabled) {
    selector.classList.remove('hidden');
    // 제품세트 목록 로드 (최초 1회)
    if (productSetsList.length === 0) {
      fetchProductSets().then(sets => renderProductSetsDropdown(sets));
    }
  } else {
    selector.classList.add('hidden');
    selectedProductSet = null;
    updateSelectedSetInfo();
  }

  console.log('[ProductTags] 토글:', productTagsEnabled);
}

// 제품세트 소스 변경 (기존/새로 만들기)
function handleProductSetSourceChange(e) {
  const source = e.target.value;
  const existingSelector = document.getElementById('existingSetSelector');
  const newSelector = document.getElementById('newSetSelector');

  if (source === 'existing') {
    existingSelector.classList.remove('hidden');
    newSelector.classList.add('hidden');
  } else {
    existingSelector.classList.add('hidden');
    newSelector.classList.remove('hidden');
  }
}

// ===== 제품세트 만들기 모달 =====
let modalUrlProducts = [];      // URL로 수집된 상품
let modalSelectedUrlIds = new Set();  // URL 탭에서 선택된 상품
let modalSearchResults = [];    // 검색 결과
let modalManualProducts = [];   // 수동 탭에서 추가된 상품

// 모달 열기
function openProductSetModal() {
  const overlay = document.getElementById('productSetModalOverlay');
  overlay.classList.remove('hidden');
  requestAnimationFrame(() => overlay.classList.add('active'));

  // 초기화
  resetProductSetModal();
  console.log('[Modal] 제품세트 만들기 모달 열림');
}

// 모달 닫기
function closeProductSetModal() {
  const overlay = document.getElementById('productSetModalOverlay');
  overlay.classList.remove('active');
  setTimeout(() => overlay.classList.add('hidden'), 300);
}

// 모달 초기화
function resetProductSetModal() {
  modalUrlProducts = [];
  modalSelectedUrlIds = new Set();
  modalSearchResults = [];
  modalManualProducts = [];

  // 입력 필드 초기화
  document.getElementById('modalUrlInput').value = '';
  document.getElementById('modalSearchInput').value = '';
  document.getElementById('modalSetNameInput').value = '';

  // 테이블 초기화
  document.getElementById('modalUrlProducts').innerHTML = '<div class="empty-state">URL을 입력하고 불러오기를 클릭하세요</div>';
  document.getElementById('modalSearchResults').innerHTML = '<div class="empty-state">검색어를 입력하고 검색을 클릭하세요</div>';
  document.getElementById('modalSelectedProducts').innerHTML = '<div class="empty-state">검색 결과에서 상품을 추가하세요</div>';

  // 카운트 초기화
  document.getElementById('modalUrlCount').textContent = '0개 선택';
  document.getElementById('modalManualCount').textContent = '0개';

  // 첫 번째 탭 활성화
  document.querySelectorAll('.modal-tab').forEach((tab, i) => tab.classList.toggle('active', i === 0));
  document.querySelectorAll('.modal-tab-content').forEach((content, i) => content.classList.toggle('active', i === 0));
}

// 탭 전환
function handleModalTabChange(tabName) {
  document.querySelectorAll('.modal-tab').forEach(tab => {
    tab.classList.toggle('active', tab.dataset.tab === tabName);
  });
  document.getElementById('tabUrl').classList.toggle('active', tabName === 'url');
  document.getElementById('tabManual').classList.toggle('active', tabName === 'manual');
}

// URL로 상품 불러오기
async function fetchModalUrlProducts() {
  const url = document.getElementById('modalUrlInput').value.trim();
  if (!url) return showToast('URL을 입력해주세요.', 'warning');

  const loading = document.getElementById('modalUrlLoading');
  const fetchBtn = document.getElementById('modalFetchBtn');

  loading.classList.remove('hidden');
  fetchBtn.disabled = true;

  try {
    const res = await fetch('/dashboard/get_data', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ data_type: 'catalog_manual', category_url: url })
    });
    const json = await res.json();

    if (json.status === 'success' && json.products) {
      modalUrlProducts = json.products;
      modalSelectedUrlIds = new Set(modalUrlProducts.map(p => String(p.product_no)));
      renderModalUrlProducts();
      showToast(`${modalUrlProducts.length}개 상품을 불러왔습니다.`, 'success');
    } else {
      showToast(json.message || '상품을 불러올 수 없습니다.', 'error');
    }
  } catch (e) {
    console.error('[Modal] URL 상품 조회 오류:', e);
    showToast('상품 조회 중 오류가 발생했습니다.', 'error');
  } finally {
    loading.classList.add('hidden');
    fetchBtn.disabled = false;
  }
}

// URL 상품 목록 렌더링
function renderModalUrlProducts() {
  const container = document.getElementById('modalUrlProducts');

  if (modalUrlProducts.length === 0) {
    container.innerHTML = '<div class="empty-state">URL을 입력하고 불러오기를 클릭하세요</div>';
    return;
  }

  container.innerHTML = modalUrlProducts.map(p => {
    const checked = modalSelectedUrlIds.has(String(p.product_no)) ? 'checked' : '';
    return `<div class="modal-product-row">
      <input type="checkbox" data-product-no="${p.product_no}" ${checked} onchange="toggleModalUrlProduct('${p.product_no}')">
      <span class="product-name">${p.product_name}</span>
      <span class="product-no">${p.product_no}</span>
    </div>`;
  }).join('');

  updateModalUrlCount();
  updateModalSelectAll();
}

// URL 상품 선택 토글
function toggleModalUrlProduct(productNo) {
  if (modalSelectedUrlIds.has(productNo)) {
    modalSelectedUrlIds.delete(productNo);
  } else {
    modalSelectedUrlIds.add(productNo);
  }
  updateModalUrlCount();
  updateModalSelectAll();
}

// 전체 선택 토글
function toggleModalSelectAllUrl() {
  const selectAll = document.getElementById('modalSelectAllUrl');
  if (selectAll.checked) {
    modalSelectedUrlIds = new Set(modalUrlProducts.map(p => String(p.product_no)));
  } else {
    modalSelectedUrlIds.clear();
  }
  renderModalUrlProducts();
}

// 전체 선택 체크박스 상태 업데이트
function updateModalSelectAll() {
  const selectAll = document.getElementById('modalSelectAllUrl');
  const allSelected = modalUrlProducts.length > 0 && modalSelectedUrlIds.size === modalUrlProducts.length;
  const someSelected = modalSelectedUrlIds.size > 0 && modalSelectedUrlIds.size < modalUrlProducts.length;
  selectAll.checked = allSelected;
  selectAll.indeterminate = someSelected;
}

// URL 선택 카운트 업데이트
function updateModalUrlCount() {
  document.getElementById('modalUrlCount').textContent = `${modalSelectedUrlIds.size}개 선택`;
}

// 수동 검색
async function searchModalProducts() {
  const keyword = document.getElementById('modalSearchInput').value.trim();
  const searchType = document.getElementById('modalSearchType').value;

  if (!keyword) return showToast('검색어를 입력해주세요.', 'warning');

  const loading = document.getElementById('modalSearchLoading');
  const searchBtn = document.getElementById('modalSearchBtn');

  loading.classList.remove('hidden');
  searchBtn.disabled = true;

  try {
    const res = await fetch('/dashboard/get_data', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        data_type: 'catalog_manual_search',
        account_id: accountId,
        keyword: keyword,
        search_type: searchType
      })
    });
    const json = await res.json();

    if (json.status === 'success') {
      modalSearchResults = json.results || [];
      renderModalSearchResults();
      if (modalSearchResults.length === 0) {
        showToast('검색 결과가 없습니다.', 'info');
      }
    } else {
      showToast(json.message || '검색 실패', 'error');
    }
  } catch (e) {
    console.error('[Modal] 검색 오류:', e);
    showToast('검색 중 오류가 발생했습니다.', 'error');
  } finally {
    loading.classList.add('hidden');
    searchBtn.disabled = false;
  }
}

// 검색 결과 렌더링
function renderModalSearchResults() {
  const container = document.getElementById('modalSearchResults');

  if (modalSearchResults.length === 0) {
    container.innerHTML = '<div class="empty-state">검색 결과가 없습니다</div>';
    return;
  }

  container.innerHTML = modalSearchResults.map(p => {
    const isAdded = modalManualProducts.some(mp => mp.product_no === p.product_no);
    return `<div class="modal-product-row">
      <span class="product-name">${p.product_name}</span>
      <span class="product-no">${p.product_no}</span>
      <button class="add-btn" onclick="addModalManualProduct('${p.product_no}', '${p.product_name.replace(/'/g, "\\'")}')" ${isAdded ? 'disabled' : ''}>
        ${isAdded ? '추가됨' : '추가'}
      </button>
    </div>`;
  }).join('');
}

// 수동 상품 추가
function addModalManualProduct(productNo, productName) {
  if (modalManualProducts.some(p => p.product_no === productNo)) {
    return showToast('이미 추가된 상품입니다.', 'warning');
  }

  modalManualProducts.push({ product_no: productNo, product_name: productName });
  renderModalManualProducts();
  renderModalSearchResults();  // 버튼 상태 업데이트
}

// 수동 상품 제거
function removeModalManualProduct(productNo) {
  modalManualProducts = modalManualProducts.filter(p => p.product_no !== productNo);
  renderModalManualProducts();
  renderModalSearchResults();
}

// 추가된 상품 렌더링
function renderModalManualProducts() {
  const container = document.getElementById('modalSelectedProducts');

  if (modalManualProducts.length === 0) {
    container.innerHTML = '<div class="empty-state">검색 결과에서 상품을 추가하세요</div>';
    document.getElementById('modalManualCount').textContent = '0개';
    return;
  }

  container.innerHTML = modalManualProducts.map(p => `
    <div class="modal-product-row">
      <span class="product-name">${p.product_name}</span>
      <span class="product-no">${p.product_no}</span>
      <button class="remove-btn" onclick="removeModalManualProduct('${p.product_no}')">삭제</button>
    </div>
  `).join('');

  document.getElementById('modalManualCount').textContent = `${modalManualProducts.length}개`;
}

// 제품세트 생성
async function createProductSetFromModal() {
  const setName = document.getElementById('modalSetNameInput').value.trim();
  if (!setName) return showToast('세트명을 입력해주세요.', 'warning');

  // 현재 활성 탭 확인
  const isUrlTab = document.getElementById('tabUrl').classList.contains('active');

  let retailerIds = [];
  if (isUrlTab) {
    retailerIds = Array.from(modalSelectedUrlIds);
  } else {
    retailerIds = modalManualProducts.map(p => p.product_no);
  }

  if (retailerIds.length === 0) {
    return showToast('최소 1개 이상의 상품을 선택해주세요.', 'warning');
  }

  const catalogId = window.metaAdsState?.catalogId;
  if (!catalogId) {
    return showToast('카탈로그 ID를 찾을 수 없습니다.', 'error');
  }

  const submitBtn = document.getElementById('createProductSetModalBtn');
  submitBtn.disabled = true;
  submitBtn.textContent = '생성 중...';

  try {
    const res = await fetch('/dashboard/catalog_set', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        catalog_id: catalogId,
        set_name: setName,
        retailer_ids: retailerIds
      })
    });
    const json = await res.json();

    if (json.status === 'success') {
      showToast(`제품세트가 ${json.action === 'updated' ? '업데이트' : '생성'}되었습니다.`, 'success');

      // 드롭다운 새로고침 및 선택
      const sets = await fetchProductSets();
      renderProductSetsDropdown(sets);

      // 새로 생성된 세트 선택
      const dropdown = document.getElementById('productSetDropdown');
      if (dropdown && json.set_id) {
        dropdown.value = json.set_id;

        const matchedSet = sets.find(s => s.id === json.set_id);
        selectedProductSet = {
          id: json.set_id,
          name: setName,
          product_count: matchedSet?.product_count || retailerIds.length
        };
        updateSelectedSetInfo();

        // "기존 제품세트 사용" 선택
        const existingRadio = document.querySelector('input[name="productSetSource"][value="existing"]');
        if (existingRadio) {
          existingRadio.checked = true;
          handleProductSetSourceChange({ target: existingRadio });
        }
      }

      closeProductSetModal();
    } else {
      showToast(json.message || '제품세트 생성 실패', 'error');
    }
  } catch (e) {
    console.error('[Modal] 제품세트 생성 오류:', e);
    showToast('제품세트 생성 중 오류가 발생했습니다.', 'error');
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = '제품세트 만들기';
  }
}

// 모달 이벤트 핸들러 설정
function setupProductSetModalHandlers() {
  // 모달 열기 버튼 (기존 openCatalogForNewSet 대체)
  const openBtn = document.getElementById('openCatalogForNewSetBtn');
  if (openBtn) {
    openBtn.onclick = openProductSetModal;
  }

  // 모달 닫기
  document.getElementById('closeProductSetModalBtn')?.addEventListener('click', closeProductSetModal);
  document.getElementById('cancelProductSetModalBtn')?.addEventListener('click', closeProductSetModal);
  document.getElementById('productSetModalOverlay')?.addEventListener('click', (e) => {
    if (e.target.id === 'productSetModalOverlay') closeProductSetModal();
  });

  // 탭 전환
  document.querySelectorAll('.modal-tab').forEach(tab => {
    tab.addEventListener('click', () => handleModalTabChange(tab.dataset.tab));
  });

  // URL 탭
  document.getElementById('modalFetchBtn')?.addEventListener('click', fetchModalUrlProducts);
  document.getElementById('modalSelectAllUrl')?.addEventListener('change', toggleModalSelectAllUrl);

  // 수동 탭
  document.getElementById('modalSearchBtn')?.addEventListener('click', searchModalProducts);
  document.getElementById('modalSearchInput')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') searchModalProducts();
  });

  // 제품세트 생성
  document.getElementById('createProductSetModalBtn')?.addEventListener('click', createProductSetFromModal);

  console.log('[Modal] 제품세트 모달 핸들러 설정 완료');
}

// 기존 함수 유지 (호환성)
function openCatalogForNewSet() {
  openProductSetModal();
}

// 제품 표시 이벤트 핸들러 설정
function setupProductTagsHandlers() {
  // 토글 스위치
  const toggleEl = document.getElementById('productTagsEnabled');
  if (toggleEl) {
    toggleEl.addEventListener('change', handleProductTagsToggle);
  }

  // 제품세트 소스 라디오 버튼
  document.querySelectorAll('input[name="productSetSource"]').forEach(radio => {
    radio.addEventListener('change', handleProductSetSourceChange);
  });

  // 제품세트 드롭다운
  const dropdown = document.getElementById('productSetDropdown');
  if (dropdown) {
    dropdown.addEventListener('change', handleProductSetSelect);
  }

  // 새로고침 버튼
  const refreshBtn = document.getElementById('refreshSetsBtn');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', async () => {
      const sets = await fetchProductSets();
      renderProductSetsDropdown(sets);
      showToast('제품세트 목록을 새로고침했습니다.', 'info');
    });
  }

  // 선택 해제 버튼
  const clearBtn = document.getElementById('clearSelectedSetBtn');
  if (clearBtn) {
    clearBtn.addEventListener('click', clearSelectedProductSet);
  }

  // 새 제품세트 만들기 버튼
  const newSetBtn = document.getElementById('openCatalogForNewSetBtn');
  if (newSetBtn) {
    newSetBtn.addEventListener('click', openCatalogForNewSet);
  }

  // 카탈로그 사이드바에서 제품세트 생성 시 드롭다운 새로고침
  window.addEventListener('productSetCreated', async (e) => {
    console.log('[ProductTags] 새 제품세트 생성됨:', e.detail);

    // 드롭다운 새로고침
    const sets = await fetchProductSets();
    renderProductSetsDropdown(sets);

    // 새로 생성된 세트 자동 선택
    const dropdown = document.getElementById('productSetDropdown');
    if (dropdown && e.detail.set_id) {
      dropdown.value = e.detail.set_id;

      // 선택 상태 업데이트
      selectedProductSet = {
        id: e.detail.set_id,
        name: e.detail.set_name,
        product_count: 0  // 정확한 수는 새로고침된 목록에서 가져옴
      };

      // 목록에서 정확한 product_count 찾기
      const matchedSet = sets.find(s => s.id === e.detail.set_id);
      if (matchedSet) {
        selectedProductSet.product_count = matchedSet.product_count;
      }

      updateSelectedSetInfo();

      // "기존 제품세트 사용" 옵션 선택
      const existingRadio = document.querySelector('input[name="productSetSource"][value="existing"]');
      if (existingRadio) {
        existingRadio.checked = true;
        handleProductSetSourceChange({ target: existingRadio });
      }
    }

    showToast('새 제품세트가 자동으로 선택되었습니다.', 'success');
  });

  console.log('[ProductTags] 이벤트 핸들러 설정 완료');
}

function setupExitModalHandlers() {
  document.querySelectorAll('[data-exit-link="true"]').forEach(link => {
    link.addEventListener('click', (e) => { e.preventDefault(); showExitModal(link.href); });
  });
  document.getElementById('exitCancelBtn').addEventListener('click', hideExitModal);
  document.getElementById('exitConfirmBtn').addEventListener('click', async () => {
    await clearAllAdmakeData();
    if (pendingExitUrl) window.location.href = pendingExitUrl;
  });
  document.getElementById('exitModalOverlay').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) hideExitModal();
  });
}

// ===== 초기화 =====
document.addEventListener('DOMContentLoaded', async () => {
  console.log('[STEP3] DOMContentLoaded');

  // Lucide 아이콘 초기화
  lucide.createIcons();

  // 이탈 경고 모달 핸들러
  setupExitModalHandlers();

  // 제품 표시 핸들러
  setupProductTagsHandlers();

  // 제품세트 만들기 모달 핸들러
  setupProductSetModalHandlers();

  // catalogId 로드 (제품 표시 기능용) - 백그라운드에서 로드
  loadCatalogId();

  // 데이터 로드
  await loadStep2Data();

  // 광고 이름 접두사 초기화
  updateAdNamePrefix();

  // 광고 유형 버튼 이벤트
  document.querySelectorAll('.admake-type-btn').forEach(btn => {
    btn.addEventListener('click', () => handleAdTypeChange(btn.dataset.type));
  });

  // 마스터 필드 이벤트
  document.getElementById('masterAdName').addEventListener('input', (e) => handleMasterChange('adName', e.target.value));
  document.getElementById('masterUrl').addEventListener('input', (e) => handleMasterChange('url', e.target.value));
  document.getElementById('masterCta').addEventListener('change', (e) => handleMasterChange('cta', e.target.value));
  document.getElementById('masterPrimaryText').addEventListener('input', (e) => handleMasterChange('primaryText', e.target.value));
  document.getElementById('masterHeadline').addEventListener('input', (e) => handleMasterChange('headline', e.target.value));
  document.getElementById('masterDescription').addEventListener('input', (e) => handleMasterChange('description', e.target.value));

  // 미리보기 탭 이벤트
  document.querySelectorAll('.admake-preview-tab').forEach(tab => {
    tab.addEventListener('click', () => handlePreviewTabChange(tab.dataset.format));
  });

  // 이전/다음/광고추가 버튼
  document.getElementById('backBtn').addEventListener('click', handleBackButton);
  document.getElementById('addMoreBtn').addEventListener('click', handleAddMoreButton);
  document.getElementById('nextBtn').addEventListener('click', handleNextButton);

  // 마스터 설정 리셋 버튼
  document.getElementById('masterResetBtn').addEventListener('click', resetMasterSettings);

  // 최종 확인 모달 이벤트
  document.getElementById('confirmModalClose').addEventListener('click', hideConfirmModal);
  document.getElementById('confirmCancelBtn').addEventListener('click', hideConfirmModal);
  document.getElementById('confirmProceedBtn').addEventListener('click', proceedToStep4);
  document.getElementById('confirmModalOverlay').addEventListener('click', (e) => {
    if (e.target.id === 'confirmModalOverlay') hideConfirmModal();
  });

  // 저장된 광고 목록 로드
  await loadSavedAds();

  // pending_ads 카운트 표시
  updatePendingAdsCount();

  // Step 2에서 Landing URL 가져오기
  const step1Data = sessionStorage.getItem('admake_step1_state');
  if (step1Data) {
    try {
      const parsed = JSON.parse(step1Data);
      if (parsed.landingUrl) {
        document.getElementById('masterUrl').value = parsed.landingUrl;
        masterValues.url = parsed.landingUrl;
        console.log('[STEP3] Landing URL 로드:', parsed.landingUrl);
      }
    } catch (e) {
      console.error('[STEP3] Step 1 데이터 파싱 오류:', e);
    }
  }

  updateNextButton();
  console.log('[STEP3] 초기화 완료');
});
</script>

</body>
</html>
