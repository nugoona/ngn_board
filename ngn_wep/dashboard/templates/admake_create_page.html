<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê´‘ê³  ë§Œë“¤ê¸° - ADMAKE</title>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/favicon.ico') }}">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=1.4">
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #f9fafb;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      min-height: 100vh;
    }

    /* âœ… Progress Bar ìŠ¤íƒ€ì¼ */
    .admake-progress-bar {
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      padding: 24px 40px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
    }

    .admake-progress-steps {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .admake-progress-step {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
      letter-spacing: 0.05em;
    }

    .admake-progress-step.active {
      color: #111827;
    }

    .admake-progress-step.completed {
      color: #059669;
    }

    .admake-progress-connector {
      width: 40px;
      height: 2px;
      background: #e5e7eb;
      margin: 0 8px;
    }

    .admake-progress-connector.completed {
      background: #059669;
    }

    /* âœ… ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ */
    .admake-create-wrapper {
      max-width: 1400px;
      margin: 0 auto;
      padding: 40px;
    }

    .admake-create-layout {
      display: flex;
      gap: 32px;
      margin-top: 32px;
    }

    .admake-create-left {
      flex: 6;
      min-width: 0;
    }

    .admake-create-right {
      flex: 4;
      min-width: 0;
    }

    /* âœ… ì—…ë¡œë“œ ì˜ì—­ ìŠ¤íƒ€ì¼ */
    .admake-upload-area {
      background: #ffffff;
      border: 2px dashed #d1d5db;
      border-radius: 1rem;
      padding: 64px 32px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 8px 8px 0px 0px rgba(0, 0, 0, 0.03);
      position: relative;
      z-index: 1;
    }

    .admake-upload-area:hover {
      border-color: #111827;
      background: #f9fafb;
      box-shadow: 12px 12px 0px 0px rgba(0, 0, 0, 0.05);
    }

    .admake-upload-area.dragover {
      border-color: #111827;
      background: #f3f4f6;
      box-shadow: 12px 12px 0px 0px rgba(0, 0, 0, 0.05);
    }

    .admake-upload-icon {
      font-size: 48px;
      margin-bottom: 16px;
      color: #9ca3af;
    }

    .admake-upload-text {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }

    .admake-upload-hint {
      font-size: 14px;
      color: #6b7280;
      margin-top: 8px;
    }

    .admake-file-input {
      display: none;
    }

    /* âœ… ì¸ë„¤ì¼ ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼ */
    .admake-thumbnails-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-top: 32px;
    }

    .admake-thumbnail-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 0.75rem;
      overflow: hidden;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      box-shadow: 4px 4px 0px 0px rgba(0, 0, 0, 0.03);
    }

    .admake-thumbnail-image,
    .admake-thumbnail-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .admake-thumbnail-video {
      background: #000000;
    }

    .admake-thumbnail-delete {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      background: rgba(0, 0, 0, 0.7);
      color: #ffffff;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 700;
      transition: all 0.2s ease;
      box-shadow: 2px 2px 0px 0px rgba(0, 0, 0, 0.2);
    }

    .admake-thumbnail-delete:hover {
      background: rgba(220, 38, 38, 0.9);
      transform: scale(1.1);
    }

    /* âœ… ëœë”© ì„¤ì • ì˜ì—­ ìŠ¤íƒ€ì¼ */
    .admake-settings-card {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 1rem;
      padding: 32px;
      box-shadow: 8px 8px 0px 0px rgba(0, 0, 0, 0.03);
    }

    .admake-settings-label {
      font-size: 14px;
      font-weight: 700;
      color: #111827;
      letter-spacing: 0.1em;
      margin-bottom: 12px;
      display: block;
    }

    .admake-settings-input {
      width: 100%;
      padding: 14px 16px;
      font-size: 14px;
      font-family: 'Inter', sans-serif;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      background: #ffffff;
      color: #111827;
      transition: all 0.2s ease;
      box-shadow: 2px 2px 0px 0px rgba(0, 0, 0, 0.02);
      letter-spacing: 0.02em;
    }

    .admake-settings-input:focus {
      outline: none;
      border-color: #111827;
      box-shadow: 4px 4px 0px 0px rgba(0, 0, 0, 0.05);
    }

    /* âœ… í•˜ë‹¨ ë²„íŠ¼ ì˜ì—­ */
    .admake-action-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #ffffff;
      border-top: 1px solid #e5e7eb;
      padding: 20px 40px;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
    }

    .admake-action-buttons {
      display: flex;
      gap: 16px;
      margin-left: auto;
    }

    .admake-btn {
      padding: 14px 32px;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 0.1em;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      box-shadow: 4px 4px 0px 0px rgba(0, 0, 0, 0.1);
    }

    .admake-btn-secondary {
      background: #f3f4f6;
      color: #6b7280;
    }

    .admake-btn-secondary:hover {
      background: #e5e7eb;
      transform: translateY(-2px);
      box-shadow: 6px 6px 0px 0px rgba(0, 0, 0, 0.12);
    }

    .admake-btn-primary {
      background: #111827;
      color: #ffffff;
    }

    .admake-btn-primary:hover:not(:disabled) {
      background: #1f2937;
      transform: translateY(-2px);
      box-shadow: 6px 6px 0px 0px rgba(0, 0, 0, 0.15);
    }

    .admake-btn-primary:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
    }

    .admake-btn-primary:active:not(:disabled) {
      transform: translateY(2px);
      box-shadow: 2px 2px 0px 0px rgba(0, 0, 0, 0.1);
    }

    /* âœ… ë©”ì¸ ì»¨í…ì¸  í•˜ë‹¨ ì—¬ë°± (ë²„íŠ¼ ì˜ì—­ ê³ ë ¤) */
    .admake-create-wrapper {
      padding-bottom: 100px;
    }

    /* âœ… ëª¨ë°”ì¼ ë°˜ì‘í˜• */
    @media (max-width: 1024px) {
      .admake-create-layout {
        flex-direction: column;
      }

      .admake-thumbnails-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .admake-create-wrapper {
        padding: 20px;
      }

      .admake-progress-bar {
        padding: 16px 20px;
      }

      .admake-progress-steps {
        flex-wrap: wrap;
        gap: 8px;
      }

      .admake-progress-connector {
        display: none;
      }

      .admake-thumbnails-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .admake-action-bar {
        padding: 16px 20px;
        flex-direction: column;
        gap: 12px;
      }

      .admake-action-buttons {
        width: 100%;
        margin-left: 0;
      }

      .admake-btn {
        flex: 1;
        padding: 12px 24px;
      }
    }
  </style>
</head>
<body>

<script>
  var userCompanyList = {{ session['company_names'] | tojson }};
  var currentUserId = "{{ session['user_id'] }}";
  var accountId = "{{ account_id }}";
</script>
<script src="{{ url_for('static', filename='js/mobile_detection.js') }}"></script>

<!-- âœ… í–„ë²„ê±° ë©”ë‰´ -->
<div class="nav-buttons">
  <div class="nav-left">
    <div id="updatedAtText" class="updated-at-text">ê´‘ê³  ë§Œë“¤ê¸°</div>
  </div>
  <div class="nav-right">
    <div class="hamburger-menu-wrapper">
      <div class="hamburger-icon" id="hamburgerIcon">
        <div></div><div></div><div></div>
      </div>
      <div class="hamburger-dropdown" id="hamburgerDropdown">
        <a href="/" class="{% if request.path == '/' %}active{% endif %}">ì‚¬ì´íŠ¸ ì„±ê³¼</a>
        <a href="{{ url_for('ads_page') }}" class="{% if request.path == '/ads' %}active{% endif %}">ê´‘ê³  ì„±ê³¼</a>
        <a href="{{ url_for('trend_selection_page') }}" class="{% if request.path.startswith('/trend') %}active{% endif %}">TREND</a>
        <a href="{{ url_for('auth.logout') }}">ë¡œê·¸ì•„ì›ƒ</a>
      </div>
    </div>
  </div>
</div>

<!-- âœ… Progress Bar -->
<div class="admake-progress-bar">
  <div class="admake-progress-steps">
    <div class="admake-progress-step active">STEP 1</div>
    <div class="admake-progress-connector"></div>
    <div class="admake-progress-step">STEP 2</div>
    <div class="admake-progress-connector"></div>
    <div class="admake-progress-step">STEP 3</div>
    <div class="admake-progress-connector"></div>
    <div class="admake-progress-step">STEP 4</div>
    <div class="admake-progress-connector"></div>
    <div class="admake-progress-step">STEP 5</div>
  </div>
</div>

<!-- âœ… ë©”ì¸ ì»¨í…ì¸  -->
<div class="admake-create-wrapper">
  <div class="admake-create-layout">
    <!-- ì¢Œì¸¡: ë¯¸ë””ì–´ ì—…ë¡œë“œ ì˜ì—­ -->
    <div class="admake-create-left">
      <div class="admake-upload-area" id="uploadArea">
        <div class="admake-upload-icon">ğŸ“</div>
        <div class="admake-upload-text">ì´ë¯¸ì§€ ë° ë™ì˜ìƒì„ ë“œë˜ê·¸ ì•¤ ë“œë¡­í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</div>
        <div class="admake-upload-hint">ìµœëŒ€ 10ê°œê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥ (ì´ë¯¸ì§€: jpg, png, gif / ë™ì˜ìƒ: mp4, mov ë“±)</div>
        <input type="file" id="fileInput" class="admake-file-input" multiple accept="image/*,video/*">
      </div>

      <!-- ì¸ë„¤ì¼ ê·¸ë¦¬ë“œ -->
      <div class="admake-thumbnails-grid" id="thumbnailsGrid"></div>
    </div>

    <!-- ìš°ì¸¡: ëœë”© ì„¤ì • ì˜ì—­ -->
    <div class="admake-create-right">
      <div class="admake-settings-card">
        <label class="admake-settings-label" for="landingUrl">ìƒì„¸í˜ì´ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”</label>
        <input 
          type="url" 
          id="landingUrl" 
          class="admake-settings-input" 
          placeholder="https://example.com/product?utm_source=..."
          autocomplete="off"
        >
      </div>
    </div>
  </div>
</div>

<!-- âœ… í•˜ë‹¨ ì•¡ì…˜ ë°” -->
<div class="admake-action-bar">
  <div></div>
  <div class="admake-action-buttons">
    <button class="admake-btn admake-btn-secondary" id="cancelBtn">ì·¨ì†Œ</button>
    <button class="admake-btn admake-btn-primary" id="nextBtn" disabled>ë‹¤ìŒ: í¬ë¡­ ë° ê°€ì´ë“œ</button>
  </div>
</div>

<script src="{{ url_for('static', filename='js/common.js') }}"></script>
<script src="{{ url_for('static', filename='js/common_ui.js') }}"></script>

<script>
// âœ… ìƒíƒœ ê´€ë¦¬ - ê°œì„ ëœ ë°ì´í„° êµ¬ì¡°
let mediaItems = []; // { id, file, previewUrl, type }
let hasUnsavedChanges = false;
let mediaIdCounter = 0;
let isNavigatingToNextStep = false; // Step 2ë¡œ ì´ë™ ì¤‘ì¸ì§€ í”Œë˜ê·¸

// âœ… DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
let uploadArea, fileInput, thumbnailsGrid, landingUrlInput, nextBtn, cancelBtn;

// âœ… DOM ë¡œë“œ í›„ ì´ˆê¸°í™”
function initDOMElements() {
  uploadArea = document.getElementById('uploadArea');
  fileInput = document.getElementById('fileInput');
  thumbnailsGrid = document.getElementById('thumbnailsGrid');
  landingUrlInput = document.getElementById('landingUrl');
  nextBtn = document.getElementById('nextBtn');
  cancelBtn = document.getElementById('cancelBtn');
  
  if (!uploadArea || !fileInput || !thumbnailsGrid || !landingUrlInput || !nextBtn || !cancelBtn) {
    console.error('[ERROR] í•„ìˆ˜ DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return false;
  }
  
  return true;
}

// âœ… ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
function setupEventListeners() {
  // ì—…ë¡œë“œ ì˜ì—­ í´ë¦­
  uploadArea.addEventListener('click', () => {
    fileInput.click();
  });

  // íŒŒì¼ ì„ íƒ
  fileInput.addEventListener('change', (e) => {
    handleFiles(Array.from(e.target.files));
    fileInput.value = ''; // ê°™ì€ íŒŒì¼ ì¬ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡ ì´ˆê¸°í™”
  });

  // ë“œë˜ê·¸ ì•¤ ë“œë¡­ - ì—…ë¡œë“œ ì˜ì—­
  uploadArea.addEventListener('dragenter', (e) => {
    e.preventDefault();
    e.stopPropagation();
    uploadArea.classList.add('dragover');
  });

  uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    e.stopPropagation();
    uploadArea.classList.add('dragover');
  });

  uploadArea.addEventListener('dragleave', (e) => {
    e.preventDefault();
    e.stopPropagation();
    uploadArea.classList.remove('dragover');
  });

  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    e.stopPropagation();
    uploadArea.classList.remove('dragover');
    
    const files = Array.from(e.dataTransfer.files).filter(file => 
      file.type.startsWith('image/') || file.type.startsWith('video/')
    );
    
    if (files.length > 0) {
      handleFiles(files);
    }
  });

  // ì „ì²´ í˜ì´ì§€ ë ˆë²¨ì—ì„œ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ë³¸ ë™ì‘ ë°©ì§€
  document.addEventListener('dragenter', (e) => {
    e.preventDefault();
    e.stopPropagation();
  });

  document.addEventListener('dragover', (e) => {
    e.preventDefault();
    e.stopPropagation();
  });

  document.addEventListener('drop', (e) => {
    e.preventDefault();
    e.stopPropagation();
    // ì—…ë¡œë“œ ì˜ì—­ ë°–ì— ë“œë¡­ëœ ê²½ìš° ë¬´ì‹œ
  });
  
  // URL ì…ë ¥ ê°ì§€ (URLì€ ì„ íƒì‚¬í•­ì´ë¯€ë¡œ ë²„íŠ¼ ìƒíƒœëŠ” ë³€ê²½í•˜ì§€ ì•ŠìŒ)
  landingUrlInput.addEventListener('input', () => {
    hasUnsavedChanges = true;
  });

  // ì·¨ì†Œ ë²„íŠ¼ í´ë¦­
  cancelBtn.addEventListener('click', () => {
    if (hasUnsavedChanges) {
      if (confirm('ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ì‚­ì œë©ë‹ˆë‹¤. ì •ë§ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        // ì·¨ì†Œ í”Œë˜ê·¸ ì„¤ì • (beforeunloadì—ì„œ URL ì •ë¦¬)
        sessionStorage.setItem('admake_cancelling', 'true');
        // ë¯¸ë””ì–´ URL í•´ì œ
        mediaItems.forEach(item => {
          try {
            URL.revokeObjectURL(item.previewUrl);
          } catch (e) {
            console.warn('URL revoke ì‹¤íŒ¨:', e);
          }
        });
        // IndexedDB ë°ì´í„°ë„ ì •ë¦¬
        if ('indexedDB' in window) {
          const dbName = 'admake_files';
          const request = indexedDB.open(dbName, 1);
          request.onsuccess = (event) => {
            const db = event.target.result;
            if (db.objectStoreNames.contains('files')) {
              const transaction = db.transaction(['files'], 'readwrite');
              const store = transaction.objectStore('files');
              store.clear();
            }
          };
        }
        sessionStorage.removeItem('admake_step1_state');
        window.location.href = `/admake?account_id=${encodeURIComponent(accountId)}`;
      }
    } else {
      window.location.href = `/admake?account_id=${encodeURIComponent(accountId)}`;
    }
  });

  // ë‹¤ìŒ ë²„íŠ¼ í´ë¦­
  nextBtn.addEventListener('click', async () => {
    if (nextBtn.disabled) return;
    
    isNavigatingToNextStep = true; // Step 2ë¡œ ì´ë™ í”Œë˜ê·¸ ì„¤ì •
    
    // ìƒíƒœë¥¼ sessionStorageì— ì €ì¥ (ë‹¤ìŒ Stepì—ì„œ ì‚¬ìš©)
    const stateData = {
      accountId: accountId,
      mediaItems: mediaItems.map(item => ({
        id: item.id,
        name: item.file.name,
        size: item.file.size,
        type: item.file.type,
        mediaType: item.type, // 'image' or 'video'
        previewUrl: item.previewUrl // Blob URL ìœ ì§€ (revokeí•˜ì§€ ì•ŠìŒ)
      })),
      landingUrl: landingUrlInput.value.trim() || '' // URLì€ ì„ íƒì‚¬í•­
    };
    
    sessionStorage.setItem('admake_step1_state', JSON.stringify(stateData));
    console.log('[DEBUG] Step 1 ìƒíƒœ ì €ì¥ ì™„ë£Œ:', stateData);
    
    // File ê°ì²´ë“¤ì„ IndexedDBì— ì €ì¥ (ë‹¤ìŒ Stepì—ì„œ ì‚¬ìš©)
    try {
      // IndexedDBê°€ ì§€ì›ë˜ëŠ” ê²½ìš°ì—ë§Œ ì‚¬ìš©
      if ('indexedDB' in window) {
        const dbName = 'admake_files';
        const request = indexedDB.open(dbName, 1);
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('files')) {
            db.createObjectStore('files', { keyPath: 'id' });
          }
        };
        
        request.onsuccess = (event) => {
          const db = event.target.result;
          const transaction = db.transaction(['files'], 'readwrite');
          const store = transaction.objectStore('files');
          
          mediaItems.forEach(item => {
            store.put({
              id: item.id,
              file: item.file,
              previewUrl: item.previewUrl,
              type: item.type,
              mediaType: item.mediaType
            });
          });
          
          transaction.oncomplete = () => {
            console.log('[DEBUG] IndexedDB ì €ì¥ ì™„ë£Œ');
            hasUnsavedChanges = false;
            // Blob URLì€ revokeí•˜ì§€ ì•Šê³  Step 2ë¡œ ì´ë™
            window.location.href = `/admake/crop?account_id=${encodeURIComponent(accountId)}`;
          };
        };
        
        request.onerror = () => {
          // IndexedDB ì‹¤íŒ¨ ì‹œ ê·¸ëƒ¥ ì§„í–‰ (previewUrlë§Œ ì‚¬ìš©)
          console.warn('IndexedDB ì €ì¥ ì‹¤íŒ¨, previewUrlë§Œ ì‚¬ìš©');
          hasUnsavedChanges = false;
          window.location.href = `/admake/crop?account_id=${encodeURIComponent(accountId)}`;
        };
      } else {
        // IndexedDB ë¯¸ì§€ì› ì‹œ ê·¸ëƒ¥ ì§„í–‰
        hasUnsavedChanges = false;
        window.location.href = `/admake/crop?account_id=${encodeURIComponent(accountId)}`;
      }
    } catch (e) {
      console.error('IndexedDB ì˜¤ë¥˜:', e);
      hasUnsavedChanges = false;
      window.location.href = `/admake/crop?account_id=${encodeURIComponent(accountId)}`;
    }
  });
}

// íŒŒì¼ ì²˜ë¦¬ í•¨ìˆ˜
function handleFiles(files) {
  const remainingSlots = 10 - mediaItems.length;
  const filesToAdd = files.slice(0, remainingSlots);
  
  if (files.length > remainingSlots) {
    alert(`ìµœëŒ€ 10ê°œê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤. ${remainingSlots}ê°œë§Œ ì¶”ê°€ë©ë‹ˆë‹¤.`);
  }

  filesToAdd.forEach(file => {
    if (mediaItems.length >= 10) return;
    
    // íŒŒì¼ íƒ€ì… í™•ì¸
    const isImage = file.type.startsWith('image/');
    const isVideo = file.type.startsWith('video/');
    
    if (!isImage && !isVideo) {
      alert(`${file.name}ì€(ëŠ”) ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.`);
      return;
    }
    
    const previewUrl = URL.createObjectURL(file);
    const mediaItem = {
      id: `media_${++mediaIdCounter}_${Date.now()}`,
      file: file,
      previewUrl: previewUrl,
      type: isImage ? 'image' : 'video'
    };
    
    mediaItems.push(mediaItem);
    hasUnsavedChanges = true;
    
    renderThumbnail(mediaItem);
  });
  
  updateNextButtonState();
}

// ì¸ë„¤ì¼ ë Œë”ë§ - ë¯¸ë””ì–´ íƒ€ì…ë³„ ì¡°ê±´ë¶€ ë Œë”ë§
function renderThumbnail(mediaItem) {
  const thumbnailItem = document.createElement('div');
  thumbnailItem.className = 'admake-thumbnail-item';
  thumbnailItem.setAttribute('data-id', mediaItem.id);
  
  let mediaElement = '';
  if (mediaItem.type === 'video') {
    mediaElement = `
      <video 
        src="${mediaItem.previewUrl}" 
        class="admake-thumbnail-video"
        muted
        playsinline
        loop
        autoplay
      ></video>
    `;
  } else {
    mediaElement = `
      <img 
        src="${mediaItem.previewUrl}" 
        class="admake-thumbnail-image" 
        alt="ì—…ë¡œë“œëœ ì´ë¯¸ì§€"
      >
    `;
  }
  
  thumbnailItem.innerHTML = `
    ${mediaElement}
    <button class="admake-thumbnail-delete" data-id="${mediaItem.id}">Ã—</button>
  `;
  
  thumbnailsGrid.appendChild(thumbnailItem);
  
  // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
  const deleteBtn = thumbnailItem.querySelector('.admake-thumbnail-delete');
  deleteBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    deleteThumbnail(mediaItem.id);
  });
}

// ì¸ë„¤ì¼ ì‚­ì œ
function deleteThumbnail(mediaId) {
  const index = mediaItems.findIndex(item => item.id === mediaId);
  if (index === -1) return;
  
  const mediaItem = mediaItems[index];
  
  // URL í•´ì œ
  URL.revokeObjectURL(mediaItem.previewUrl);
  
  // ë°°ì—´ì—ì„œ ì œê±°
  mediaItems.splice(index, 1);
  
  hasUnsavedChanges = true;
  
  // ê·¸ë¦¬ë“œ ì¬ë Œë”ë§
  thumbnailsGrid.innerHTML = '';
  mediaItems.forEach(item => {
    renderThumbnail(item);
  });
  
  updateNextButtonState();
}

// ë‹¤ìŒ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateNextButtonState() {
  const hasFiles = mediaItems.length > 0;
  const hasUrl = landingUrlInput && landingUrlInput.value.trim().length > 0;
  
  // íŒŒì¼ë§Œ ìˆìœ¼ë©´ í™œì„±í™” (URLì€ ì„ íƒì‚¬í•­)
  if (nextBtn) {
    nextBtn.disabled = !hasFiles;
    
    // ë””ë²„ê¹…ìš© ì½˜ì†” ë¡œê·¸
    console.log('[DEBUG] ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸:', {
      hasFiles: hasFiles,
      hasUrl: hasUrl,
      disabled: nextBtn.disabled,
      mediaItemsCount: mediaItems.length
    });
  }
}

// âœ… Step 1 ë°ì´í„° ë³µì› (í˜ì´ì§€ ë¡œë“œ ì‹œ)
function restoreStep1Data() {
  const step1Data = sessionStorage.getItem('admake_step1_state');
  if (!step1Data) {
    console.log('[DEBUG] ë³µì›í•  Step 1 ë°ì´í„° ì—†ìŒ');
    return;
  }

  try {
    const data = JSON.parse(step1Data);
    
    // IndexedDBì—ì„œ File ê°ì²´ ë³µì›
    if ('indexedDB' in window) {
      const dbName = 'admake_files';
      const request = indexedDB.open(dbName, 1);
      
      request.onsuccess = (event) => {
        const db = event.target.result;
        if (!db.objectStoreNames.contains('files')) {
          console.log('[DEBUG] IndexedDBì— íŒŒì¼ ì €ì¥ì†Œ ì—†ìŒ');
          return;
        }
        
        const transaction = db.transaction(['files'], 'readonly');
        const store = transaction.objectStore('files');
        
        // ëª¨ë“  ë¯¸ë””ì–´ í•­ëª© ë³µì›
        const restorePromises = data.mediaItems.map(item => {
          return new Promise((resolve) => {
            const getRequest = store.get(item.id);
            getRequest.onsuccess = () => {
              if (getRequest.result && getRequest.result.file) {
                // File ê°ì²´ê°€ ìˆìœ¼ë©´ ìƒˆë¡œìš´ Blob URL ìƒì„±
                const file = getRequest.result.file;
                const previewUrl = URL.createObjectURL(file);
                
                // ===== [í•µì‹¬] ë™ì˜ìƒ ì¸ë„¤ì¼ ìœ ì‹¤ ë¬¸ì œ í•´ê²° =====
                // Step 1ìœ¼ë¡œ ëŒì•„ì˜¬ ë•Œ ë™ì˜ìƒì˜ ê²½ìš° IndexedDBì—ì„œ File ê°ì²´ë¥¼ ë‹¤ì‹œ ì½ì–´ì™€ì„œ Blob URL ì¬ë°œê¸‰
                let finalPreviewUrl = previewUrl;
                let finalFile = file;
                
                // ë™ì˜ìƒì¸ ê²½ìš° ì¶”ê°€ ê²€ì¦ ë° ë³µêµ¬
                if (item.mediaType === 'video' || item.type === 'video' || file.type.startsWith('video/')) {
                  try {
                    // ê¸°ì¡´ previewUrlì´ ìœ íš¨í•œì§€ í™•ì¸
                    const response = await fetch(previewUrl, { method: 'HEAD' });
                    if (!response.ok) {
                      throw new Error('Blob URL ìœ íš¨í•˜ì§€ ì•ŠìŒ');
                    }
                  } catch (e) {
                    console.warn(`[VIDEO RECOVER] Blob URL ìœ íš¨í•˜ì§€ ì•ŠìŒ, ì¬ìƒì„±: ${item.id}`, e);
                    // ê¸°ì¡´ URL í•´ì œ
                    if (previewUrl && previewUrl.startsWith('blob:')) {
                      URL.revokeObjectURL(previewUrl);
                    }
                    // ìƒˆë¡œìš´ Blob URL ìƒì„±
                    finalPreviewUrl = URL.createObjectURL(file);
                    console.log(`[VIDEO RECOVER] Blob URL ì¬ìƒì„± ì„±ê³µ: ${item.id}`);
                  }
                }
                
                mediaItems.push({
                  id: item.id,
                  file: finalFile,
                  previewUrl: finalPreviewUrl,
                  type: item.type,
                  mediaType: item.mediaType || (item.type === 'video' || finalFile.type.startsWith('video/') ? 'video' : 'image')
                });
                
                renderThumbnail({
                  id: item.id,
                  file: finalFile,
                  previewUrl: finalPreviewUrl,
                  type: item.type
                });
                
                console.log(`[DEBUG] ë¯¸ë””ì–´ ${item.id} ë³µì› ì™„ë£Œ`);
              }
              resolve();
            };
            getRequest.onerror = () => resolve();
          });
        });
        
        Promise.all(restorePromises).then(() => {
          // mediaIdCounter ì—…ë°ì´íŠ¸ (ë³µì›ëœ í•­ëª© ìˆ˜ë§Œí¼)
          if (mediaItems.length > 0) {
            const maxId = Math.max(...mediaItems.map(item => {
              const match = item.id.match(/media_(\d+)_/);
              return match ? parseInt(match[1]) : 0;
            }));
            mediaIdCounter = maxId;
          }
          
          // ëœë”© URL ë³µì›
          if (data.landingUrl && landingUrlInput) {
            landingUrlInput.value = data.landingUrl;
          }
          
          hasUnsavedChanges = false; // ë³µì›ëœ ë°ì´í„°ëŠ” ì €ì¥ëœ ê²ƒìœ¼ë¡œ ê°„ì£¼
          updateNextButtonState();
          console.log(`[DEBUG] ${mediaItems.length}ê°œ ë¯¸ë””ì–´ ë³µì› ì™„ë£Œ`);
        });
      };
    }
  } catch (e) {
    console.error('[ERROR] Step 1 ë°ì´í„° ë³µì› ì‹¤íŒ¨:', e);
  }
}

// âœ… í˜ì´ì§€ ì´íƒˆ ê²½ê³  ë° URL ì •ë¦¬
window.addEventListener('beforeunload', (e) => {
  // Step 2ë¡œ ì´ë™ ì¤‘ì´ë©´ Blob URLì„ revokeí•˜ì§€ ì•ŠìŒ
  if (isNavigatingToNextStep) {
    console.log('[DEBUG] Step 2ë¡œ ì´ë™ ì¤‘ - Blob URL ìœ ì§€');
    return;
  }
  
  if (hasUnsavedChanges) {
    e.preventDefault();
    e.returnValue = 'ì‘ì„± ì¤‘ì¸ ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤';
    return e.returnValue;
  }
  
  // ì™„ì „íˆ í˜ì´ì§€ë¥¼ ë– ë‚  ë•Œë§Œ URL ì •ë¦¬ (ê´‘ê³  ì œì‘ ì™„ë£Œ ë˜ëŠ” ì·¨ì†Œ)
  // í•˜ì§€ë§Œ ì·¨ì†Œ ë²„íŠ¼ì„ í†µí•´ ëª…ì‹œì ìœ¼ë¡œ ì´íƒˆí•˜ëŠ” ê²½ìš°ëŠ” ì œì™¸
  const isCancelling = sessionStorage.getItem('admake_cancelling');
  if (isCancelling === 'true') {
    sessionStorage.removeItem('admake_cancelling');
    mediaItems.forEach(item => {
      try {
        URL.revokeObjectURL(item.previewUrl);
      } catch (err) {
        console.warn('URL revoke ì‹¤íŒ¨:', err);
      }
    });
  }
});

// âœ… ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', () => {
  console.log('[DEBUG] DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ');
  
  // DOM ìš”ì†Œ ì´ˆê¸°í™”
  if (!initDOMElements()) {
    console.error('[ERROR] DOM ìš”ì†Œ ì´ˆê¸°í™” ì‹¤íŒ¨');
    alert('í˜ì´ì§€ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  console.log('[DEBUG] DOM ìš”ì†Œ ì´ˆê¸°í™” ì™„ë£Œ');
  
  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
  setupEventListeners();
  
  console.log('[DEBUG] ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
  
  // Step 1 ë°ì´í„° ë³µì› (Step 2ì—ì„œ ëŒì•„ì˜¨ ê²½ìš°)
  restoreStep1Data();
  
  // ì´ˆê¸° ë²„íŠ¼ ìƒíƒœ ì„¤ì •
  updateNextButtonState();
});
</script>

</body>
</html>
