<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê´‘ê³  ë§Œë“¤ê¸° - ADMAKE</title>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/favicon.ico') }}">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=1.4">
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #f9fafb;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      min-height: 100vh;
    }

    /* âœ… Progress Bar ìŠ¤íƒ€ì¼ */
    .admake-progress-bar {
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      padding: 24px 40px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
    }

    .admake-progress-steps {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .admake-progress-step {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
      letter-spacing: 0.05em;
    }

    .admake-progress-step.active {
      color: #111827;
    }

    .admake-progress-step.completed {
      color: #059669;
    }

    .admake-progress-connector {
      width: 40px;
      height: 2px;
      background: #e5e7eb;
      margin: 0 8px;
    }

    .admake-progress-connector.completed {
      background: #059669;
    }

    /* âœ… ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ */
    .admake-create-wrapper {
      max-width: 1400px;
      margin: 0 auto;
      padding: 40px;
    }

    .admake-create-layout {
      display: flex;
      gap: 32px;
      margin-top: 32px;
    }

    .admake-create-left {
      flex: 6;
      min-width: 0;
    }

    .admake-create-right {
      flex: 4;
      min-width: 0;
    }

    /* âœ… ì—…ë¡œë“œ ì˜ì—­ ìŠ¤íƒ€ì¼ */
    .admake-upload-area {
      background: #ffffff;
      border: 2px dashed #d1d5db;
      border-radius: 1rem;
      padding: 64px 32px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 8px 8px 0px 0px rgba(0, 0, 0, 0.03);
    }

    .admake-upload-area:hover {
      border-color: #111827;
      background: #f9fafb;
      box-shadow: 12px 12px 0px 0px rgba(0, 0, 0, 0.05);
    }

    .admake-upload-area.dragover {
      border-color: #111827;
      background: #f3f4f6;
      box-shadow: 12px 12px 0px 0px rgba(0, 0, 0, 0.05);
    }

    .admake-upload-icon {
      font-size: 48px;
      margin-bottom: 16px;
      color: #9ca3af;
    }

    .admake-upload-text {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }

    .admake-upload-hint {
      font-size: 14px;
      color: #6b7280;
      margin-top: 8px;
    }

    .admake-file-input {
      display: none;
    }

    /* âœ… ì¸ë„¤ì¼ ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼ */
    .admake-thumbnails-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-top: 32px;
    }

    .admake-thumbnail-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 0.75rem;
      overflow: hidden;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      box-shadow: 4px 4px 0px 0px rgba(0, 0, 0, 0.03);
    }

    .admake-thumbnail-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .admake-thumbnail-delete {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      background: rgba(0, 0, 0, 0.7);
      color: #ffffff;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 700;
      transition: all 0.2s ease;
      box-shadow: 2px 2px 0px 0px rgba(0, 0, 0, 0.2);
    }

    .admake-thumbnail-delete:hover {
      background: rgba(220, 38, 38, 0.9);
      transform: scale(1.1);
    }

    /* âœ… ëœë”© ì„¤ì • ì˜ì—­ ìŠ¤íƒ€ì¼ */
    .admake-settings-card {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 1rem;
      padding: 32px;
      box-shadow: 8px 8px 0px 0px rgba(0, 0, 0, 0.03);
    }

    .admake-settings-label {
      font-size: 14px;
      font-weight: 700;
      color: #111827;
      letter-spacing: 0.1em;
      margin-bottom: 12px;
      display: block;
    }

    .admake-settings-input {
      width: 100%;
      padding: 14px 16px;
      font-size: 14px;
      font-family: 'Inter', sans-serif;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      background: #ffffff;
      color: #111827;
      transition: all 0.2s ease;
      box-shadow: 2px 2px 0px 0px rgba(0, 0, 0, 0.02);
      letter-spacing: 0.02em;
    }

    .admake-settings-input:focus {
      outline: none;
      border-color: #111827;
      box-shadow: 4px 4px 0px 0px rgba(0, 0, 0, 0.05);
    }

    /* âœ… í•˜ë‹¨ ë²„íŠ¼ ì˜ì—­ */
    .admake-action-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #ffffff;
      border-top: 1px solid #e5e7eb;
      padding: 20px 40px;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
    }

    .admake-action-buttons {
      display: flex;
      gap: 16px;
      margin-left: auto;
    }

    .admake-btn {
      padding: 14px 32px;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 0.1em;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      box-shadow: 4px 4px 0px 0px rgba(0, 0, 0, 0.1);
    }

    .admake-btn-secondary {
      background: #f3f4f6;
      color: #6b7280;
    }

    .admake-btn-secondary:hover {
      background: #e5e7eb;
      transform: translateY(-2px);
      box-shadow: 6px 6px 0px 0px rgba(0, 0, 0, 0.12);
    }

    .admake-btn-primary {
      background: #111827;
      color: #ffffff;
    }

    .admake-btn-primary:hover:not(:disabled) {
      background: #1f2937;
      transform: translateY(-2px);
      box-shadow: 6px 6px 0px 0px rgba(0, 0, 0, 0.15);
    }

    .admake-btn-primary:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
    }

    .admake-btn-primary:active:not(:disabled) {
      transform: translateY(2px);
      box-shadow: 2px 2px 0px 0px rgba(0, 0, 0, 0.1);
    }

    /* âœ… ë©”ì¸ ì»¨í…ì¸  í•˜ë‹¨ ì—¬ë°± (ë²„íŠ¼ ì˜ì—­ ê³ ë ¤) */
    .admake-create-wrapper {
      padding-bottom: 100px;
    }

    /* âœ… ëª¨ë°”ì¼ ë°˜ì‘í˜• */
    @media (max-width: 1024px) {
      .admake-create-layout {
        flex-direction: column;
      }

      .admake-thumbnails-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .admake-create-wrapper {
        padding: 20px;
      }

      .admake-progress-bar {
        padding: 16px 20px;
      }

      .admake-progress-steps {
        flex-wrap: wrap;
        gap: 8px;
      }

      .admake-progress-connector {
        display: none;
      }

      .admake-thumbnails-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .admake-action-bar {
        padding: 16px 20px;
        flex-direction: column;
        gap: 12px;
      }

      .admake-action-buttons {
        width: 100%;
        margin-left: 0;
      }

      .admake-btn {
        flex: 1;
        padding: 12px 24px;
      }
    }
  </style>
</head>
<body>

<script>
  var userCompanyList = {{ session['company_names'] | tojson }};
  var currentUserId = "{{ session['user_id'] }}";
  var accountId = "{{ account_id }}";
</script>
<script src="{{ url_for('static', filename='js/mobile_detection.js') }}"></script>

<!-- âœ… í–„ë²„ê±° ë©”ë‰´ -->
<div class="nav-buttons">
  <div class="nav-left">
    <div id="updatedAtText" class="updated-at-text">ê´‘ê³  ë§Œë“¤ê¸°</div>
  </div>
  <div class="nav-right">
    <div class="hamburger-menu-wrapper">
      <div class="hamburger-icon" id="hamburgerIcon">
        <div></div><div></div><div></div>
      </div>
      <div class="hamburger-dropdown" id="hamburgerDropdown">
        <a href="/" class="{% if request.path == '/' %}active{% endif %}">ì‚¬ì´íŠ¸ ì„±ê³¼</a>
        <a href="{{ url_for('ads_page') }}" class="{% if request.path == '/ads' %}active{% endif %}">ê´‘ê³  ì„±ê³¼</a>
        <a href="{{ url_for('trend_selection_page') }}" class="{% if request.path.startswith('/trend') %}active{% endif %}">TREND</a>
        <a href="{{ url_for('auth.logout') }}">ë¡œê·¸ì•„ì›ƒ</a>
      </div>
    </div>
  </div>
</div>

<!-- âœ… Progress Bar -->
<div class="admake-progress-bar">
  <div class="admake-progress-steps">
    <div class="admake-progress-step active">STEP 1</div>
    <div class="admake-progress-connector"></div>
    <div class="admake-progress-step">STEP 2</div>
    <div class="admake-progress-connector"></div>
    <div class="admake-progress-step">STEP 3</div>
    <div class="admake-progress-connector"></div>
    <div class="admake-progress-step">STEP 4</div>
    <div class="admake-progress-connector"></div>
    <div class="admake-progress-step">STEP 5</div>
  </div>
</div>

<!-- âœ… ë©”ì¸ ì»¨í…ì¸  -->
<div class="admake-create-wrapper">
  <div class="admake-create-layout">
    <!-- ì¢Œì¸¡: ë¯¸ë””ì–´ ì—…ë¡œë“œ ì˜ì—­ -->
    <div class="admake-create-left">
      <div class="admake-upload-area" id="uploadArea">
        <div class="admake-upload-icon">ğŸ“</div>
        <div class="admake-upload-text">ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸ ì•¤ ë“œë¡­í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</div>
        <div class="admake-upload-hint">ìµœëŒ€ 10ê°œê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥</div>
        <input type="file" id="fileInput" class="admake-file-input" multiple accept="image/*">
      </div>

      <!-- ì¸ë„¤ì¼ ê·¸ë¦¬ë“œ -->
      <div class="admake-thumbnails-grid" id="thumbnailsGrid"></div>
    </div>

    <!-- ìš°ì¸¡: ëœë”© ì„¤ì • ì˜ì—­ -->
    <div class="admake-create-right">
      <div class="admake-settings-card">
        <label class="admake-settings-label" for="landingUrl">ìƒì„¸í˜ì´ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”</label>
        <input 
          type="url" 
          id="landingUrl" 
          class="admake-settings-input" 
          placeholder="https://example.com/product?utm_source=..."
          autocomplete="off"
        >
      </div>
    </div>
  </div>
</div>

<!-- âœ… í•˜ë‹¨ ì•¡ì…˜ ë°” -->
<div class="admake-action-bar">
  <div></div>
  <div class="admake-action-buttons">
    <button class="admake-btn admake-btn-secondary" id="cancelBtn">ì·¨ì†Œ</button>
    <button class="admake-btn admake-btn-primary" id="nextBtn" disabled>ë‹¤ìŒ: í¬ë¡­ ë° ê°€ì´ë“œ</button>
  </div>
</div>

<script src="{{ url_for('static', filename='js/common.js') }}"></script>
<script src="{{ url_for('static', filename='js/common_ui.js') }}"></script>

<script>
// âœ… ìƒíƒœ ê´€ë¦¬
let uploadedFiles = [];
let fileUrls = [];
let hasUnsavedChanges = false;

// âœ… íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const thumbnailsGrid = document.getElementById('thumbnailsGrid');
const landingUrlInput = document.getElementById('landingUrl');
const nextBtn = document.getElementById('nextBtn');
const cancelBtn = document.getElementById('cancelBtn');

// ì—…ë¡œë“œ ì˜ì—­ í´ë¦­
uploadArea.addEventListener('click', () => {
  fileInput.click();
});

// íŒŒì¼ ì„ íƒ
fileInput.addEventListener('change', (e) => {
  handleFiles(Array.from(e.target.files));
});

// ë“œë˜ê·¸ ì•¤ ë“œë¡­
uploadArea.addEventListener('dragover', (e) => {
  e.preventDefault();
  uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
  uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
  e.preventDefault();
  uploadArea.classList.remove('dragover');
  const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
  handleFiles(files);
});

// íŒŒì¼ ì²˜ë¦¬ í•¨ìˆ˜
function handleFiles(files) {
  const remainingSlots = 10 - uploadedFiles.length;
  const filesToAdd = files.slice(0, remainingSlots);
  
  if (files.length > remainingSlots) {
    alert(`ìµœëŒ€ 10ê°œê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤. ${remainingSlots}ê°œë§Œ ì¶”ê°€ë©ë‹ˆë‹¤.`);
  }

  filesToAdd.forEach(file => {
    if (uploadedFiles.length >= 10) return;
    
    const url = URL.createObjectURL(file);
    uploadedFiles.push(file);
    fileUrls.push(url);
    hasUnsavedChanges = true;
    
    renderThumbnail(url, uploadedFiles.length - 1);
  });
  
  updateNextButtonState();
}

// ì¸ë„¤ì¼ ë Œë”ë§
function renderThumbnail(url, index) {
  const thumbnailItem = document.createElement('div');
  thumbnailItem.className = 'admake-thumbnail-item';
  thumbnailItem.innerHTML = `
    <img src="${url}" class="admake-thumbnail-image" alt="ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ${index + 1}">
    <button class="admake-thumbnail-delete" data-index="${index}">Ã—</button>
  `;
  
  thumbnailsGrid.appendChild(thumbnailItem);
  
  // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
  const deleteBtn = thumbnailItem.querySelector('.admake-thumbnail-delete');
  deleteBtn.addEventListener('click', () => {
    deleteThumbnail(index);
  });
}

// ì¸ë„¤ì¼ ì‚­ì œ
function deleteThumbnail(index) {
  // URL í•´ì œ
  URL.revokeObjectURL(fileUrls[index]);
  
  // ë°°ì—´ì—ì„œ ì œê±°
  uploadedFiles.splice(index, 1);
  fileUrls.splice(index, 1);
  
  hasUnsavedChanges = true;
  
  // ê·¸ë¦¬ë“œ ì¬ë Œë”ë§
  thumbnailsGrid.innerHTML = '';
  fileUrls.forEach((url, idx) => {
    renderThumbnail(url, idx);
  });
  
  updateNextButtonState();
}

// ë‹¤ìŒ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateNextButtonState() {
  const hasFiles = uploadedFiles.length > 0;
  const hasUrl = landingUrlInput.value.trim().length > 0;
  
  nextBtn.disabled = !(hasFiles && hasUrl);
}

// URL ì…ë ¥ ê°ì§€
landingUrlInput.addEventListener('input', () => {
  hasUnsavedChanges = true;
  updateNextButtonState();
});

// âœ… í˜ì´ì§€ ì´íƒˆ ê²½ê³ 
window.addEventListener('beforeunload', (e) => {
  if (hasUnsavedChanges) {
    e.preventDefault();
    e.returnValue = 'ì‘ì„± ì¤‘ì¸ ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤';
    return e.returnValue;
  }
});

// âœ… ë‹¤ìŒ ë²„íŠ¼ í´ë¦­
nextBtn.addEventListener('click', () => {
  if (nextBtn.disabled) return;
  
  // ìƒíƒœë¥¼ sessionStorageì— ì €ì¥ (ë‹¤ìŒ Stepì—ì„œ ì‚¬ìš©)
  const state = {
    accountId: accountId,
    files: uploadedFiles.map((file, index) => ({
      name: file.name,
      size: file.size,
      type: file.type,
      url: fileUrls[index]
    })),
    landingUrl: landingUrlInput.value.trim()
  };
  
  // File ê°ì²´ëŠ” ì§ë ¬í™”í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, URLë§Œ ì €ì¥
  sessionStorage.setItem('admake_step1_state', JSON.stringify({
    accountId: accountId,
    fileUrls: fileUrls,
    fileNames: uploadedFiles.map(f => f.name),
    fileSizes: uploadedFiles.map(f => f.size),
    fileTypes: uploadedFiles.map(f => f.type),
    landingUrl: landingUrlInput.value.trim()
  }));
  
  // File ê°ì²´ëŠ” ë³„ë„ë¡œ ì €ì¥ (Blob URL ìœ ì§€)
  sessionStorage.setItem('admake_step1_files', JSON.stringify(
    uploadedFiles.map((file, index) => ({
      name: file.name,
      size: file.size,
      type: file.type,
      url: fileUrls[index]
    }))
  ));
  
  hasUnsavedChanges = false;
  
  // ë‹¤ìŒ Stepìœ¼ë¡œ ì´ë™ (í˜„ì¬ëŠ” ì„ì‹œë¡œ alert)
  alert('Step 2ë¡œ ì´ë™í•©ë‹ˆë‹¤. (êµ¬í˜„ ì˜ˆì •)');
  // window.location.href = `/admake/crop?account_id=${encodeURIComponent(accountId)}`;
});

// âœ… ì·¨ì†Œ ë²„íŠ¼ í´ë¦­
cancelBtn.addEventListener('click', () => {
  if (hasUnsavedChanges) {
    if (confirm('ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ì‚­ì œë©ë‹ˆë‹¤. ì •ë§ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      // íŒŒì¼ URL í•´ì œ
      fileUrls.forEach(url => URL.revokeObjectURL(url));
      window.location.href = `/admake?account_id=${encodeURIComponent(accountId)}`;
    }
  } else {
    window.location.href = `/admake?account_id=${encodeURIComponent(accountId)}`;
  }
});
</script>

</body>
</html>
